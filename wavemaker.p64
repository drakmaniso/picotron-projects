picotron cartridge // www.picotron.net
version 2

:: gfx/
:: map/
:: pal/
:: sfx/
:: src/
:: src/wavetables/
:: main.lua
--[[pod_format="raw",created="2024-03-24 00:48:06",modified="2026-01-27 08:27:46",revision=14275]]
include "src/lune.lua"
--include "src/misc.lua"
include "src/waves.lua"
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local file = require "src/file.lua"
local settings = require "src/settings.lua"
local ui = require "src/ui.lua"
local ui_routing = require "src/ui_routing.lua"
local ui_settings = require "src/ui_settings.lua"
local ui_synth = require "src/ui_synth.lua"
local ui_tracker = require "src/ui_tracker.lua"


function _init()
	window {
		tabbed = true,
--		icon = --[[pod_type="gfx"]]unpod("b64:bHo0AB4AAAAcAAAA8A1weHUAQyAICATAF0AHEBcgBxAXEAcgFxAHQBfA")
		icon = --[[pod_type="gfx"]]unpod("b64:bHo0AB4AAAAcAAAA8A1weHUAQyAICAQwB2AXUAcAB0AHAAcgJzA3QBew")
	}

	wrangle_working_file(
		file.save,
		file.load,
		file.default_filename
	)
		
	on_event("drop_items", file.handle_drop_items)
	on_event("resize", function(msg) app.refresh_gui = true end)

	menuitem {
		id = "export",
		label = "\^:0000000000000000 Export Instruments",
		action =
			function()
				ui.chooser (
					{
						path = "/ram/cart/sfx/",
						intention = "select_file",
						title = "Export Instruments",
						prompt = "Export into:",
						verb = "Export",
						workspace = "current",
					},
					function(msg)
						file.export_into(msg.filename)
					end
				)
			end,
	}	
	menuitem { divider = true, id = "settings_divider", label = "" }
	menuitem {
		id = "settings",
		label = "\^:0000000000000000 Settings",
		action = function() ui_settings.open() end,
	}	
		
	settings.load()
	
	poke(0x4000, get(fetch("/system/fonts/p8.font")))
	
	poke4(0x5000, get(fetch("pal/0.pal")))
	
	--app.node = nil
	music(-1)
end


function _update()
	if keyp(settings.keys.play) then
		app.play_or_pause()
	end
	if app.refresh_gui then
		generate_gui()
		app.refresh_gui = false
	end
	ui.head():update_all()
end


function _draw()
	ui.head():draw_all()
	--print(string.format("\014% 3.0f", stat(0) / (1024 * 1024)) .. "MB", 459, 246, 57)
	--print(string.format("%3.0f", flr(0.5 + stat(1) * 100.0)) .. "%", 463, 252, 57)
end


function generate_gui()
	ui.create_head()
	local width <const> = get_display():width()
	local height <const> = get_display():height()
	if app.view == "tracker" then
		ui_tracker.attach(ui.head(), { x = 0, y = 0, width = width, height = height })
	elseif app.view == "synth" then
		ui_synth.attach(ui.head(), { x = 0, y = 0, width = width, height = height })
	end
end


----------------------------------------------------------------------------------------------------
-- View Selector
----------------------------------------------------------------------------------------------------


function attach_view_selector(parent, el)
	el.width = 16
	el.height = 34
	el.cursor = "pointer"
	parent:attach(el)
	
	function el:draw(msg)
		local clicked = msg.mb == 1
		if clicked and false then
			rrectfill(0, 0, self.width, self.height, 0, 58)
		end
		pal(7, app.view == "tracker" and 59 or 58)
		pal(57, app.view == "tracker" and 7 or 57)
		spr(1, 0, 0)
		pal(7, app.view == "synth" and 59 or 58)
		pal(57, app.view == "synth" and 7 or 57)
		spr(3, 0, 18)
		pal(7, 7)
		pal(57, 57)
	end
	
	function el:click(msg)
		if app.view == "synth" then
			app.view = "tracker"
		else
			app.view = "synth"
		end
		app.refresh_gui = true
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Octave Selector
----------------------------------------------------------------------------------------------------


function attach_octave_selector(parent, el)
	el.width = 18
	el.height = 10
	el.cursor = get_spr(50)
	parent:attach(el)
	
	el.drag_start = nil

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 14)
		-- Base Note
		local note = app.base_note % 12
		local octave = app.base_note \ 12
		local is_sharp = (note == 1) or (note == 3) or (note == 6)
			or (note == 8) or (note == 10)
		local ox_note <const> = is_sharp and 0 or 4
		local fg <const> = 5
		pal(7, self.dragged and 7 or fg)
		spr(8 + note, ox_note, 2)
		local x_oct = ox_note + (is_sharp and 12 or 6)
		pal(7, 7)
		print(
			"\014" .. string.format("%1x", octave),
			x_oct, 2 + 1,
			self.dragged and 7 or fg
		)
	end	
	
	function el:click(msg)
		self.dragged = true
		self.cursor = 0
	end
	
	function el:drag(msg)
		local delta = ui.mouselock(0.125)
		app.base_note = mid(0, app.base_note - (12 * delta), 120)
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		self.dragged = nil
	end

	function el:doubleclick(msg)
		app.base_note = 48
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Instrument Selector
----------------------------------------------------------------------------------------------------


function attach_instrument_selector(parent, el)
	el.width = 18
	el.height = 16
	el.cursor = get_spr(50)
	parent:attach(el)
	
	el.drag_start = nil

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 57)
		local fg = self.dragged and 7 or 44
		print("inst", 1, 1, 58)
		print(
			string.format("%02x", app.base_instrument),
			5, 9,
			fg
		)
	end	
	
	function el:click(msg)
		-- TODO: replace with pull-down menus
		self.dragged = true
		self.cursor = 0
	end
	
	function el:drag(msg)
		if self.dragged then
			local delta = ui.mouselock(0.125)
			app.base_instrument = mid(0, app.base_instrument - delta, 0xfe)
			-- TODO: temporary, remove
			app.instrument = app.base_instrument
			app.node = 0
			ui_routing.clear_placement_buttons()
		end
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		if self.dragged and app.view == "synth" then
			app.refresh_gui = true
		end
		self.dragged = nil
	end

	function el:doubleclick(msg)
		app.base_instrument = 01
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Volume Selector
----------------------------------------------------------------------------------------------------


function attach_volume_selector(parent, el)
	el.width = 18
	el.height = 25
	el.cursor = get_spr(50)
	parent:attach(el)
	
	el.drag_start = nil

	local oy_note <const> = 27

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 14)
		-- Volume Bar
		local x_vol = 6
		local y_vol = 7
		local w_vol = 5
		local h_vol = 17
		local vol = app.base_volume // 4
		rectfill(x_vol, y_vol, x_vol + w_vol - 1, y_vol + h_vol - 1, 58)
		rectfill(
			x_vol, y_vol + h_vol - 1 - vol,
			x_vol + w_vol - 1, y_vol + h_vol - 1,
			self.dragged and 7 or 17
		)
		if self.dragged then
			print("\014" .. string.format("%2d", app.base_volume),
				x_vol - 1, 0, 58)
		else
			print("\014vol", x_vol - 3, 0, 58)
		end
	end	
	
	function el:click(msg)
		self.dragged = true
		self.cursor = 0
	end
	
	function el:drag(msg)
--		if self.dragged then
			local delta = ui.mouselock(0.125)
			app.base_volume = mid(0, app.base_volume - delta, 0x40) -- TODO: handle vol > 64
--		end
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		self.dragged = nil
	end

	function el:doubleclick(msg)
		app.base_volume = 0x32
	end
	
	return el
end

:: manual.txt
--[[pod_format="raw",created="2024-04-14 09:49:39",modified="2026-01-27 08:27:46",revision=4002]]

:: src/app.lua
--[[pod_format="raw",created="2024-04-12 08:11:00",modified="2026-01-27 08:27:46",revision=11080]]
local sfx = require "src/sfx.lua"

local app = {}

-- Global state

app.pattern = 0 -- opened in pattern editor
app.track = 0 -- opened in track editor
app.instrument = 0 -- opened in instrument editor

app.node = nil -- selected in instrument editor
app.wt = 0 -- selected in instrument editor

app.base_note = 48
app.base_volume = 0x32
app.base_instrument = 00

-- UI state --------------------------------------------------------------------

app.refresh_gui = true

app.view = "tracker" -- "tracker" or "synth"
app.detail = false
app.track_header = true
app.height_row = 8
app.env_advanced = { [0] = false, false, false, false }

-- Colors -----------------------------------------------------------------

app.editor_bg = 62

-- Layout constants ----------------------------------------------------------

app.width_column = 57 -- 57

app.ruler_height = 9
app.channels_width = 16
app.detail_width = 56
app.cell_width = 20
app.cell_height = 29

app.synth_width = 83
app.synth_height = 72
app.synth_gap = 5
app.mod_width = 57
app.mod_height = app.synth_height


function app.play_or_pause()
	-- TODO: channel mask?
	if sfx.are_channels_playing(0xff) then
		music(-1)
	else
		music(0)
	end
end

return app
:: src/file.lua
--[[pod_format="raw",created="2024-04-07 08:14:09",modified="2026-01-27 08:27:46",revision=5459]]
local app = require "src/app.lua"


local file = {}


file.default_filename = "/ram/cart/sfx/0.sfxi"


-- `file.save` and `file.load` are direct copies of `sfx.p64` code to
-- ensure perfect compatibility.


function file.save()
	local ud = userdata("u8", 0x40000)
	for i=0,0x3f do
		set(ud, i * 0x1000, peek(0x30000 + i * 0x1000, 0x1000))
	end
	return ud
end


function file.load(ud)
	if (type(ud)~="userdata") then
		init_data()
	else
		for i=0,0x3f do
			poke(0x30000 + i * 0x1000, get(ud, i * 0x1000, 0x1000))
		end
	end
	-- TODO
	app.instrument = 0
	app.node = 0
	app.refresh_gui = true
---			init_undo()
end


function file.export_into(filename)
	local target = fetch(filename)
	if type(target) ~= "userdata" then
		notify("unable to read file " .. pod(filename))
		return
	end
	
	-- TODO: only copy existing instruments
	target:peek(0x040000, 0x010000, 0xffff)
	-- TODO: where to put the wavetables?
	-- target:peek(0xf00000, 0xed0000, 0xfffff)
	
	store(filename, target)
	notify("all instruments exported into " .. pod(filename))
end


function file.handle_drop_items(msg)
	for i = 1, #msg.items do
		local item = msg.items[i]
		if item.pod_type == "file_reference" and item.attrib == "file" then
			local ext = item.fullpath:ext()
			if ext == "sfx" then
				local metadata = fetch_metadata(item.fullpath) or {} -- TODO
				send_message(pid(), {event = "open_file", filename = item.fullpath})
			else
				notify("wrong file extension")
				-- TODO: dialog for unknown file extensions?
				--current_filename = item.fullpath
				--send_message(pid(), {event = "open_file", filename = item.fullpath})
			end
		end
	end
end


-- Initialisation ----------------------------------------------------------------


-- copied from "/system/apps/sfx.lua" in Picotron 0.0.1e
function init_data()

	-- use 256k from 0x30000
	-- gives 399 SFX and managemable size for undo state comparisons
	-- if change this need, to adjust undo stack size and loader/saver
	
	memset(0x30000, 0, 0x40000)
	

	-- index (0x30000)
	
	-- first 3 values are almost metadata only -- not currently
	-- acted on anywhere. perhaps useful in future for deciding
	-- scope of copy/paste, and gui cues, but can be calculated
	-- from content.
	
	poke2(0x30000,
		64,  -- num_instruments
		512, -- num_tracks (64 patterns * 8 channels for default indexing)
		64,  -- num_patterns
		-- flags: 0x1 use default track indexing (base+0x20000, increments of 328 bytes)
		0x1
	)
	poke4(0x30010,
		0x10000, -- insts_addr      (I32)    relative address of instruments
		0x20000, -- tracks_addr     (I32)    relative address of track index
		0,       -- patterns_addr   (I32)    relative address of pattern data
		0        -- unused          (I32)    should be 0
	)
	poke2(0x30020,
		0,  -- tick len (0 for default -- custom vals not supported yet)
		64, -- default track length
		16 -- default track spd
	)
	
	-- default track speed (+3 unused)
	poke(0x30026, 16, 0, 0, 0) 
	
	-- pattern data: first 16 patterns
	-- want to keep default sfx file quite tiny
	-- .. should be ok to save a whole .sfx for just one inst / experiment
	-- later: interface to generate more default patterns
	
	for pp = 0,3
	do
		local addr = 0x30100 + pp * 20
		for i = 0, 3 do
			poke(addr+i, pp*4 + i)
		end
		poke(addr+8, 0x0)  -- flow flags
		poke(addr+9, 0x0f) -- channel mask -- 4 channels
		poke(addr+10, 0,0) -- length (I16)
		
	end
	
	
	----------------------------------------------------------------------------
	-- single instrument at 0x40000 (instrument 0)
	
	clear_instrument(0)
	
	-- copy default instrument to 1..31
	for i=1,31 do
		memcpy(0x40000 + 0x200*i, 0x40000, 0x200)
	end
	
	--------------------------------------------------
	-- Track Data  0x50000
	--------------------------------------------------
	
	-- Default track size is 5 * 64 rows + 8 = 328 bytes
	
	-- header (8)
	init_track(0x50000)
	
	-- copy to other tracks: 128k worth
	-- ** only first 399 are saved / undoable (0x20000\328) **
	-- 384 used in tracker
	for i=1,398 do
		memcpy(0x50000 + i*328, 0x50000, 328)
	end
end


function init_track(addr)
--	printh("init_track "..addr)
	poke2(addr, 64) -- len
	poke(addr+2,16) -- spd
	poke(addr+3,0)  -- loop0
	poke(addr+4,0)  -- loop1
	poke(addr+5,0)  -- delay
	poke(addr+6,0)  -- flags (0x1 mute)
	poke(addr+7,0)  -- unused
	
	-- pitch, inst, vol: not set (0xff)
	memset(addr+8, 0xff, 64*3)
	
	-- fx, fx_p: clear
	memset(addr+8+64*3, 0x0, 64*2)
end


function clear_pattern(i)
	local addr = 0x30100 + i*20
	memset(addr,0,20)
end


function clear_instrument(i)
	local addr = 0x40000 + i * 0x200
	
	memset(addr, 0, 0x200)
	
	-- node 0: root
	poke(addr + (0 * 32), -- node 0
	
			0,    -- parent (0x7)  op (0xf0)
			1,    -- kind (0x0f): 1 root  kind_p (0xf0): 0  -- wavetable_index
			0,    -- flags
			0,    -- unused extra
				
			-- MVALs:  kind/flags,  val0, val1, envelope_index
			
			0x2|0x4,0x20,0,0,  -- volume: mult. 0x40 is max (-0x40 to invert, 0x7f to overamp)
			0x1,0,0,0,     -- pan:   add. center
			0x1,0,0,0,     -- tune: +0 -- 0,48,0,0 absolute for middle c (c4) 261.6 Hz
			0x1,0,0,0,     -- bend: none
			-- following shouldn't be in root
			0x0,0,0,0,     -- wave: use wave 0 
			0x0,0,0,0      -- phase 
	)
	
	
	-- node 1: sine
	poke(addr + (1 * 32), -- instrument 0, node 1
	
			0,    -- parent (0x7)  op (0xf0)
			2,    -- kind (0x0f): 2 osc  kind_p (0xf0): 0  -- wavetable_index
			0,    -- flags
			0,    -- unused extra
				
			-- MVALs:  kind/flags,  val0, val1, envelope_index
			
			0x2,0x20,0,0,  -- volume: mult. 0x40 is max (-0x40 to invert, 0x7f to overamp)
			0x1,0,0,0,     -- pan:   add. center
			0x21,0,0,0,    -- tune: +0 -- 0,48,0,0 absolute for middle c (c4) 261.6 Hz
			               -- tune is quantized to semitones with 0x20
			0x1,0,0,0,     -- bend: none
			0x0,0x40,0,0,  -- wave: triangle
			0x0,0,0,0      -- phase 
	)
	
	
	-- wavetables
	poke(addr + 0x1e0,
		0x00, -- address (low)  in 256 byte increments
		0xf8, -- address (high) in 64k increments
		0x0a, -- samples (1 << n) 1024
		0xff,  -- wt_height 256(0); wave mval points at one of the entries
		
		-- white noise
		0x80,
		0xf7,
		0x0d, -- samples (1 << n) 8192
		0x01
	)

	-- envelope 0 inst 1
	
	poke(addr + 0x100,
		0,0,0,0, 0,0,0,0,
		0,40,255,0 -- adsr
	)
end


return file
:: src/lune.lua
--[[pod_format="raw",created="2025-03-19 09:08:58",modified="2026-01-27 08:27:46",revision=5811]]
----------------------------------------------------------------------------------------------------
-- Logging and Errors
----------------------------------------------------------------------------------------------------


if env().argv[0] == "/system/apps/terminal.lua" then
	function log(str)
		local path = debug.getinfo(2).source
		if path[1] == "@" then path = path:sub(2, -1) end
		local line = debug.getinfo(2).currentline
		printh(path .. ":" .. line .. ": " .. (str or ""))
	end
else
	function log(_str) end
end


function error(msg, level, title)
	level = (level or 1) + 1
	local path = debug.getinfo(level).source
	local line = debug.getinfo(level).currentline
	local str = sub(path, 2) .. ":" .. string.format("%d", line) .. ": " .. msg
	send_message(3, { event = "report_error", content = "*" .. (title or "error") })
	send_message(3, { event = "report_error", content = str })
	send_message(3, { event = "report_error", content = debug.traceback("", level) })
end


function panic(msg, level, title)
	level = (level or 1) + 1
	error(msg, level, title or "panic")
	stop()
end


----------------------------------------------------------------------------------------------------
-- Require
----------------------------------------------------------------------------------------------------


_modules = {}


-- A 'require' function similar to standard Lua.
-- Idea from elgopher on the BBS
function require(name)
	if (_modules == nil) _modules = {}

	local cached = _modules[name]
	if (cached) return cached

	local filename = fullpath(name)
	local src = fetch(filename)
	if (type(src) != "string") panic("could not include " .. filename, 2)

	-- https://www.lua.org/manual/5.4/manual.html#pdf-load
	-- chunk name (for error reporting)
	-- mode ("t" for text only -- no binary chunk loading)
	-- _ENV upvalue
	-- @ is a special character that tells debugger the string is a filename
	local func, err = load(src, "@" .. filename, "t", _ENV)
	if (not func) panic("\n"..tostr(err), 2, "Syntax error:")

	local module = func()
	_modules[name] = module

	return module
end


----------------------------------------------------------------------------------------------------
-- Structure
----------------------------------------------------------------------------------------------------


function structure(meta)
	meta.__index = meta
	meta.type = meta
	setmetatable(
		meta,
		{
			__call =
				function(mt, instance)
					setmetatable(instance, mt)
					return instance
				end,
		}
	)
	return meta
end

:: src/misc.lua
--[[pod_format="raw",created="2024-04-07 07:42:45",modified="2026-01-27 08:27:46",revision=5104]]
-- Table utility functions --------------------------------------------------------


function table_deep_copy(t, already)
	if (not already) already = {}
	if type(t) == "table" then
		if already and already[t] then
			return already[t]
		end
		local new = {}
		already[t] = new
		for k, v in pairs(t) do
			new[k] = table_deep_copy(v, already)
		end
		return new
	else
		return t
	end
end


function tostrrec(t)
	if type(t) != "table" then
		return tostr(t)
	end
	
	local s = nil
	for k, v in pairs(t) do
		if not(s) then
			s = "{ "
		else
			s ..= ", "
		end
		s ..= tostr(k) .. " = " .. tostrrec(v)
	end
	s ..= " }"

	return s
end


-- Char utilities -----------------------------------------------------------------


function keyp_num()
	if (keyp("9")) return 9
	if (keyp("8")) return 8
	if (keyp("7")) return 7
	if (keyp("6")) return 6
	if (keyp("5")) return 5
	if (keyp("4")) return 4
	if (keyp("3")) return 3
	if (keyp("2")) return 2
	if (keyp("1")) return 1
	if (keyp("0")) return 0
	return nil
end


function keyp_hex()
	if (keyp("f")) return 0xf
	if (keyp("e")) return 0xe
	if (keyp("d")) return 0xd
	if (keyp("c")) return 0xc
	if (keyp("b")) return 0xb
	if (keyp("a")) return 0xa
	if (keyp("9")) return 0x9
	if (keyp("8")) return 0x8
	if (keyp("7")) return 0x7
	if (keyp("6")) return 0x6
	if (keyp("5")) return 0x5
	if (keyp("4")) return 0x4
	if (keyp("3")) return 0x3
	if (keyp("2")) return 0x2
	if (keyp("1")) return 0x1
	if (keyp("0")) return 0x0
	return nil
end

function is_num_char(c)
	if (not c) return
	return ("0" <= c) and (c <= "9")
end


function is_hexa_char(c)
	if (not c) return
	local is_num = ("0" <= c) and (c <= "9")
	local is_hex_alpha = ("a" <= c) and (c <= "f")
	return is_num or is_hex_alpha
end


function p8_centered_print(s, x, y, col)
	local count = #s
	print(s, x - ((count * 4) \ 2), y, col)
end



-- Drawing -------------------------------------------------------------------------


-- From Sophie on the discord
function get_drawspace()
    return {
        cam_x=peek4(0x5510),
        cam_y=peek4(0x5514),
        clip_l=peek2(0x5528),
        clip_t=peek2(0x552a),
        clip_r=peek2(0x552c),
        clip_b=peek2(0x552e),
    }
end


function set_drawspace(drawspace)
    poke4(0x5510,drawspace.cam_x)
    poke4(0x5514,drawspace.cam_y)
    poke2(0x5528,drawspace.clip_l)
    poke2(0x552a,drawspace.clip_t)
    poke2(0x552c,drawspace.clip_r)
    poke2(0x552e,drawspace.clip_b)
end

:: src/selection.lua
--[[pod_format="raw",created="2026-01-27 06:45:26",modified="2026-01-27 08:27:46",revision=217]]
local selection = {}


local Cursor = structure {
	-- channel: Int
	-- step: Int
	-- anchor: Int
}


selection.note = 1 << 0
selection.octave = 1 << 1
selection.inst_hi = 1 << 2
selection.inst_lo = 1 << 3
selection.vol_hi = 1 << 4
selection.vol_lo = 1 << 5
selection.fx = 1 << 6
selection.fx_hi = 1 << 7
selection.fx_lo = 1 << 8


local cursors = {}
local cursors_mask = 0x00 -- all cursors share the same mask


function selection.set_cursor(channel, step, mask)
	cursors_mask = mask
	cursors = {
		Cursor {
			channel = channel,
			step = step,
			anchor = step,
		}
	}
end


function selection.is_selected(channel, step, mask)
	if mask & cursors_mask == 0 then
		return false
	end
	for cursor in all(cursors) do
		if
			channel == cursor.channel
			and step >= cursor.anchor
			and step <= cursor.step
		then
			return true
		end
	end
	return false
end


function selection.is_step_cursor(channel, step)
	if #cursors ~= 1 then
		return false
	end
	return
		step == cursors[1].anchor
		and step == cursors[1].step
end


return selection
:: src/settings.lua
--[[pod_format="raw",created="2024-04-11 08:58:08",modified="2026-01-27 08:27:46",revision=6365]]
local settings = {}

local settings_folder = "/appdata/wavemaker/"
local settings_filepath = "/appdata/wavemaker/settings.pod"
local keys_filepath = "/appdata/wavemaker/keys.pod"


settings.piano_keys = { pitched = {
	{
		offset = -12,
		[0] = "z", "s", "x", "d", "c", "v", "g", "b", "h", "n", "j", "m",
		",", "l", ".", ";", "/"
	},
	{
		offset = 0,
		[0] = "q", "2", "w", "3", "e", "r", "5", "t", "6", "y", "7", "u",
		"i", "9", "o", "0", "p", "[", "=", "]",
	}
}}


settings.isomorphic_keys = { pitched = {
	{
		offset = -5,
		[0] = "z", "x", "c", "v", "b", "n", "m", ",", ".", "/",
	},
	{
		offset = 0,
		[0] = "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'",
	},
	{
	offset = 5,
		[0] = "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\",
	},
	{
	offset = 10,
		[0] = "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=",
	}
}}


settings.chromatic_keys = { pitched = {
	{
		offset = -10,
		[0] = "z", "x", "c", "v", "b", "n", "m", ",", ".", "/",
	},
	{
		offset = 0,
		[0] = "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'",
	},
	{
	offset = 10,
		[0] = "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\",
	},
	{
	offset = 20,
		[0] = "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=",
	}
}}

settings.keys = {
	pitched = settings.piano_keys.pitched,
	play = "space",
	rest = "del",
}


settings.user = {
	pitched_layout = "piano-like",
	drag_horizontal = false,
	drag_sensitivity = 0.5,
	drag_sensitivity_precise = 0.125,
}


function settings.load()
	mkdir(settings_folder)
	local user_keys = fetch(keys_filepath)
	if user_keys then
		for k, v in pairs(settings.keys) do
			if user_keys[k] then
				settings.keys[k] = user_keys[k]
			end
		end
	end
	local user_settings = fetch(settings_filepath)
	if user_settings then
		for k, v in pairs(settings.user) do
			if user_settings[k] then
				settings.user[k] = user_settings[k]
			end
		end
	end
end


function settings.change_keys(t)
	for k, v in pairs(t) do
		settings.keys[k] = v
	end
	store(keys_filepath, settings.keys)
end


function settings.change_user(t)
	for k, v in pairs(t) do
		settings.user[k] = v
	end
	store(settings_filepath, settings.user)
end


return settings
:: src/sfx.lua
--[[pod_format="raw",created="2024-04-07 08:22:05",modified="2026-01-27 08:27:46",revision=10851]]
local sfx = {}

----------------------------------------------------------------------------------------------------
-- Stat
----------------------------------------------------------------------------------------------------


function sfx.are_channels_playing(bitfield)
	return (stat(464) & bitfield) ~= 0
end


----------------------------------------------------------------------------------------------------
-- Header
----------------------------------------------------------------------------------------------------


local num_instrument
local num_tracks
local num_patterns
local header_flags
local base_pat -- default 0x030100 = base + 0x000100
local base_syn -- default 0x040000 = base + 0x010000
local base_trk -- default 0x050000 = base + 0x020000


function sfx.read_header(addr)
	local addr = addr or 0x030000
	num_instruments = peek2(addr)
	num_tracks = peek2(addr + 0x2)
	num_patterns = peek2(addr + 0x4)
	header_flags = peek2(addr + 0x6)
	-- unused: peek2(addr + 0x8)
	base_syn = addr + peek4(addr + 0x10)
	base_trk = addr + peek4(addr + 0x14)
	base_pat = addr + peek4(addr + 0x18) + 0x100
end


sfx.read_header()


function sfx.num_instruments()
	return num_instruments
end


function sfx.instruments_address()
	return base_syn
end


function sfx.tracks_address()
	return base_trk
end


function sfx.patterns_address()
	return base_pat
end


----------------------------------------------------------------------------------------------------
-- Pattern Info
----------------------------------------------------------------------------------------------------


function sfx.pattern_loop_start(pattern)
	return (peek(base_pat + (pattern * 20) + 8) & 0x01) != 0
end


function sfx.set_pattern_loop_start(pattern, bool)
	local old = peek(base_pat + (pattern * 20) + 8)
	if bool then
		poke(base_pat + (pattern * 20) + 8, old | 0x01)
	else
		poke(base_pat + (pattern * 20) + 8, old & (~ 0x01))
	end
end


function sfx.pattern_loop_end(pattern)
	return (peek(base_pat + (pattern * 20) + 8) & 0x02) != 0
end


function sfx.set_pattern_loop_end(pattern, bool)
	local old = peek(base_pat + (pattern * 20) + 8)
	if bool then
		poke(base_pat + (pattern * 20) + 8, old | 0x02)
	else
		poke(base_pat + (pattern * 20) + 8, old & (~ 0x02))
	end
end


function sfx.pattern_loop_stop(pattern)
	return (peek(base_pat + (pattern * 20) + 8) & 0x04) != 0
end


function sfx.set_pattern_loop_stop(pattern, bool)
	local old = peek(base_pat + (pattern * 20) + 8)
	if bool then
		poke(base_pat + (pattern * 20) + 8, old | 0x04)
	else
		poke(base_pat + (pattern * 20) + 8, old & (~ 0x04))
	end
end


function sfx.channel_is_muted(pattern, channel)
	local channel_mutes = peek(base_pat + (pattern * 20) + 9)
	local muted = (channel_mutes & (1 << channel)) == 0
	return muted
end


function sfx.mute_channel(pattern, channel, mute)
	local channel_mutes = peek(base_pat + (pattern * 20) + 9)
	channel_mutes &= ~(1 << channel)
	channel_mutes |= (mute and 0 or 1) << channel
	poke(base_pat + (pattern * 20) + 9, channel_mutes)
end


function sfx.pattern_track(pattern, channel)
	return peek(base_pat + pattern * 20 + channel)
end


----------------------------------------------------------------------------------------------------
-- Track Info
----------------------------------------------------------------------------------------------------


function sfx.track_speed(track)
	return peek(base_trk + (track * 328) + 2)
end


function sfx.set_track_speed(track, val)
	return poke(base_trk + (track * 328) + 2, val)
end


function sfx.track_loop0(track)
	return peek(base_trk + (track * 328) + 3)
end


function sfx.set_track_loop0(track, val)
	return poke(base_trk + (track * 328) + 3, val)
end


function sfx.track_loop1(track)
	return peek(base_trk + (track * 328) + 4)
end


function sfx.set_track_loop1(track, val)
	return poke(base_trk + (track * 328) + 4, val)
end


----------------------------------------------------------------------------------------------------
-- Track Notes
----------------------------------------------------------------------------------------------------


function sfx.track_pitch(track, step)
	return peek(base_trk + 8 + (track * 328) + step)
end


function sfx.set_track_pitch(track, step, v)
	return poke(base_trk + 8 + (track * 328) + step, v)
end


function sfx.track_instrument(track, step)
	return peek(base_trk + 8 + (track * 328) + step + 64)
end


function sfx.set_track_instrument(track, step, v)
	return poke(base_trk + 8 + (track * 328) + step + 64, v)
end


function sfx.track_volume(track, step)
	return peek(base_trk + 8 + (track * 328) + step + (2 * 64))
end


function sfx.set_track_volume(track, step, v)
	return poke(base_trk + 8 + (track * 328) + step + (2 * 64), v)
end


function sfx.track_fx(track, step)
	return peek(base_trk + 8 + (track * 328) + step + (3 * 64))
end


function sfx.set_track_fx(track, step, v)
	return poke(base_trk + 8 + (track * 328) + step + (3 * 64), v)
end


function sfx.track_fx_params(track, step)
	return peek(base_trk + 8 + (track * 328) + step + (4 * 64))
end


function sfx.track_fx_param0(track, step)
	return peek(base_trk + 8 + (track * 328) + step + (4 * 64)) >> 4
end


function sfx.track_fx_param1(track, step)
	return peek(base_trk + 8 + (track * 328) + step + (4 * 64)) & 0xf
end


function sfx.set_track_fx_params(track, step, v)
	return poke(base_trk + 8 + (track * 328) + step + (4 * 64), v)
end


function sfx.set_track_fx_param0(track, step, v)
	local previous = peek(base_trk + 8 + (track * 328) + step + (4 * 64))
	return poke(base_trk + 8 + (track * 328) + step + (4 * 64), (previous & 0x0f) | (v << 4))
end


function sfx.set_track_fx_param1(track, step, v)
	local previous = peek(base_trk + 8 + (track * 328) + step + (4 * 64))
	return poke(base_trk + 8 + (track * 328) + step + (4 * 64), (previous & 0xf0) | (v & 0x0f))
end


----------------------------------------------------------------------------------------------------
-- Synth: Instrument Info
----------------------------------------------------------------------------------------------------


function sfx.instrument_name(instrument)
	local inst_addr = base_syn + instrument * 0x200
	local length = 16
	for j = 15, 0, -1 do
		if peek(inst_addr + 496 + j) == 0 then
			length = j
		end
	end
	return chr(peek(inst_addr + 496, length))
end


function sfx.set_instrument_name(instrument, name)
	local inst_addr = base_syn + instrument * 0x200
	memset(inst_addr + 496, 0, 16)
	poke(inst_addr + 496, ord(name, 1, min(16, #name)))
end


function sfx.instrument_flag(instrument, flag)
	local inst_addr = base_syn + instrument * 0x200
	local addr = inst_addr + 0x1df
	return (peek(addr) & flag) > 0
end


function sfx.set_instrument_flag(instrument, flag, value)
	local inst_addr = base_syn + instrument * 0x200
	local addr = inst_addr + 0x1df
	local other_flags = peek(addr) & (~ flag)
	if value then
		poke(addr, other_flags | flag)
	else
		poke(addr, other_flags)
	end
end


function sfx.toggle_instrument_flag(instrument, flag)
	local inst_addr = base_syn + instrument * 0x200
	local addr = inst_addr + 0x1df
	local previous = peek(addr)
	poke(addr, previous ^^ flag)
end


function sfx.wavetable_info(instrument, wt_index)
	local inst_addr = base_syn + instrument * 0x200
	local wt_4defs_addr = inst_addr + 0x1e0 -- start of the 4 wt definitions
	local wt_def_addr = wt_4defs_addr + wt_index * 4
	local addr0, addr1, width_bits, wt_height = peek(wt_def_addr,4)
	local dat_addr = (addr0 << 8) | (addr1 << 16)
	local wt_width = 1 << width_bits
	return dat_addr, wt_width, wt_height
end


----------------------------------------------------------------------------------------------------
-- Synth: Node Tree
----------------------------------------------------------------------------------------------------


sfx.nodes = {}
for n = 0, 7 do
	sfx.nodes[n] = {
		parent = nil, -- id of the parent
		children = {}, -- list of direct references to the children
		type = nil,
	}
end
	

local function depth_walk(root, pre_fun, post_fun, depth)
	if (not depth) depth = 0
	if depth > 8 then
		-- TODO: remove notification
		notify("*** Deep recursion: cycle in synth nodes? ***")
		return
	end
	if (pre_fun) pre_fun(root)
	for i = 1, #root.children do
		local child = root.children[i]
		if child.type != 0 then
			depth_walk(child, pre_fun, post_fun, depth + 1)
		end
	end
	if (post_fun) post_fun(root)
end


function sfx.refresh_nodes(instrument)
	for n = 0, 7 do
		sfx.nodes[n].id = n
		sfx.nodes[n].children = {}
		sfx.nodes[n].older_sibling = nil
		sfx.nodes[n].height = nil -- TODO: or 0?
		sfx.nodes[n].position = nil
	end
	sfx.root = sfx.nodes[0]
	sfx.root.free_nodes = 7
	--- printh("* refresh *")
	for n = 0, 7 do
		local type = sfx.node_type(instrument, n)
		local op = sfx.node_op(instrument, n)
		local parent_id = sfx.node_parent(instrument, n)
		--- printh("" .. parent_id .. " -> " .. n .. " type=" .. type .. " op=" .. op)
		sfx.nodes[n].parent = sfx.nodes[parent_id]
		sfx.nodes[n].type = type
		sfx.nodes[n].op = op
		sfx.nodes[n].last_child = function(self)
			if (#self.children == 0) return self
			return self.children[#self.children]:last_child()
		end
		if type != 0 and n != 0 then
			add(sfx.nodes[n].parent.children, sfx.nodes[n])
			sfx.root.free_nodes -= 1
		end
	end
	
	depth_walk(
		sfx.root,
		nil,
		function(node)
			if #node.children == 0 then
				node.height = 1
			else
				local h = 0
				for i = 1, #node.children do
					local child = node.children[i]
					if i > 1 then
						child.older_sibling = node.children[i - 1]
					end
					h += child.height
				end
				node.height = h
			end
		end
	)

	sfx.root.position = { row = 0, column = 0 }
	depth_walk(
		sfx.root,
		function(node)
			local row = node.position.row
			for i = 1, #node.children do
				node.children[i].position = {
					column = node.position.column + 1,
					row = row,
				}
				row += node.children[i].height
			end
		end,
		nil
	)
end


function sfx.add_node(instrument, parent_id, node_type, node_op, target_id, child_id)
	local parent = sfx.nodes[parent_id]
	
	if (not parent) notify("invalid parent (nil)"); return
	if (parent.type >= 8) notify("invalid parent (filter)"); return

	if target_id >= 8 then
		-- no room!
		return
	end	

	sfx.insert_node(instrument, target_id, parent_id, child_id)
	
	if node_type == 0x2 and node_op == 1 then
		-- FM mod osc
		sfx.set_node_type(instrument, target_id, node_type)
		sfx.set_node_op(instrument, target_id, node_op)
		sfx.set_node_param_val1(instrument, target_id, 0, 0x20) -- volume
		sfx.set_node_param_flags(instrument, target_id, 2, 0x02) -- not quantized, and relation + for tune
		sfx.set_node_param_flags(instrument, target_id, 3, 0x01) -- relation + for bend
	elseif node_type == 0x2 and node_op == 2 then
		-- Ring mod osc
		sfx.set_node_type(instrument, target_id, node_type)
		sfx.set_node_op(instrument, target_id, node_op)
		sfx.set_node_param_val1(instrument, target_id, 0, 0x20) -- volume
		sfx.set_node_param_flags(instrument, target_id, 2, 0x01) -- not quantized, and relation + for tune
		sfx.set_node_param_flags(instrument, target_id, 3, 0x01) -- relation + for bend
	elseif node_type == 0x2 then
		-- Osc
		sfx.set_node_type(instrument, target_id, node_type)
		sfx.set_node_op(instrument, target_id, node_op)
		sfx.set_node_param_val1(instrument, target_id, 0, 0x20) -- volume
		sfx.set_node_param_flags(instrument, target_id, 0, 0x02) -- relation * for volume
		sfx.set_node_param_flags(instrument, target_id, 1, 0x01) -- relation + for pan
		sfx.set_node_param_flags(instrument, target_id, 2, 0x21) -- quantized, and relation + for tune
		sfx.set_node_param_flags(instrument, target_id, 3, 0x01) -- relation + for bend
	elseif node_type == 0xa then
		sfx.set_node_type(instrument, target_id, node_type)
		sfx.set_node_param_val1(instrument, target_id, 3, 0x40) -- mix
	else
		sfx.set_node_type(instrument, target_id, node_type)
	end
	return target_id
end


----------------------------------------------------------------------------------------------------
-- Synth: Node Configuration
----------------------------------------------------------------------------------------------------


function sfx.delete_node(instrument, node_id)
	local deleted_node_parent = sfx.node_parent(instrument, node_id)
	local inst_addr = base_syn + instrument * 0x200
	-- move everything up
	for j = node_id, 7 do
		memcpy(inst_addr + j * 0x20, inst_addr + (j + 1) * 0x20, 0x20)
	end
	memset(inst_addr + 7 * 0x20, 0, 0x20)
	-- fix parents
	for j = 0, 6 do
		local parent = sfx.node_parent(instrument, j)
		if parent == node_id then
			sfx._set_node_parent(instrument, j, deleted_node_parent)
		elseif parent > node_id then
			sfx._set_node_parent(instrument, j, parent - 1)
		end
	end
end


function sfx.insert_node(instrument, node_id, parent_id, child_id)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node_id * 0x20
	-- move everything down
	for j = 7, node_id + 1, -1 do
		memcpy(inst_addr + j * 0x20, inst_addr + ( j - 1) * 0x20, 0x20)
	end
	memset(node_addr, 0, 0x20)
	-- fix parents
	poke(node_addr, parent_id)
	for j = 0, 7 do
		local parent = sfx.node_parent(instrument, j)
		if parent >= node_id then
			sfx._set_node_parent(instrument, j, parent + 1)
		end
	end
	if child_id then
		if child_id >= node_id then
			child_id += 1
		end
		if child_id <= 7 then
			sfx._set_node_parent(instrument, child_id, node_id)
		end
	end
end


function sfx.node_parent(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	return peek(node_addr + 0) & 0x7	
end

function sfx._set_node_parent(instrument, node, parent)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local previous = peek(node_addr + 0)
	poke(node_addr + 0, (previous & ~0x7) | (parent & 0x7))
end

function sfx.node_op(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	return peek(node_addr) >> 4
end

function sfx.set_node_op(instrument, node, op)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local previous = peek(node_addr)
	poke(node_addr, (previous & 0x0f) | (op << 4))
end

function sfx.node_type(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	return peek(node_addr + 1) & 0xf
end

function sfx.set_node_type(instrument, node, type)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local previous = peek(node_addr + 1)
	poke(node_addr + 1, (previous & 0xf0) | (type & 0x0f))
end

function sfx.node_osc_wavetable(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	return peek(node_addr + 1) >> 4
end

function sfx.set_node_osc_wavetable(instrument, node, wt)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local previous = peek(node_addr + 1)
	poke(node_addr + 1, (previous & 0x0f) | (wt << 4))
end

function sfx.node_flags(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	return peek(node_addr + 2)
end

function sfx.set_node_flags(instrument, node, flags)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	poke(node_addr + 2, flags)
end

-- node_addr + 3 is unused

-- 0 <= p <= 7
function sfx.node_param(instrument, node, p)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local flags,val1,val0,env = peek(node_addr + 4 + (4 * p), 4)
	return flags, val1, val0, env
end

function sfx.set_node_param_flags(instrument, node, p, flags)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	poke(node_addr + 4 + (4 * p), flags)
end

function sfx.set_node_param_val1(instrument, node, p, val1)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	poke(node_addr + 4 + (4 * p) + 1, val1)
end

function sfx.set_node_param_val0(instrument, node, p, val0)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	poke(node_addr + 4 + (4 * p) + 2, val0)
end

function sfx.set_node_param_env(instrument, node, p, env)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	poke(node_addr + 4 + (4 * p) + 3, env)
end

function sfx.node_wavetable_info(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local wt_4defs_addr = inst_addr + 0x1e0 -- start of the 4 wt definitions
	local node_addr = inst_addr + node * 0x20
	local wt_index = (peek(node_addr+1)>>4)
	local wt_def_addr = wt_4defs_addr + wt_index * 4
	local addr0, addr1, width_bits, wt_height = peek(wt_def_addr,4)
	local dat_addr = (addr0 << 8) | (addr1 << 16)
	local wt_width = 1 << width_bits
	return dat_addr, wt_width, wt_height
end

function sfx.node_wavetable_index(instrument, node)
	local inst_addr = base_syn + instrument * 0x200
	local node_addr = inst_addr + node * 0x20
	local wt_index = (peek(node_addr+1)>>4)
	return wt_index
end


----------------------------------------------------------------------------------------------------
-- Synth: Envelopes
----------------------------------------------------------------------------------------------------


function sfx.env_type(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr)
end


function sfx.set_env_type(instrument, env, type)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr, type)
end


function sfx.env_flags(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 1)
end


function sfx.set_env_flags(instrument, env, flags)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 1, flags)
end


function sfx.env_speed(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 2)
end


function sfx.set_env_speed(instrument, env, val)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 2, val)
end


function sfx.env_loop0(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 3)
end


function sfx.set_env_loop0(instrument, env, val)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 3, val)
end


function sfx.env_loop1(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 4)
end


function sfx.set_env_loop1(instrument, env, val)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 4, val)
end


function sfx.env_start(instrument, env)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 5)
end


function sfx.set_env_start(instrument, env, val)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 5, val)
end


function sfx.env_param(instrument, env, param)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return peek(env_addr + 8 + param)
end


function sfx.set_env_param(instrument, env, param, val)
	local inst_addr = base_syn + instrument * 0x200
	local env_addr = inst_addr + 256 + env * 24
	return poke(env_addr + 8 + param, val)
end


return sfx
:: src/ui.lua
--[[pod_format="raw",created="2024-04-23 10:25:40",modified="2026-01-27 08:27:46",revision=4561]]
local settings = require "src/settings.lua"


ui = {}


----------------------------------------------------------------------------------------------------
-- Head
----------------------------------------------------------------------------------------------------


local head = false


function ui.create_head()
	head = create_gui()
end


function ui.head()
	return head
end


----------------------------------------------------------------------------------------------------
-- Misc
----------------------------------------------------------------------------------------------------


function ui.print_centered(s, x, y, col)
	local count = #s
	print(s, x - ((count * 4) \ 2), y, col)
end


----------------------------------------------------------------------------------------------------
-- Mouse
----------------------------------------------------------------------------------------------------


function ui.mouselock(sensitivity, precise)
	local s = settings.user.drag_sensitivity
	if precise or key("shift") then
		s = settings.user.drag_sensitivity_precise
	end
	s *= sensitivity or 1
	local dx, dy = mouselock(0x4|0x8, s, 0.0)
	if settings.user.drag_horizontal then
		return -dx
	end
	return dy
end


function ui.mouseunlock()
	mouselock(false)
end


----------------------------------------------------------------------------------------------------
-- Modal
----------------------------------------------------------------------------------------------------


local layer = false


function ui.open_modal(el)
	layer = ui.head():attach {
		x = 0, y = 0,
		width = ui.head().width, height = ui.head().height,
		draw = function(self)
			poke(0x550b, 0x3f)
			---fillp(0b0101101001011010)
			---fillp(0b0001001001001000)
			---fillp(0b1110110110110111)
			fillp(0b0011011011001001)
			rectfill(0, 0, self.width - 1, self.height - 1, 61)
			fillp()
			poke(0x550b, 0x00)
		end,
		click = function(self)
			ui.close_modal()
		end
	}
	layer:attach(el)
	return el
end


function ui.has_modal()
	return layer
end


function ui.close_modal()
	if layer then
		layer:detach()
	end
	layer = false
end


function ui.has_modal_or_menu()
	return ui.has_modal() or ui.has_menu()
end


----------------------------------------------------------------------------------------------------
-- Chooser
----------------------------------------------------------------------------------------------------


function ui.chooser(options, callback)
	-- Copied from system 0.2.2b
	if (type(options) == "string") options = {path = options}
	if (type(options) ~= "table") options = {}

	options.path = fullpath(options.path or ".") -- can be relative to pwd; default to pwd()
	if (not options.path) return "could not resolve path"
	if (fstat(options.path) ~= "folder") return "path not found"

	local intention = options.intention or "choose_items"
	local intention_event = nil

	if (callback) intention_event = "_chooser_response_"..stat(333) -- unique id

	create_process("/system/apps/filenav.p64",{
		window_attribs = {autoclose = true, workspace = "current"},
		intention = intention,
		intention_event = intention_event,
		title = options.title, -- window title
		prompt = options.prompt, -- "Choose a File" (bottom left in intention pane)
		verb = options.verb, -- "Open" ~ (bottom right button in intention pane)
		path = options.path  -- starting path
	})

	if (callback) then
		-- create a unique, use-once handler 
		-- to do: mechanism to delete event handler when filenav never gets a chance to respond
		-- (but maybe too complex -- is harmless to have ~100 or so dormant event handlers sitting around)
		on_event(intention_event, function(msg)
			callback(msg)
			on_event(intention_event) -- delete
		end)
	end
	
end


----------------------------------------------------------------------------------------------------
-- Label
----------------------------------------------------------------------------------------------------


function ui.create_label(el)
	el.width = 4 * #el.label + 4
	el.height = 5
	ui.head():new(el)
	function el:draw()
		print(el.label, 0, 0, el.fg or 5)
	end
	return el
end


----------------------------------------------------------------------------------------------------
-- Checkbox
----------------------------------------------------------------------------------------------------


function ui.create_checkbox(el)
	el.width = 9 + (4 * #el.label or "")
	el.height = 7
	el.cursor = "pointer"
	ui.head():new(el)
	if (not el.visible) el.visible = function() return true end
	function el:draw()
		if (not self:visible()) return
		rect(0, 0, 6, 6,  el.check_border or 59)
		if el.check_bg then
			rectfill(1, 1, 5, 5, el.check_bg)
		end
		if self.get() then
			rectfill(2, 2, 4, 4, el.check_fg or 17)
		end
		print(el.label, 10, 1, el.fg or 5)
	end
	function el:tap()
		if (not self:visible()) return
		self.set(not self.get())
	end
	return el
end


----------------------------------------------------------------------------------------------------
-- Numeric Field
----------------------------------------------------------------------------------------------------


function ui.create_num_field(el)
	el.width = el.width or 62
	el.height = 12
	ui.head():new(el)
	if (not el.visible) el.visible = function() return true end
	el.dragged = nil
	function el:draw()
		local label_fg = self.label_fg or 5
		local field_fg = self.field_fg or 22
		local dragged_fg = self.dragged_fg or 7
		local field_bg = self.field_bg or 59
		local dragged_bg = self.dragged_bg or 59
		if (not self.visible()) return
		local val = self.get()
		rectfill(self.width - 24, 0, self.width - 10, 6, self.dragged and dragged_bg or field_bg)
		print(el.label, 3, 1, label_fg)
		if val then
			print(string.format("%3d", val), self.width - 22, 1, self.dragged and dragged_fg or field_fg)
		else
			print("-", self.width - 4, 1, self.dragged and dragged_fg or field_fg)
		end
	end
	function el:hover(msg)
		if msg.mx >= self.width - 21 then
			--- self.cursor = "pointer"
			self.cursor = get_spr(50)
		else
			self.cursor = 1
		end
	end
	function el:click(msg)
		if (not self.visible()) return
		if (self.onclick) self.onclick(msg)
		if msg.mx >= self.width - 21 then
			self.dragged = true
			self.cursor = 0 -- TODO: capture mouse
		end
	end
	function el:drag(msg)
		if (not el.visible()) return
		if self.dragged then
			local _, delta = mouselock(true, key("shift") and 0.025 or 0.125, 0)
			new = mid(0, self.get() - delta, 0xff)
			self.set(new)
		end
	end
	function el:release(msg)
		self.dragged = nil
		mouselock(false)
		if (self.onrelease) self.onrelease(msg)
	end
	return el
end


----------------------------------------------------------------------------------------------------
-- Menu
----------------------------------------------------------------------------------------------------


local popup = false


function ui.create_menu_button(el)
	local label = el.get_label()
	el.width = (4 * #label) + 12
	el.height = 9
	el.cursor = "pointer"
	ui.head():new(el)
	el.opened = false
	function el:draw()
		if self.bg then
			rectfill(0, 0, self.width - 1, self.height - 1, self.bg)
		end
		local label = self:get_label()
		print(label, 2, 2, self.fg or 7)
		pal(7, self.fg or 7)
		spr(self.opened and 38 or 37, self.width - 7, 2)
		pal(7, 7)
	end
	function el:tap()
		self.opened = true
		ui.open_menu {
			x = self.sx, y = self.sy + 9,
			highlight = self.highlight,
			onclose = function()
				self.opened = false
				local label = el.get_label()
				self.width = (4 * #label) + 12
			end,
			items = self.items,
		}
	end
	return el
end


function ui.open_menu(menu)
	for i = 1, #menu.items do
		if menu.items[i].get_label then
			menu.items[i].label = menu.items[i].get_label()
		end
		if (not menu.items[i].label) menu.items[i].label = "---"
	end
	local entry_height = 9
	-- Calculate popup size
	if not menu.width then
		menu.width = 0
		for i = 1, #menu.items do
			menu.width = max(menu.width, #menu.items[i].label or 0)
		end
		menu.width = 8 + (4 * menu.width)
	end
	if not menu.height then
		menu.height = max(12, 4 + (#menu.items * entry_height))
	end
	if menu.y + menu.height > ui.head().height then
		menu.y = menu.y - 7 - menu.height
	end

	-- Modal layer	
	popup = ui.head():attach {
		x = 0, y = 0,
		width = ui.head().width, height = ui.head().height,
		draw = function(self)
			local ox, oy = menu.x, menu.y
			rectfill(ox, oy, ox + menu.width - 1, oy + menu.height - 1, menu.bg or 7)
			rect(ox, oy, ox + menu.width - 1, oy + menu.height - 1, menu.border or 5)
			for i = 1, #menu.items do
				local y = oy + 2 + (entry_height * (i - 1))
				if self.highlighted == i then
					rectfill(
						ox + 1, y,
						ox + menu.width - 2, y + entry_height - 1,
						menu.highlight or 15
					) 
				end
				print(
					menu.items[i].label,
					ox + 4, y + 2,
					menu.items[i].fg or menu.fg or 62
				)
			end
		end,
		hover = function(self)
			local ox, oy = menu.x, menu.y
			local mx, my, mb = mouse()
			if
				ox <= mx and mx < ox + menu.width
				and oy <= my and my < oy + menu.height
			then
				self.cursor = "pointer"
				self.highlighted = 1 + ((my - oy - 4) \ entry_height)
			else
				self.cursor = "pointer"
				self.highlighted = false
			end
		end,
		click = function(self)
			if popup then
				popup:detach()
			end
			popup = false
			if self.highlighted and menu.items[self.highlighted]
				and menu.items[self.highlighted].action
			then
				menu.items[self.highlighted].action()
			end
			if (menu.onclose) menu.onclose()
		end
	}
end


function ui.has_menu()
	return popup != false
end


----------------------------------------------------------------------------------------------------
-- Knob
----------------------------------------------------------------------------------------------------


function ui.create_knob(el)
	if el.small then
		el.x += 3
		el.y += 5
		el.width, el.height = 25, 25
		el.cx, el.cy, el.r = 12, 12, 7
		el.sprite = 58
	else
		el.width, el.height = 31, 31
		el.cx, el.cy, el.r = 15, 15, 9
		el.sprite = 56
	end
	el.cursor = get_spr(50)
	ui.head():new(el)
	

	function el:draw()
		local target = self.min_val and self or self.parent
		local sprite = (target.min_val < 0)
			and (self.sprite + 1) or self.sprite
		spr(sprite, 0, 0)	
		local range = target.max_val - target.min_val
		-- primary value
		local val = self:get()
		local a = ((val - target.min_val) / range) * 0.75
		local x = self.cx + flr(0.5 + self.r * cos(0.625 - a))
		local y = self.cy + flr(0.5 + self.r * sin(0.625 - a))
		-- secondary value: arc and needle
		if self:has_secondary() then
			local val2 = self:get_secondary()
			local a2 = ((val2 - target.min_val) / range) * 0.75
			local r = self.small and 6 or 7.75
			local incr = self.small and 0.01 or 0.01
			local function line_to(aa, col)
				local xx = self.cx + flr(0.5 + r * cos(0.625 - aa))
				local yy = self.cy + flr(0.5 + r * sin(0.625 - aa))
				line(self.cx, self.cy, xx, yy, 18)
			end
			local in_between =
				(a < a2) 
					and function(ai) return a < ai and ai < a2 end
					or function(ai) return a2 < ai and ai < a end
			line()
			line_to((a < a2) and a or a2)
			for ai = 0.0, 0.75, incr do
				if in_between(ai) then
					line_to(ai)
				end
			end
			line_to((a < a2) and a2 or a)
			local x2 = self.cx + flr(0.5 + (self.r - 1) * cos(0.625 - a2))
			local y2 = self.cy + flr(0.5 + (self.r - 1) * sin(0.625 - a2))
			line(self.cx, self.cy, x2, y2, self.dragged_secondary and 7 or 29)
		end	
		-- primary needle
		local needle_col = self.dragged and 7 or 15
		if self.white then
			needle_col = self.dragged and 5 or 22
		end
		line(self.cx, self.cy, x, y, needle_col)
	end
	

	function el:click(msg)
		local target = self.min_val and self or self.parent
		self.cursor = 0
		self.dragged = msg.mb == 1
		self.dragged_secondary = msg.mb == 2
		ui.mouselock(target.sensitivity)
		return true
	end
	

	function el:doubleclick(msg)
		local target = self.min_val and self or self.parent
		if msg.mb == 1 then
			self:set(target.init_val)
		elseif msg.mb == 2 then
			self:set_secondary(target.init_val)
		end
		return true
	end
	

	function el:drag(msg)
		local target = self.min_val and self or self.parent
		local delta = ui.mouselock(target.sensitivity)

		local old = self:get()
		local new = old - delta
		local old2, new2 = 0, 0
		if self:has_secondary() and msg.mb == 2 then
			old2 = self:get_secondary()
			new2 = old2 - delta
		end

		if delta < 0 then
			self.down_barrier = nil
			if self.up_barrier then
				self.up_barrier += delta
				if self.up_barrier <= 0 then
					self.up_barrier = nil
				else
					return
				end
			end
		elseif delta > 0 then
			self.up_barrier = nil
			if self.down_barrier then
				self.down_barrier -= delta
				if self.down_barrier <= 0 then
					self.down_barrier = nil
				else
					return
				end
			end
		end
		if old > 0 and new <= 0 then
			new = 0
			self.down_barrier = 24
		end
		if old < 0 and new >= 0 then
			new = 0
			self.up_barrier = 24
		end
		if old2 > 0 and new2 <= 0 then
			new2 = 0
			self.down_barrier = 24
		end
		if old2 < 0 and new2 >= 0 then
			new2 = 0
			self.up_barrier = 24
		end
		
		if msg.mb == 1 then
			self:set(new)
		elseif msg.mb == 2 then
			self:set_secondary(new2)
		end
	end
	

	function el:release(msg)
		self.cursor = get_spr(50)
		self.dragged = false
		self.dragged_secondary = false
		ui.mouseunlock()
		self.up_barrier = nil
		self.down_barrier = nil
	end
	

	return el
end


return ui
:: src/ui_envelopes.lua
--[[pod_format="raw",created="2024-04-14 20:24:26",modified="2026-01-27 08:27:46",revision=6670]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_visual = require "src/ui_visual.lua"


local ui_envelopes = {}

					

-- Envelope panel -----------------------------------------------------------


local env_type_names = { [0] = "adsr", "lfo", "custom" }
local lfo_shape_names = { [0] = "sine", "tri", "saw", "isaw", "square", "pulse" }


function ui_envelopes.make_label(env_id)
	local env_type = sfx.env_type(app.instrument, env_id)
	return env_type_names[env_type] .. " " .. env_id
end


function ui_envelopes.attach_panel(parent, el)
	el.width = el.large and (2 * app.mod_width + app.synth_gap) or app.mod_width
	if not el.large and el.x > 200 then
		-- TODO: clean this up...
		el.width += 1
	end
	el.height = app.mod_height
	parent:attach(el)

	el:attach(ui.create_menu_button {
		x = 2, y = 0, 
		env_id = el.env_id,
		get_label = function()
			return ui_envelopes.make_label(el.env_id)
		end,
		fg = 7,
		highlight = 29,
		items = {
			{ label = "adsr", action = function() sfx.set_env_type(app.instrument, el.env_id, 0); app.refresh_gui = true end },
			{ label = "lfo", action = function() sfx.set_env_type(app.instrument, el.env_id, 1); app.refresh_gui = true end },
			{ label = "custom", action = function() sfx.set_env_type(app.instrument, el.env_id, 2); app.refresh_gui = true end },
		}
	})
	
	if not el.large then
		ui_envelopes.attach_advanced_button(el, { x = el.width - 12, y = 0 })
	end

	if not app.env_advanced[el.env_id] then 

		local env_type = sfx.env_type(app.instrument, el.env_id)	
		if env_type == 0 then
			-- ADSR ----------------------------------------------
			local labels = { [0] = "a", "d", "s", "r" }
			for i = 0, 3 do
				ui_envelopes.attach_slider(el, { x = 3 + 13 * i, y = 12, slider_height = 40, env_id = el.env_id, param = i, label = labels[i] })
			end
			
		elseif env_type == 1 then
			-- LFO -----------------------------------------------
			local items = {}
			for i = 0, #lfo_shape_names do
				add(items, { label = lfo_shape_names[i], action = function() sfx.set_env_param(app.instrument, el.env_id, 5, i) end })
			end
			--[[ not yet implemented?
			ui_envelopes.attach_menu_button(el, {
				x = 14, y = 12, 
				env_id = el.env_id,
				get_label = function()
					local shape = sfx.env_param(app.instrument, el.env_id, 5)
					return lfo_shape_names[shape] or "???"
				end,
				fg = 5,
				highlight = 29,
				items = items,
			})
			]]--
			ui_envelopes.attach_slider(el, { x = 8, y = 12, slider_height = 40, env_id = el.env_id, param = 4, label = "freq" })
			ui_envelopes.attach_slider(el, { x = 34, y = 12, slider_height = 40, env_id = el.env_id, param = 6, label = "phase" })
			

		else
			-- Custom -------------------------------------
			el:attach(ui.create_checkbox {
				x = 4, y = 12,
				label = "lerp",
				check_fg = 18,
				get = function() return
					(sfx.env_flags(app.instrument, el.env_id) & 0x01) > 0
				end,
				set = function(v)
					local flags = sfx.env_flags(app.instrument, el.env_id)
					sfx.set_env_flags(app.instrument, el.env_id, (flags & ~0x01) | (v and 0x01 or 0x00))
				end,
			})
			ui_envelopes.attach_custom_editor(el, { x = 4, y = 20 })
			el:attach(ui.create_num_field {
				x = 4, y = 63,
				width = 56,
				label = "speed:",
				field_fg = 29,
				visible = function() return true end,
				get = function() return sfx.env_speed(app.instrument, el.env_id) end,
				set = function(v) sfx.set_env_speed(app.instrument, el.env_id, v) end,
			})
		end
	end
	
	if el.large or app.env_advanced[el.env_id] then
		el:attach(ui.create_checkbox {
			x = el.width - app.mod_width + 4, y = 12,
			label = "loop",
			check_fg = 18,
			visible = function() return sfx.env_type(app.instrument, el.env_id) != 2 end,
			get = function() return
				(sfx.env_flags(app.instrument, el.env_id) & 0x10) > 0
			end,
			set = function(v)
				local flags = sfx.env_flags(app.instrument, el.env_id)
				sfx.set_env_flags(app.instrument, el.env_id, (flags & ~0x10) | (v and 0x10 or 0x00))
			end,
		})
		el:attach(ui.create_num_field {
			x = el.width - app.mod_width + 0, y = 22,
			label = "speed:",
			field_fg = 29,
			visible = function() return (sfx.env_flags(app.instrument, el.env_id) & 0x10 > 0) or (sfx.env_type(app.instrument, el.env_id) == 2) end,
			get = function() return sfx.env_speed(app.instrument, el.env_id) end,
			set = function(v) sfx.set_env_speed(app.instrument, el.env_id, v) end,
		})
		el:attach(ui.create_num_field {
			x = el.width - app.mod_width + 0, y = 32,
			label = "start:",
			field_fg = 28,
			onclick = function() if (not el.large) ui_visual.open_custom_envelope(el.env_id) end,
			onrelease = function() if (not el.large) ui_visual.close() end,
			visible = function() return (sfx.env_flags(app.instrument, el.env_id) & 0x10 > 0) or (sfx.env_type(app.instrument, el.env_id) == 2) end,
			get = function() return sfx.env_start(app.instrument, el.env_id) end,
			set = function(v) sfx.set_env_start(app.instrument, el.env_id, v) end,
		})
		el:attach(ui.create_checkbox {
			x = el.width - app.mod_width + 4, y = 42,
			label = "rnd start",
			check_fg = 18,
			visible = function() return (sfx.env_flags(app.instrument, el.env_id) & 0x10 > 0) or (sfx.env_type(app.instrument, el.env_id) == 2) end,
			get = function() return
				(sfx.env_flags(app.instrument, el.env_id) & 0x08) > 0
			end,
			set = function(v)
				local flags = sfx.env_flags(app.instrument, el.env_id)
				sfx.set_env_flags(app.instrument, el.env_id, (flags & ~0x08) | (v and 0x08 or 0x00))
			end,
		})
		el:attach(ui.create_num_field {
				x = el.width - app.mod_width + 0, y = 52,
				label = "loop0:",
				field_fg = 26,
				onclick = function() if (not el.large) ui_visual.open_custom_envelope(el.env_id) end,
				onrelease = function() if (not el.large) ui_visual.close() end,
				visible = function() return (sfx.env_flags(app.instrument, el.env_id) & 0x10 > 0) or (sfx.env_type(app.instrument, el.env_id) == 2) end,
				get = function() return sfx.env_loop0(app.instrument, el.env_id) end,
				set = function(v) sfx.set_env_loop0(app.instrument, el.env_id, v) end,
		})
		el:attach(ui.create_num_field {
				x = el.width - app.mod_width + 0, y = 62,
				label = "loop1:",
				field_fg = 10,
				onclick = function() if (not el.large) ui_visual.open_custom_envelope(el.env_id) end,
				onrelease = function() if (not el.large) ui_visual.close() end,
				visible = function() return (sfx.env_flags(app.instrument, el.env_id) & 0x10 > 0) or (sfx.env_type(app.instrument, el.env_id) == 2) end,
				get = function() return sfx.env_loop1(app.instrument, el.env_id) end,
				set = function(v) sfx.set_env_loop1(app.instrument, el.env_id, v) end,
		})
	end
	
	function el:draw()
		rectfill(0, 0, self.width, 8, 18)
		---rectfill(0, 9, self.width, self.height, 6)
		ui_envelopes.draw_corners(self)
	end
	
	function el:click()
		return true
	end
		
	return el
end

	
function ui_envelopes.draw_corners(el)
	pset(0, 0, 6)
	pset(el.width - 1, 0, 6)
	pset(0, 8, 6)
	pset(el.width - 1, 8, 6)
end


function ui_envelopes.attach_slider(parent, el)
	el.width = 13
	el.height = el.slider_height + 20
	el.cursor = get_spr(50)
	parent:attach(el)
	function el:draw()
		---rectfill(0, 0, self.width - 1, self.height - 1, 7)
		local oy = 9
		for i = 0, 8, 1 do
			local h = math.floor(0.5 + (i / 8) * (el.slider_height - 1))
			if i % 8 == 0 then
				line(0, oy + el.slider_height - 1 - h, 12, oy + el.slider_height - 1 - h, 7)
			elseif i % 4 == 0 then
				line(2, oy + el.slider_height - 1 - h, 10, oy + el.slider_height - 1 - h, 7)
			else
				line(4, oy + el.slider_height - 1 - h, 8, oy + el.slider_height - 1 - h, 7)
			end
		end
		local val = sfx.env_param(app.instrument, self.env_id, self.param)
		local h = math.floor(0.5 + (val / 255) * (el.slider_height - 1))
		spr(60, 2, oy + el.slider_height - 1 - h - 3)
		line(6, oy, 6, oy + el.slider_height - 1, 59)
		if (self.dragged) pal(15, 7)
		spr(61, 2, oy + el.slider_height - 1 - h - 3)
		pal(15, 15)
		clip()
		ui.print_centered(self.label, 4 + 3, 0, 5)
		ui.print_centered(tostr(val), 4 + 3, self.height - 7, self.dragged and 59 or 58)
	end
	--[[function el:update(msg)
		if (app.has_modal()) return
		local mx, my, mb = mouse()
		if mb != 0 then
			self.hovered = self.dragged != nil
		else
			self.hovered = self.sx <= mx and mx < self.sx + self.width
				and self.sy <= my and my < self.sy + self.height
		end
	end]]
	function el:click(msg)
		self.cursor = 0
		self.dragged = true
	end
	function el:drag(msg)
		if self.dragged then
			local delta = ui.mouselock()
			local old = sfx.env_param(app.instrument, self.env_id, self.param)
			local new = old - delta
			new = mid(0, new, 255)
			sfx.set_env_param(app.instrument, self.env_id, self.param, new)
		end
	end
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		self.dragged = nil
	end
	return el
end


function ui_envelopes.attach_advanced_button(parent, el)
	el.width = 10
	el.height = 10
	el.cursor = "pointer"
	parent:attach(el)
	function el:draw()
		spr(39, 1, 1)
	end
	function el:tap()
		app.env_advanced[parent.env_id] = not app.env_advanced[parent.env_id]
		app.refresh_gui = true
	end
	return el
end


-- Custrom envelopes ------------------------------------------------------------


function ui_envelopes.attach_custom_editor(parent, el)
	el.width = 50
	el.height = 42
	el.cursor = "crosshair"
	parent:attach(el)
	el.env_id = parent.env_id
	el.draw = ui_visual.draw_custom_envelope
	function el:drag(msg)
		local param = mid(0, (msg.mx - 1) \ 3, 15)
		local val = ((self.height - 1 - msg.my) * 255) / (self.height - 2)
		local val = mid(0, math.floor(0.5 + val), 255)
		sfx.set_env_param(app.instrument, parent.env_id, param, val)
	end
	function el:update()
		local mx, my, mb = mouse()
		if
			self.sx <= mx and mx < self.sx + self.width
			and self.sy <= my and my < self.sy + self.height
		then
			local param = mid(0, (mx - self.sx - 1) \ 3, 15)
			self.selected = param
		else
			self.selected = nil
		end
	end
	return el
end


return ui_envelopes
:: src/ui_menus.lua
--[[pod_format="raw",created="2024-04-20 10:41:15",modified="2026-01-27 08:27:46",revision=5653]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_envelopes = require "src/ui_envelopes.lua"


local ui_menus = {}


-- Relationship menu -----------------------------------------------------


function ui_menus.open_relationship(self)
	local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	local node_type = sfx.node_type(app.instrument, self.parent.node_id)
	
	if node_type == 0x2 and self.parent.param == 2 then
		ui.open_menu {
			x = self.sx - 10, y = self.sy + 7,
			width = 55,
			items = {
				{
					label = (flags & 0x03 == 0x00)
						and "\|f\^:1c225d5d5d221c00\|h set"
						or "\|f\^:1c22414141221c00\|h set",
					action = function()
						self.parent.min_val, self.parent.max_val = -128, 127
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: replace parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags & ~0x3)
					 end,
				},
				{
					label = (flags & 0x03 == 0x01)
						and "\|f\^:1c225d5d5d221c00\|h add"
						or "\|f\^:1c22414141221c00\|h add",
					action = function()
						self.parent.min_val, self.parent.max_val = -128, 127
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: add parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x3) | 0x1)
					 end,
				},
				{
					label = (flags & 0x03 == 0x02)
						and "\|f\^:1c225d5d5d221c00\|h multiply"
						or "\|f\^:1c22414141221c00\|h multiply",
					action = function()
						self.parent.min_val, self.parent.max_val = 0, 255
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: mul parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x3) | 0x2)
					 end,
				},
				{ divider = true },
				{
					label = 
						(flags & 0x20 > 0)
							and "\|f\^:7f415d5d5d417f00\|h quantized"
							or "\|f\^:7f41414141417f00\|h quantized",
					action = function()
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags ^^ 0x20)
					 end,
				},
			}
		}
	elseif
		(node_type == 0x02 and self.parent.param == 0)
		or (node_type == 10 and self.parent.param == 3)
		or (node_type == 8 and self.parent.param == 2)
	then
		ui.open_menu {
			x = self.sx - 10, y = self.sy + 7,
			width = 52,
			items = {
				{
					label = (flags & 0x03 == 0x00)
						and "\|f\^:1c225d5d5d221c00\|h set"
						or "\|f\^:1c22414141221c00\|h set",
					action = function()
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: replace parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags & ~0x3)
					 end,
				},
				{
					label = (flags & 0x03 == 0x02)
						and "\|f\^:1c225d5d5d221c00\|h multiply"
						or "\|f\^:1c22414141221c00\|h multiply",
					action = function()
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: mul parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x3) | 0x2)
					 end,
				},
			}
		}
	elseif
		(node_type == 8 and self.parent.param ~= 2)
		or (node_type == 9)
		or (node_type == 10 and self.parent.param ~= 3)
	then
		-- no menu
	else
		ui.open_menu {
			x = self.sx - 10, y = self.sy + 7,
			width = 40,
			items = {
				{
					label = (flags & 0x03 == 0x00)
						and "\|f\^:1c225d5d5d221c00\|h set"
						or "\|f\^:1c22414141221c00\|h set",
					action = function()
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: replace parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags & ~0x3)
					 end,
				},
				{
					label = (flags & 0x03 == 0x01)
						and "\|f\^:1c225d5d5d221c00\|h add"
						or "\|f\^:1c22414141221c00\|h add",
					action = function()
						local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
						-- set bit: add parent
						sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x3) | 0x1)
					 end,
				},
			}
		}
	end
end


-- Multiplier menu -------------------------------------------------------------


function ui_menus.open_multiplier(self)
	local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	
	local mult_options = { 
		[0] = 
		{ label = "none", val = 0x00 | 0x00 },
		{ label = "*4", val = 0x00 | 0x40 },
		{ label = "/4", val = 0x20 | 0x40 },
		{ label = "*16", val = 0x00 | 0x80 },
		{ label = "/16", val = 0x20 | 0x80 },
		{ label = "*64", val = 0x00 | 0xc0 },
		{ label = "/64", val = 0x20 | 0xc0 },
	}
	local mult_menu_items = {}
	for i = 0, #mult_options do
		add(mult_menu_items, 
			{
				label = (env & 0xe0 == mult_options[i].val)
					and ("\|f\^:1c225d5d5d221c00\|h " .. mult_options[i].label)
					or ("\|f\^:1c22414141221c00\|h " .. mult_options[i].label),
				fg = i == 0 and 5 or 24,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_env(app.instrument, self.parent.node_id, self.parent.param, (env & ~0xe0) | mult_options[i].val)
				 end,
			}
		)
	end

	ui.open_menu {
		x = self.sx - 10, y = self.sy + 7,
		width = 36,
		items = mult_menu_items,
	}
end


-- Envelope menu ------------------------------------------------------------------


function ui_menus.open_envelope(self)
	local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	local has_env = flags & 0x04 > 0
	local has_free_run = flags & 0x08 > 0
	local has_random = flags & 0x10 > 0
	local env_id = env & 0x0f
	ui.open_menu {
		x = self.sx - 10, y = self.sy + 7,
		width = 51,
		items = {
			{
				label = (not has_env and not has_random)
					and "\|f\^:1c225d5d5d221c00\|h none"
					or "\|f\^:1c22414141221c00\|h none",
				fg = 5,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags & ~(0x4 | 0x8 | 0x10))
				 end,
			},
			{
				label = (has_env and env_id == 0)
					and ("\|f\^:1c225d5d5d221c00\|h " .. ui_envelopes.make_label(0))
					or ("\|f\^:1c22414141221c00\|h " .. ui_envelopes.make_label(0)),
				fg = 18,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x10) | 0x4)
					sfx.set_node_param_env(app.instrument, self.parent.node_id, self.parent.param, (env & 0xf0) | 0)
				 end,
			},
			{
				label = (has_env and env_id == 1)
					and ("\|f\^:1c225d5d5d221c00\|h " .. ui_envelopes.make_label(1))
					or ("\|f\^:1c22414141221c00\|h " .. ui_envelopes.make_label(1)),
				fg = 18,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x10) | 0x4)
					sfx.set_node_param_env(app.instrument, self.parent.node_id, self.parent.param, (env & 0xf0) | 1)
				 end,
			},
			{
				label = (has_env and env_id == 2)
					and ("\|f\^:1c225d5d5d221c00\|h " .. ui_envelopes.make_label(2))
					or ("\|f\^:1c22414141221c00\|h " .. ui_envelopes.make_label(2)),
				fg = 18,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x10) | 0x4)
					sfx.set_node_param_env(app.instrument, self.parent.node_id, self.parent.param, (env & 0xf0) | 2)
				end,
			},
			{
				label = (has_env and env_id == 3)
					and ("\|f\^:1c225d5d5d221c00\|h " .. ui_envelopes.make_label(3))
					or ("\|f\^:1c22414141221c00\|h " .. ui_envelopes.make_label(3)),
				fg = 18,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x10) | 0x4)
					sfx.set_node_param_env(app.instrument, self.parent.node_id, self.parent.param, (env & 0xf0) | 3)
				end,
			},
			{
				label = has_random
						and "\|f\^:1c225d5d5d221c00\|h random"
						or "\|f\^:1c22414141221c00\|h random",
				fg = 30,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, (flags & ~0x4) | 0x10)
				 end,
			},
			{
				divider = true,
			},
			{
				label = has_free_run
							and "\|f\^:7f415d5d5d417f00\|h free run"
							or "\|f\^:7f41414141417f00\|h free run",
				fg = 5,
				action = function()
					local flags, val1, val0, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
					sfx.set_node_param_flags(app.instrument, self.parent.node_id, self.parent.param, flags ^^ 0x08)
				 end,
			},
		}
	}
end


return ui_menus
:: src/ui_nodes.lua
--[[pod_format="raw",created="2024-04-12 16:30:23",modified="2026-01-27 08:27:46",revision=12228]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_envelopes = require "src/ui_envelopes.lua"
local ui_params = require "src/ui_params.lua"
local ui_visual = require "src/ui_visual.lua"


local ui_nodes = {}


-- Node panels --------------------------------------------------------------------


function ui_nodes.attach_node_panel(parent, el)
	if app.node and app.node == el.node_id then
		el.width = 480 - 4 * app.mod_width - 6 * app.synth_gap + 2
		el.height = 2 * app.synth_height + app.synth_gap
	else
		el.width = app.synth_width
		el.height = app.synth_height
	end
	parent:attach(el)
	
	local type = sfx.node_type(app.instrument, el.node_id)
	if el.node_id == 0 then return ui_nodes.populate_root(parent, el)
	elseif type == 0 then return ui_nodes.populate_unused(parent, el)
	elseif type == 2 then
		local op = sfx.node_op(app.instrument, el.node_id)
		if op == 0 then return ui_nodes.populate_osc(parent, el)
		elseif op == 1 then return ui_nodes.populate_fm(parent, el)
		elseif op == 2 then return ui_nodes.populate_ring(parent, el)
		end
	elseif type == 8 then return ui_nodes.populate_filt(parent, el)
	elseif type == 9 then return ui_nodes.populate_echo(parent, el)
	elseif type == 10 then return ui_nodes.populate_shap(parent, el)
	end
	return ui_nodes.populate_unknown(parent, el)
end


-- Unused slot -------------------------------------------------------------------------------


function ui_nodes.populate_unused(parent, el)
	function el:draw()
		clip()
		local x, y = 19, 14
		pal(7, 57)
		sspr(63, 0, 0, 7, 7, x, y, x + (7 * 4), y + (7 * 4))
--		spr(62, x, y)
		pal(7, 7)
		if self.node_id == 7 then
			print("pfx6416", 52, 63, 22)
		end
	end
	return el
end


-- Root Synth Node ---------------------------------------------------------------------------


local instrument_name_field


function ui_nodes.populate_root(parent, el)
	local params = {
		[0] = { label = "vol", long_label = "volume", param = 0,
			min_val = 0, max_val = 64, init_val = 32, sensitivity = 0.25 },
		{ label = "pan", param = 1, min_val = -128, max_val = 127, },
		{ label = "tune", param = 2, min_val = -128, max_val = 127, },
		{ label = "bend", param = 3, min_val = -128, max_val = 127, },
	}
	for i = 0, #params do params[i].node_id = el.node_id end

	if el.large then
		ui_params.attach(el, 30, 84, params[0], { emphasis = true})
		ui_params.attach(el, 70, 84, params[1], { small = true })
		params[2].x, params[2].y = 112, 125
		ui_params.attach_mini(el, params[2])
		params[3].x, params[3].y = 112, 135
		ui_params.attach_mini(el, params[3])
--		ui_params.attach(el, 130, 84, params[2], { small = true })
--		ui_params.attach(el, 170, 84, params[3], { small = true })

		-- TODO: replace with a custom field
		-- also: add the same field to the mini version
		instrument_name_field = el:attach_text_editor{
			x = 116 + 4, y = 96,
			width = 72, height = 9,
			bgcol = 58, fgcol = 59, curcol = 2,
			block_scrolling = true, max_lines = 1,
			margin_top = 2,
			key_callback = {
				enter = function () 
					sfx.set_instrument_name(app.instrument, instrument_name_field:get_text()[1])
					instrument_name_field:set_keyboard_focus(false)
				end
			},
			update = function(self)
				-- update in realtime -- don't need to press enter to change
				if (instrument_name_field:has_keyboard_focus()) then
					sfx.set_instrument_name(app.instrument, instrument_name_field:get_text()[1])
				end
			end
		}
		instrument_name_field:set_text{sfx.instrument_name(app.instrument)}

		el:attach(ui_nodes.instrument_flag_toggle { x = 120, y = 114, label = "wide", flag = 0x02 })
		el:attach(ui_nodes.instrument_flag_toggle { x = 160, y = 114, label = "retrig", flag = 0x01 })
		ui_visual.attach_oscilloscope(el, 8, { x = 20, y = 12, width = 184, height = 68 })
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[3])
		--- slider.attach(el, { label = "p0", param = 4, node_id = el.node_id } )
		--- slider.attach(el, { label = "p1", param = 5, node_id = el.node_id } )
		el:attach(ui_nodes.instrument_flag_toggle { x = 5, y = 51, label = "wide", flag = 0x02 })
		el:attach(ui_nodes.instrument_flag_toggle { x = 45, y = 51, label = "retrig", flag = 0x01 })
	end
	function el:draw()
		rectfill(0, 0, self.width, 9, 7)
		ui_nodes.draw_corners(self)
		print("synthesizer", 4, 2, 22)
		-- Name label
		rrectfill(116, 84, 72 + 8, 9, 0, 5)
		print("name", 116 + 31, 84 + 2, 6)
	end
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
	return el
end


-- Oscillator -------------------------------------------------------------------


local wt_labels = { [0] = "wt0", "wt1", "wt2", "wt3" }
local wt_long_labels = { [0] = "wavetable 0", "wavetable 1", "wavetable 2", "wavetable 3" }
local osc_params = {
	[0] = { label = "vol", long_label = "volume", param = 0,
		min_val = 0, max_val = 64, init_val = 32, sensitivity = 0.25 },
	{ label = "pan", param = 1, min_val = -128, max_val = 127, },
	{ label = "tune", param = 2, min_val = -128, max_val = 127, },
	{ label = "bend", param = 3, min_val = -128, max_val = 127, },
	{ label = "", long_label = "wave", param = 4, min_val = 0, max_val = 255, },
	{ label = "phase", param = 5, min_val = -128, max_val = 127, },
}

function ui_nodes.populate_osc(parent, el)
	local params = unpod(pod(osc_params))
	-- closures are not copied by unpod/pod?
	params[4].onclick = function(self) ui_visual.open_wavetable(self) end
	params[4].onrelease = function(self) ui_visual.close() end
	params[5].onclick = params[4].onclick
	params[5].onrelease = params[4].onrelease
	
	for i = 0, #params do params[i].node_id = el.node_id end
	local flags, _, _, _ = sfx.node_param(app.instrument, el.node_id, 2)
	if flags & 0x03 == 0x02 then
		-- tune param in "multiply" relationship:
		-- change the min and max values
		params[2].min_val = 0
		params[2].max_val = 255
	end

	ui_nodes.attach_mute_toggle(el, { label = "osc", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 20, 16, params[0], { emphasis = true})
		ui_params.attach(el, 60, 16, params[1], { small = true })
		ui_params.attach(el, 20, 84, params[2], { small = true })
		ui_params.attach(el, 60, 84, params[3], { small = true })
		local wave = ui_params.attach(el, 130, 84, params[4], { emphasis = true })
		ui_visual.attach_wavetable(el, wave, { x = 114, y = 14, width = 104, height = 58 })
		ui_params.attach(el, 170, 84, params[5], { small = true })
		el:attach(ui.create_menu_button {
			x = 142, y = 72,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_long_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wavetable 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wavetable 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wavetable 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wavetable 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[3])
		ui_params.attach_mini(el, params[4])
		ui_params.attach_mini(el, params[5])
		el:attach(ui.create_menu_button {
			x = 2, y = 51,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wt 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wt 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wt 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wt 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	end
	
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
		
	function el:draw()
		rectfill(0, 0, self.width, 9, 17)
		ui_nodes.draw_corners(self)
	end
	
	return el
end


-- FM modulator -------------------------------------------------------------------


function ui_nodes.populate_fm(parent, el)
	local params = unpod(pod(osc_params))
	-- closures are not copied by unpod/pod?
	params[4].onclick = function(self) ui_visual.open_wavetable(self) end
	params[4].onrelease = function(self) ui_visual.close() end
	params[5].onclick = params[4].onclick
	params[5].onrelease = params[4].onrelease
	
	for i = 0, #params do params[i].node_id = el.node_id end
	local flags, _, _, _ = sfx.node_param(app.instrument, el.node_id, 2)
	if flags & 0x03 == 0x02 then
		-- tune param in "multiply" relationship:
		-- change the min and max values
		params[2].min_val = 0
		params[2].max_val = 255
	end

	ui_nodes.attach_mute_toggle(el, { label = "fm", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 20, 16, params[0], { emphasis = true})
		ui_params.attach(el, 60, 16, params[1], { small = true })
		ui_params.attach(el, 20, 84, params[2], { small = true })
		ui_params.attach(el, 60, 84, params[3], { small = true })
		local wave = ui_params.attach(el, 130, 84, params[4], { emphasis = true })
		ui_visual.attach_wavetable(el, wave, { x = 114, y = 14, width = 104, height = 58 })
		ui_params.attach(el, 170, 84, params[5], { small = true })
		el:attach(ui.create_menu_button {
			x = 142, y = 72,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_long_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wavetable 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wavetable 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wavetable 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wavetable 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[3])
		ui_params.attach_mini(el, params[4])
		ui_params.attach_mini(el, params[5])
		el:attach(ui.create_menu_button {
			x = 2, y = 51,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wt 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wt 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wt 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wt 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	end
	
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
		
	function el:draw()
		rectfill(0, 0, self.width, 9, 27)
		ui_nodes.draw_corners(self)
	end
	
	return el
end


-- Ring mod -------------------------------------------------------------------


function ui_nodes.populate_ring(parent, el)
	local params = unpod(pod(osc_params))
	-- closures are not copied by unpod/pod?
	params[4].onclick = function(self) ui_visual.open_wavetable(self) end
	params[4].onrelease = function(self) ui_visual.close() end
	params[5].onclick = params[4].onclick
	params[5].onrelease = params[4].onrelease
	
	for i = 0, #params do params[i].node_id = el.node_id end
	local flags, _, _, _ = sfx.node_param(app.instrument, el.node_id, 2)
	if flags & 0x03 == 0x02 then
		-- tune param in "multiply" relationship:
		-- change the min and max values
		params[2].min_val = 0
		params[2].max_val = 255
	end

	ui_nodes.attach_mute_toggle(el, { label = "ring", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 20, 16, params[0], { emphasis = true})
		ui_params.attach(el, 60, 16, params[1], { small = true })
		ui_params.attach(el, 20, 84, params[2], { small = true })
		ui_params.attach(el, 60, 84, params[3], { small = true })
		local wave = ui_params.attach(el, 130, 84, params[4], { emphasis = true })
		ui_visual.attach_wavetable(el, wave, { x = 114, y = 14, width = 104, height = 58 })
		ui_params.attach(el, 170, 84, params[5], { small = true })
		el:attach(ui.create_menu_button {
			x = 142, y = 72,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_long_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wavetable 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wavetable 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wavetable 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wavetable 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[3])
		ui_params.attach_mini(el, params[4])
		ui_params.attach_mini(el, params[5])
		el:attach(ui.create_menu_button {
			x = 2, y = 51,
			get_label = function()
				local wt = sfx.node_osc_wavetable(app.instrument, el.node_id)
				return wt_labels[wt] or "wt?"
			end,
			fg = 5,
			highlight = 15,
			items = {
				{ label = "wt 0", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 0) end },
				{ label = "wt 1", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 1) end },
				{ label = "wt 2", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 2) end },
				{ label = "wt 3", action = function() sfx.set_node_osc_wavetable(app.instrument, el.node_id, 3) end },
			}
		})
	end
	
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
		
	function el:draw()
		rectfill(0, 0, self.width, 9, 22)
		ui_nodes.draw_corners(self)
	end
	
	return el
end


-- Filter ----------------------------------------------------------------------


function ui_nodes.populate_filt(parent, el)
	local params = {
		[0] =
		{ label = "low", param = 0, min_val = 0, max_val = 255, },
		{ label = "high", param = 1, min_val = 0, max_val = 255, },
		{ label = "res", param = 2, min_val = 0, max_val = 255, },
	}
	for i = 0, #params do params[i].node_id = el.node_id end
	
	ui_nodes.attach_mute_toggle(el, { label = "filt", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 34, 50, params[0], {})
		ui_params.attach(el, 94, 50, params[2], {})
		ui_params.attach(el, 154, 50, params[1], {})
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[1])
	end
	function el:draw()
		rectfill(0, 0, self.width, 9, 14)
		ui_nodes.draw_corners(self)
	end
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
	return el
end


-- Delay --------------------------------------------------------------------------


function ui_nodes.populate_echo(parent, el)
	local params = {
		[0] =
		{ label = "delay", param = 0, min_val = 0, max_val = 255, },
		{ label = "vol", param = 1, min_val = 0, max_val = 255, },
	}
	for i = 0, #params do params[i].node_id = el.node_id end
	
	ui_nodes.attach_mute_toggle(el, { label = "echo", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 59, 84, params[0], {})
		ui_params.attach(el, 130, 84, params[1], {})
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
	end
	function el:draw()
		rectfill(0, 0, self.width, 9, 31)
		ui_nodes.draw_corners(self)
	end
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
	return el
end


-- Waveshaper ------------------------------------------------------------------


function ui_nodes.populate_shap(parent, el)
	local params = {
		[0] =
		{ label = "gain", param = 0, min_val = 0, max_val = 255, },
		{ label = "elbow", param = 1, min_val = 0, max_val = 255, },
		{ label = "cut", param = 2, min_val = 0, max_val = 255, },
		{ label = "mix", param = 3, min_val = 0, max_val = 64, sensitivity = 0.25 },
	}
	for i = 0, #params do params[i].node_id = el.node_id end
	
	ui_nodes.attach_mute_toggle(el, { label = "shap", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	if el.large then
		ui_params.attach(el, 20, 84, params[0], {})
		ui_params.attach(el, 60, 84, params[3], { small = true })
		ui_params.attach(el, 130, 84, params[2], {})
		ui_params.attach(el, 170, 84, params[1], {})
		local oscillo_id = sfx.nodes[el.node_id].parent.id
		ui_visual.attach_oscilloscope(el, 8, { x = 11, y = 16, width = 92, height = 60, node_id = oscillo_id })
	else
		ui_params.attach_mini(el, params[0])
		ui_params.attach_mini(el, params[1])
		ui_params.attach_mini(el, params[2])
		ui_params.attach_mini(el, params[3])
	end
	function el:draw()
		rectfill(0, 0, self.width, 9, 9)
		ui_nodes.draw_corners(self)
	end
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
	return el
end


-- Unknown --------------------------------------------------------------------------


function ui_nodes.populate_unknown(parent, el)
	local params = {
		[0] =
		{ label = "p0", param = 0, min_val = 0, max_val = 255, },
		{ label = "p1", param = 1, min_val = 0, max_val = 255, },
		{ label = "p2", param = 2, min_val = 0, max_val = 255, },
		{ label = "p3", param = 3, min_val = 0, max_val = 255, },
		{ label = "p4", param = 4, min_val = 0, max_val = 255, },
		{ label = "p5", param = 5, min_val = 0, max_val = 255, },
	}
	for i = 0, #params do params[i].node_id = el.node_id end
	
	ui_nodes.attach_mute_toggle(el, { label = "???", node_id = el.node_id })
	ui_nodes.attach_close_button(el, { node_id = el.node_id })
	ui_params.attach_mini(el, params[0])
	ui_params.attach_mini(el, params[1])
	ui_params.attach_mini(el, params[2])
	ui_params.attach_mini(el, params[3])
	ui_params.attach_mini(el, params[4])
	ui_params.attach_mini(el, params[5])
	function el:draw()
		rectfill(0, 0, self.width, self.height, 30)
		ui_nodes.draw_corners(self)
	end
	function el:click() return true end
	function el:doubleclick() app.node = self.node_id; app.refresh_gui = true end
	return el
end


-------------------------------------------------------------------------------------------------


function ui_nodes.instrument_flag_toggle(el)
	el.width = el.width or 35
	el.height = el.height or 9
	el.label = el.label or "---"
	el.cursor = "pointer"
	
	function el:draw()
		palt(59, true)
		pal(2, 0)
		pal(17, 18)
		if sfx.instrument_flag(app.instrument, el.flag) then
			spr(33, 0, 1)
		else
			spr(32, 0, 1)
		end
		pal(17, 17)
		pal(2, 2)
		palt(59, false)
		print(el.label, 10, 2, 5)
	end
	
	function el:tap()
		sfx.toggle_instrument_flag(app.instrument, el.flag)
	end
	
	return el
end


------------------------------------------------------------------------------------------------	


function ui_nodes.draw_corners(el)
--[[
	if app.node and app.node == el.node_id then 
		clip()
		rect(-1, -1, el.width, el.height, 24)
		pset(-1, -1, app.editor_bg)
		pset(el.width, -1, app.editor_bg)
		pset(-1, el.height, app.editor_bg)
		pset(el.width, el.height, app.editor_bg)
		col = 24
	end
--]]
	pset(0, 0, 6)
	pset(el.width - 1, 0, 6)
	pset(0, 8, 6)
	pset(el.width - 1, 8, 6)
end


-- Title bar widgets -------------------------------------------------------------


function ui_nodes.attach_mute_toggle(parent, el)
	el.x = 1
	el.y = 1
	el.width = 3 + 4 * #(el.label .. " " .. el.node_id) + 3
	el.height = 9
	el.cursor = "pointer"
	parent:attach(el)
	el.muted = (sfx.node_flags(app.instrument, el.node_id) & 0x2) > 0
	function el:draw()
		local label = self.label .. " " .. self.node_id
		print(label, 3, 1, 63)
		if self.muted then
			line(1, 3, 3 + 4 * #label, 3, 24)
		end
	end
	function el:click()
		return true -- don't pass to panel to avoid selection
	end
	function el:tap()
		self.muted = not self.muted
		local flags = sfx.node_flags(app.instrument, self.node_id)
		if self.muted then
			flags |= 0x2
		else
			flags &= ~0x2
		end
		sfx.set_node_flags(app.instrument, self.node_id, flags)
	end
	return el
end


function ui_nodes.attach_close_button(parent, el)
	el.x = parent.width - 10
	el.y = 2
	el.width = 12
	el.height = 9
	el.cursor = "pointer"
	parent:attach(el)
	function el:draw()
		pal(7, 63)
		spr(36, 0, 0)
		pal(7, 7)
	end
	function el:click()
		return true -- don't pass to panel to avoid selection
	end
	function el:tap()
		if app.node then
			if app.node == self.node_id then
				if #(sfx.nodes[app.node].children) > 0 then
					app.node = sfx.nodes[app.node].children[1].id
				else
					app.node = sfx.nodes[app.node].parent.id
				end
			end
		end
		sfx.delete_node(app.instrument, self.node_id)
		if app.node and app.node > self.node_id then
			app.node = max(0, self.node_id - 1)
		end
		app.refresh_gui = true
	end
	return el
end


return ui_nodes
:: src/ui_notegrid.lua
--[[pod_format="raw",created="2026-01-26 13:53:28",modified="2026-01-27 08:27:46",revision=1800]]
local app = require "src/app.lua"
local selection = require "src/selection.lua"
local sfx = require "src/sfx.lua"


local ui_notegrid = {}


local height_header <const> = 13


local note_names <const> = {"c","c\|f+","d","d\|f+","e","f","f\|f+","g","g\|f+","a","a\|f+", "b"}


----------------------------------------------------------------------------------------------------
-- Track Header
----------------------------------------------------------------------------------------------------


function ui_notegrid.attach_header(parent, el)
	el.width = app.width_column
	el.height = height_header
	el.cursor = "pointer"
	parent:attach(el)
	
	function el:draw()
		local pattern_is_playing <const> = stat(464) != 0
			and stat(466) == app.pattern
		local track <const> = sfx.pattern_track(app.pattern, self.channel)
		-- Header
		rrectfill(0, 0, self.width, height_header, 0, 6)
		ui.print_centered(string.format("%03d", track), self.width // 2, 4, 5)
		local is_muted <const> = sfx.channel_is_muted(app.pattern, self.channel)
		spr(is_muted and 46 or 47, self.width // 2 - 18, 3)
		pal(7, 58)
		spr(37, self.width // 2 + 11, 4)
		pal(7, 7)
		local xh <const> = self.width - 1
		local yh <const> = height_header - 1
		line(0, 0, xh, 0, 57)
		line(0, yh, xh, yh, 58)
		if self.channel == 0 then
			line(0, 0, 0, yh - 1, 57)
		else
			line(0, 2, 0, yh - 2, 57)
		end
		if self.channel == 7 then
			line(xh, 0, xh, yh - 1, 58)
		else
			line(xh, 2, xh, yh - 2, 58)
		end
	end
	
	function el:mousewheel(msg)
--		self.start -= msg.wheel_y
--		self.start = max(0, self.start)
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Note Grid
----------------------------------------------------------------------------------------------------


local w_note <const> = 12
local w_octave <const> = 6
local w_inst_hi <const> = 6
local w_inst_lo <const> = 5
local w_vol_hi <const> = 6
local w_vol_lo <const> = 5
local w_fx <const> = 6
local w_fx_hi <const> = 5
local w_fx_lo <const> = 5


local x_note <const> = 0
local x_octave <const> = w_note
local x_inst_hi <const> = w_note + w_octave
local x_inst_lo <const> = w_note + w_octave + w_inst_hi
local x_vol_hi <const> = w_note + w_octave + w_inst_hi + w_inst_lo
local x_vol_lo <const> = w_note + w_octave + w_inst_hi + w_inst_lo + w_vol_hi
local x_fx <const> = w_note + w_octave + w_inst_hi + w_inst_lo + w_vol_hi + w_vol_lo
local x_fx_hi <const> = w_note + w_octave + w_inst_hi + w_inst_lo + w_vol_hi + w_vol_lo + w_fx
local x_fx_lo <const> = w_note + w_octave + w_inst_hi + w_inst_lo + w_vol_hi + w_vol_lo + w_fx + w_fx_hi


function ui_notegrid.attach(parent, el)
	el.width = app.width_column
	el.height = parent.height
	el.length_beat = 4
	el.length_bar = 4 * el.length_beat
	el.start = 0
	parent:attach(el)
	
	function el:draw()
		if sfx.channel_is_muted(app.pattern, self.channel) then
			return
		end
		local pattern_is_playing <const> = stat(464) != 0
			and stat(466) == app.pattern
		local track <const> = sfx.pattern_track(app.pattern, self.channel)
		-- Notes
		local start <const> = self.start
		local nb_rows = (self.height) // app.height_row
		for row = 0, nb_rows do
			local x <const> = 0
			local y <const> = row * app.height_row
			local step <const> = start + row
			local step_is_playing <const> = stat(400 + self.channel, 9) == row
			if step > 63 then
				rrectfill(x, y, app.width_column, app.height_row, 0, 32)
				break -- TODO
			end
			if step_is_playing then
				rrectfill(x, y, app.width_column, app.height_row, 0, 36)
--			elseif false and selection.is_step_cursor(self.channel, step) then
--				rrectfill(x, y, app.width_column, app.height_row, 0, 36)
			elseif step % self.length_bar == 0 then
				rrectfill(x, y, app.width_column, app.height_row, 0, 35)
			elseif step % self.length_beat == 0 then
				rrectfill(x, y, app.width_column, app.height_row, 0, 34)
			else
				rrectfill(x, y, app.width_column, app.height_row, 0, 33)
			end
			local freq = sfx.track_pitch(track, step)
			local inst = sfx.track_instrument(track, step)
			local vol  = sfx.track_volume(track, step)
			local fx   = sfx.track_fx(track, step)
			local fxp0  = sfx.track_fx_param0(track, step)
			local fxp1  = sfx.track_fx_param1(track, step)
			-- Note and Octave
			if selection.is_selected(self.channel, step, selection.note) then
				rrectfill(x_note, y, w_note, app.height_row, 0, 37)
			end
			if selection.is_selected(self.channel, step, selection.octave) then
				rrectfill(x_octave, y, w_octave, app.height_row, 0, 37)
			end
			if freq != 0xff then
				local note = freq % 12
				local is_sharp = (note == 1) or (note == 3) or (note == 6)
					or (note == 8) or (note == 10)
				print(note_names[note+1], x + 4, y + 2, 43)
				if (freq \ 12) <= 9 then
					print("\014" .. tostr(freq \ 12), x + 13, y + 2, 42)
				else
					print("\014?", x + 13, y + 2, 58)
				end
			else
				print("\014\|e.", x + 4, y + 2, 40)
				print("\014\|e.", x + 13, y + 2, 40)
			end
			-- Instrument
			if selection.is_selected(self.channel, step, selection.inst_hi) then
				rrectfill(x_inst_hi, y, w_inst_hi, app.height_row, 0, 37)
			end
			if selection.is_selected(self.channel, step, selection.inst_lo) then
				rrectfill(x_inst_lo - 1, y, w_inst_lo + 1, app.height_row, 0, 37)
			end
			if inst != 0xff then
				print("\014" .. string.format("%02x", inst), x + 20, y + 2, 45)
			else
				print("\014\|e..", x + 20, y + 2, 44)
			end
			-- Volume
			if selection.is_selected(self.channel, step, selection.vol_hi) then
				rrectfill(x_vol_hi, y, w_vol_hi, app.height_row, 0, 37)
			end
			if selection.is_selected(self.channel, step, selection.vol_lo) then
				rrectfill(x_vol_lo - 1, y, w_vol_lo + 1, app.height_row, 0, 37)
			end
			if vol != 0xff then
				print("\014" .. string.format("%02x", vol), x + 31, y + 2, 47)
			else
				print("\014\|e..", x + 31, y + 2, 46)
			end
			-- FX
			if selection.is_selected(self.channel, step, selection.fx) then
				rrectfill(x_fx, y, w_fx, app.height_row, 0, 37)
			end
			if selection.is_selected(self.channel, step, selection.fx_hi) then
				rrectfill(x_fx_hi - 1, y, w_fx_hi, app.height_row, 0, 37)
			end
			if selection.is_selected(self.channel, step, selection.fx_lo) then
				rrectfill(x_fx_lo - 2, y, w_fx_lo + 1, app.height_row, 0, 37)
			end
			if fx != 0x0 then
				print("\014" .. chr(fx), x + 42, y + 2, 49)
				print("\014" .. string.format("%x", fxp0)
					.. string.format("%x", fxp1), x + 46, y + 2, 48)
			else
				print("\014\|e...", x + 42, y + 2, 48)
			end
		end
		-- Channel Divider
		line(app.width_column - 1, 0, app.width_column - 1, self.height, 32)
	end
	
	function el:click(msg)
		local row <const> = msg.my // app.height_row
		local mask = 0x00
		if msg.mx < x_octave then
			selection.set_cursor(self.channel, self.start + row, selection.note)
		elseif msg.mx < x_inst_hi then
			selection.set_cursor(self.channel, self.start + row, selection.octave)
		elseif msg.mx < x_inst_lo then
			selection.set_cursor(self.channel, self.start + row, selection.inst_hi)
		elseif msg.mx < x_vol_hi then
			selection.set_cursor(self.channel, self.start + row, selection.inst_lo)
		elseif msg.mx < x_vol_lo then
			selection.set_cursor(self.channel, self.start + row, selection.vol_hi)
		elseif msg.mx < x_fx then
			selection.set_cursor(self.channel, self.start + row, selection.vol_lo)
		elseif msg.mx < x_fx_hi then
			selection.set_cursor(self.channel, self.start + row, selection.fx)
		elseif msg.mx < x_fx_lo then
			selection.set_cursor(self.channel, self.start + row, selection.fx_hi)
		else
			selection.set_cursor(self.channel, self.start + row, selection.fx_lo)
		end
	end
	
	function el:mousewheel(msg)
		self.parent:scroll_channels(msg.wheel_y)
--		self.start -= msg.wheel_y
--		self.start = max(0, self.start)
	end
	
	return el
end


return ui_notegrid
:: src/ui_params.lua
--[[pod_format="raw",created="2024-04-20 11:45:24",modified="2026-01-27 08:27:46",revision=6975]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_menus = require "src/ui_menus.lua"


local ui_params = {}


-- Field ----------------------------------------------------------------------


local function attach_field(parent, el)
	el.width = 4 * 4 + 3
	el.height = 7
	el.cursor = get_spr(50)
	parent:attach(el)
	
	function el:draw()
		rectfill(0, 0, self.width - 1, self.height - 1, 58)
		if (not self.visible) or self.visible(self) then
			local val = self:get()
			local fg = self.fg or 59
			local str
			if self.to_str then
				str = self:to_str(val)
			else
				str = tostr(val)
			end
			if #str > 4 then
				print(str, 0, 1, self.dragged and 7 or fg)
			elseif self.centered then
				ui.print_centered(str, 10, 1, self.dragged and 7 or fg)
			else
				print(str, 2 + 4*4 - 4*#str, 1, self.dragged and 7 or fg)
			end
		end
	end
	

	function el:hover()
		if (not self.visible) or self.visible(self) then
			self.cursor = get_spr(50)
		else
			self.cursor = 1
		end
	end
	

	function el:click(msg)
		if self.visible and (not self.visible(self)) then
			return true
		end
		self.cursor = 0
		self.dragged = true
		ui.mouselock(1.0, true)
		if self.onclick then
			self:onclick(msg)
		elseif self.parent.onclick then
			self.parent:onclick(msg)
		end
		return true
	end
	
	function el:doubleclick()
		return true
	end
	

	function el:drag(msg)
		local delta = ui.mouselock(1.0, true)
		local old = self:get()
		local new = old - delta
		self:set(new)
	end

	
	function el:release()
		self.cursor = get_spr(50)
		self.dragged = false
		ui.mouseunlock()
		self.up_barrier = nil
		self.down_barrier = nil
		if self.onrelease then
			self:onrelease()
		elseif self.parent.onrelease then
			self.parent:onrelease()
		end
	end
	

	return el
end


local function attach_relationship(parent, el)
	el.width, el.height = 7, 7
	el.cursor = "pointer"
	parent:attach(el)
	function el:draw()
		local flags, _, _, _ = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
		---rectfill(0, 0, self.width - 1, self.height - 1, 58)
		if flags & 0x03 == 0x01 then
			print("\^:2070200000000000", -1, 2, 60)
		elseif flags & 0x03 == 0x02 then
			print("\^:5020500000000000", -1, 2, 60)
		elseif flags & 0x03 > 0 then
			print("?", 3, 1, 60)
		else
			pset(4, 3, 58)
		end
	end
	function el:tap()
		ui_menus.open_relationship(self)
	end
	return el
end


local function attach_multiplier(parent, el)
	el.width, el.height = 7, 7
	el.cursor = "pointer"
	parent:attach(el)
	function el:draw()
		local flags, _, _, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
		--rectfill(0, 0, self.width - 1, self.height - 1, 58)
		if self.mini then
			if (env & 0xc0 > 0) then
				print("!", 0, 1, 24)
			else
				pset(1, 3, 58)
			end
			return
		end
		if (env & 0xc0 > 0) then
			str2 = (env & 0x20 == 0) and 
				"\^:5020500000000000" or  -- *
				"\^:4020100000000000"     -- /
			if (env & 0xc0 == 0x40) str2 = str2 .. "\-c\^:5070400000000000" -- 4
			if (env & 0xc0 == 0x80) str2 = str2 .. "\^:1372770000000000" -- 16
			if (env & 0xc0 == 0xc0) str2 = str2 .. "\^:5177470000000000" -- 64
			clip()
			print(str2, -4, 2, 24)
		else
			pset(2, 3, 58)
		end
	end
	function el:tap()
		ui_menus.open_multiplier(self)
	end
	return el
end


local function attach_envelope(parent, el)
	el.width, el.height = 7, 7
	el.cursor = "pointer"
	parent:attach(el)
	function el:draw()
		---rectfill(0, 0, self.width - 1, self.height - 1, 7)
		local flags, _, _, env = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
		if flags & 0x04 > 0 then
			local fg, bg = 7, 18
			if flags & 0x08 > 0 then
				fg, bg = bg, fg
			end
			line(1, 0, self.width - 1 - 1, 0, bg)
			rectfill(0, 1, self.width - 1 - 0, self.height - 1 - 1, bg)
			line(1, self.height - 1 - 0, self.width - 1 - 1, self.height - 1 - 0, bg)
			print(string.format("%x", env & 0x0f), 2, 1, fg)
		elseif flags & 0x10 > 0 then
			line(1, 0, self.width - 1 - 1, 0, 30)
			rectfill(0, 1, self.width - 1 - 0, self.height - 1 - 1, 30)
			line(1, self.height - 1 - 0, self.width - 1 - 1, self.height - 1 - 0, 30)
			print("r", 2, 1, 7)
		else
			line(2, 1, self.width - 1 - 2, 1, 58)
			rectfill(1, 2, self.width - 1 - 1, self.height - 1 - 2, 58)
			line(2, self.height - 1 - 1, self.width - 1 - 2, self.height - 1 - 1, 58)
		end
	end
	function el:tap()
		ui_menus.open_envelope(self)
	end
	return el
end


-- Getters and setters ------------------------------------------------------


local function get_val1(self)
	local _, val1, _, _ = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	if (self.parent.max_val < 128) then
		if (val1 >= 128) val1 -= 256
	end
	return val1
end


local function set_val1(self, val)
	val = mid(self.parent.min_val, val, self.parent.max_val)
	sfx.set_node_param_val1(app.instrument, self.parent.node_id, self.parent.param, val)
end


local function get_val0(self)
	local _, _, val0, _ = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	if (self.parent.max_val < 128) then
		if (val0 >= 128) val0 -= 256
	end
	return val0
end


local function set_val0(self, val)
	val = mid(self.parent.min_val, val, self.parent.max_val)
	sfx.set_node_param_val0(app.instrument, self.parent.node_id, self.parent.param, val)
end


local function has_env(self)
	local flags, _, _, _ = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	return flags & (0x4 | 0x10) > 0
end


local function smart_str(self, val)
	local flags, _, _, _ = sfx.node_param(app.instrument, self.parent.node_id, self.parent.param)
	local node_type = sfx.node_type(app.instrument, self.parent.node_id)
	if node_type == 0x02 and self.parent.param == 0x02 and (flags & 0x03 == 0x02) then
		local num = 1 + val % 16
		local den = 1 + val \ 16
		return num .. "/" .. den
	end
	return tostr(val)
end


-- The widget -----------------------------------------------------------------


function ui_params.attach(parent, x, y, el, style)
	el.x, el.y = x, y
	el.small = small
	el.width, el.height = 35, 58
	el.small = style.small
	el.emphasis = style.emphasis
	parent:attach(el)
	el:attach(ui.create_knob {
		x = 2, y = 10,
		small = style.small,
		get = get_val1,
		set = set_val1,
		has_secondary = has_env,
		get_secondary = get_val0,
		set_secondary = set_val0,
	})
	attach_relationship(
		el,
		{
			x = 0, y = 41,
		}
	)
	attach_field(
		el,
		{
			x = 8, y = 41,
			centered = true,
			get = get_val1,
			set = set_val1,
			to_str = smart_str,
		}
	)
	attach_multiplier(
		el,
		{
			x = 28, y = 41,
		}
	)
	attach_field(
		el,
		{
			x = 8, y = 51,
			fg = 18, centered = true,
			visible = has_env,
			get = get_val0,
			set = set_val0,
			to_str = smart_str,
		}
	)
	attach_envelope(
		el,
		{
			x = 28, y = 51,
		}
	)
	
	function el:draw()
		---rectfill(0, 0, self.width - 1, self.height - 1, 7)
		if self.emphasis then
			rectfill(0, 0, self.width - 1, 8, 5)
		else
			rectfill(0, 0, self.width - 1, 8, 5)
		end
		ui.print_centered(
			el.long_label or el.label,
			(self.width \ 2) + 1, 2,
			self.emphasis and 6 or 6
		)
	end	
	
	function el:click() return true end
	function el:doubleclick() return true end
	
	return el
end


-- Mini widget ---------------------------------------------------------------------


function ui_params.attach_mini(parent, el)
	el.x = el.x or 0
	el.y = el.y or (12 + 10 * el.param)
	el.width = parent.width
	el.height = 10
	parent:attach(el)
	attach_relationship(
		el,
		{
			x = 24, y = 0,
		}
	)
	attach_field(
		el,
		{
			x = 24 + 7, y = 0,
			get = get_val1,
			set = set_val1,
			to_str = smart_str,
		}
	)
	attach_multiplier(
		el,
		{
			x = 24 + 7 + 20, y = 0,
			mini = true,
		}
	)
	attach_field(
		el,
		{
			x = 24 + 7 + 20 + 4, y = 0,
			fg = 18,
			visible = has_env,
			get = get_val0,
			set = set_val0,
			to_str = smart_str,
		}
	)
	attach_envelope(
		el,
		{
			x = 24 + 7 + 20 + 4 + 20, y = 0,
		}
	)
	function el:draw()
		print(self.label, 24 - (4 * #self.label), 1, 5)
		---print(self.label, 2, 1, 5)
	end
	
	function el:click() return true end
	function el:doubleclick() return true end
end


return ui_params
:: src/ui_routing.lua
--[[pod_format="raw",created="2024-04-13 06:33:13",modified="2026-01-27 08:27:46",revision=6600]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"


local ui_routing = {}


-- Locals ------------------------------------------------------------------------


local node_width = 26
local node_height = 16 -- TODO: if 7 vertical nodes, lower to 14
local node_gap = 14


local placement_buttons = {}


local function attach_placement_button(el)
	el.x -= 3
	el.y -= 3
	el.width = 7 -- TODO
	el.height = 7
	el.cursor = "pointer"
	app.routing_widget:attach(el)
	add(placement_buttons, el)
	function el:draw()
		local x, y = 3, 3
		rectfill(
			x - 2, y - 3, 
			x + 2, y + 3,
			24
		)
		rectfill(
			x - 3, y - 2,
			x + 3, y + 2,
			24
		)
		print("+", x - 1, y - 2, 7)
	end
	function el:click()
		return true -- (ed_inst click() refreshes gui)
	end
	function el:tap()
		ui_routing.clear_placement_buttons()
		local new_node = sfx.add_node(app.instrument, self.parent_id,
			self.new_node_type, self.new_node_op, self.target_id, self.child_id)
		if app.node then
			app.node = new_node
		end
		app.refresh_gui = true
	end
	return el
end


local function attach_insert_between_parent(new_node_type, new_node_op, node, pos)
	if (node == sfx.root) return
	if (new_node_type >= 8) return
	if new_node_type == 2 and new_node_op > 0 then
		if (node.parent == sfx.root) return
	end
	attach_placement_button {
		parent_id = node.parent.id, target_id = node.id, child_id = node.id,
		new_node_type = new_node_type, new_node_op = new_node_op,
		x = pos.x - 2, y = pos.y + 4,
	}
end


local function attach_insert_top_child(new_node_type, new_node_op, node, pos)
	if new_node_type >= 8 then
		if (node == sfx.root) return
		if (node.type >= 8) return
	end
	if #node.children == 0 then
		-- add only child
		attach_placement_button {
			parent_id = node.id, target_id = node.id + 1,
			new_node_type = new_node_type, new_node_op = new_node_op,
			x = pos.x + node_width + 2, y = pos.y + 4,
		}
	else
		-- add above first child
		attach_placement_button {
			parent_id = node.id, target_id = node.id + 1,
			new_node_type = new_node_type, new_node_op = new_node_op,
			x = pos.x + node_width + node_gap + node_width \ 2, y = pos.y - 0,
		}
	end
end


local function attach_insert_sibling_below(new_node_type, new_node_op, node, pos)
	if (node == sfx.root) return
	attach_placement_button {
		parent_id = node.parent.id, target_id = node:last_child().id + 1,
		new_node_type = new_node_type, new_node_op = new_node_op,
		x = pos.x + node_width \ 2, y = pos.y + 8
	}
end


local function start_new_node(new_node_type, new_node_op)
--	app.node = nil
--	app.refresh_gui = true
	for n = 0, 7 do
		local node = sfx.nodes[n]
		local pos = node.position
		if (not pos) break -- TODO: when does this occur?
		-- Coordinates from logical position
		pos.x = 4 + pos.column * (node_width + node_gap)
		pos.y = 4 + pos.row * node_height
		local ppos = node.parent.position
		ppos.x = 4 + ppos.column * (node_width + node_gap)
		ppos.y = 4 + ppos.row * node_height
		
		--[[
		attach_insert_between_parent(new_node_type, new_node_op, node, pos)
		attach_insert_top_child(new_node_type, new_node_op, node, pos)
		attach_insert_sibling_below(new_node_type, new_node_op, node, pos)
		--]]
		---[[
		if new_node_type == 2 and new_node_op > 0 then
			-- Modulators --
			if node != sfx.root and node.parent != sfx.root then
				-- insert between parent
				attach_placement_button {
					parent_id = node.parent.id, target_id = node.id, child_id = node.id,
					new_node_type = new_node_type, new_node_op = new_node_op,
					x = pos.x - 2, y = pos.y + 4,
				}
			end
			if node.type == 2 and node.op == 0 then
				if #node.children == 0 then
					-- add only child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + 2, y = pos.y + 4,
					}
				elseif node.children[1].type != 2 or node.children[1].op == 0 then
					-- add above first child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + node_gap + node_width \ 2, y = pos.y - 0,
					}
				end
			end
			
		elseif new_node_type == 2 then
			-- Oscillators --
			if node != sfx.root and not (node.type == 2 and node.op > 0) then
				-- insert between parent
				attach_placement_button {
					parent_id = node.parent.id, target_id = node.id, child_id = node.id,
					new_node_type = new_node_type, new_node_op = new_node_op,
					x = pos.x - 2, y = pos.y + 4,
				}
			end
			if node != sfx.root then
				-- add sibling below
				attach_placement_button {
					parent_id = node.parent.id, target_id = node:last_child().id + 1,
					new_node_type = new_node_type, new_node_op = new_node_op,
					x = pos.x + node_width \ 2, y = pos.y + 8
				}
			end
			if node.type == 2 or node == sfx.root then
				if #node.children == 0 then
					-- add only child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + 2, y = pos.y + 4,
					}
				elseif node.children[1].type != 2 	or node.children[1].op == 0 then
					-- add above first child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + node_gap + node_width \ 2, y = pos.y - 0,
					}
				end
			end
			
		else
			-- Effects --
			if node != sfx.root then
				-- add sibling below
				attach_placement_button {
					parent_id = node.parent.id, target_id = node:last_child().id + 1,
					new_node_type = new_node_type, new_node_op = new_node_op,
					x = pos.x + node_width \ 2, y = pos.y + 8
				}
			end
			if 	node.type == 2 then
				if #node.children == 0 then
					-- add only child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + 2, y = pos.y + 4,
					}
				elseif node.children[1].type != 2 or node.children[1].op == 0 then
					-- add above first child
					attach_placement_button {
						parent_id = node.id, target_id = node.id + 1,
						new_node_type = new_node_type, new_node_op = new_node_op,
						x = pos.x + node_width + node_gap + node_width \ 2, y = pos.y - 0,
					}
				end
			end
		end
		--]]
	end
end


function ui_routing.clear_placement_buttons()
	local cleared_something = #placement_buttons > 0
	for i = 1, #placement_buttons do
		placement_buttons[i]:detach()
	end
	placement_buttons = {}
	return cleared_something
end


-- Routing display -------------------------------------------------------------


function ui_routing.attach(parent, el)
	el.width = 366
	el.height = 97
	parent:attach(el)
	ui_routing.attach_node_chooser(el, { x = el.width - 87, y = 56 })
	
	function el:draw()
		rectfill(0, 0, self.width, self.height, 59)
--		pset(0, 0, 6)
--		pset(self.width - 1, 0, 6)
--		pset(0, self.height - 1, 6)
--		pset(self.width - 1, self.height - 1, 6)
		-- Overview and Wavetable buttons
		for i, label in ipairs({"all","wt 0","wt 1","wt 2","wt 3"}) do
			local bg = (i == 1) and 7 or 58
			local fg = (i == 1) and 22 or 5
			rrectfill(4, 4 + i * node_height, node_width + 1, 9, 0, bg)
			print(label, 10 + (i==1 and 2 or 0), 4 + i * node_height + 2, fg)
			if app.node then
				-- nothing to do
			elseif
				(i == 1 and not app.wt)
				or (i == 2 and app.wt == 0)
				or (i == 3 and app.wt == 1)
				or (i == 4 and app.wt == 2)
				or (i == 5 and app.wt == 3)
			then
				rect(4 - 1, 4 + i * node_height - 1, 4 + node_width + 1, 4 + i * node_height + 8 + 1, 0)
				rect(4 - 2, 4 + i * node_height - 2, 4 + node_width + 2, 4 + i * node_height + 8 + 2, 24)
			end
		end
		-- Routing graph
		for n = 0, 7 do
			local node = sfx.nodes[n]
			local pos = node.position
			if (not pos) break -- TODO: when does this occur?
			-- Coordinates from logical position
			pos.x = 4 + pos.column * (node_width + node_gap)
			pos.y = 4 + pos.row * node_height
			local ppos = node.parent.position
			ppos.x = 4 + ppos.column * (node_width + node_gap)
			ppos.y = 4 + ppos.row * node_height

			if app.node == n then
				rect(pos.x - 2, pos.y - 2, pos.x + node_width + 2, pos.y + 8 + 2, 24)
				rect(pos.x - 1, pos.y - 1, pos.x + node_width + 1, pos.y + 8 + 1, 0)
			end
			
			if node.type >= 8 and node.older_sibling then
				-- Horizontal bracket
				local col = 6
				local x = pos.x + node_width \ 2
				local orig = node.older_sibling
				local depth = 0
				while #orig.children > 0 and depth < 8 do
					orig = orig.children[#orig.children]
					depth += 1
				end
				local orig_x = orig.position.x + node_width
				line(x - (node_width \ 2) - 3, pos.y - 4, x - (node_width \ 2) - 3 - 2, pos.y - 6, col)
				line(x - 3, pos.y - 4, x - (node_width \ 2) - 3, pos.y - 4, col)
				line(x, pos.y - 2, x - 2, pos.y - 4, col)
				line(x, pos.y - 2, x + 2, pos.y - 4, col)
				line(x + 3, pos.y - 4, orig_x + 3, pos.y - 4, col)
				line(orig_x + 3, pos.y - 4, orig_x + 3 + 2, pos.y - 6, col)
			elseif node != sfx.root then
				-- Arrow
				line(
					ppos.x + node_width + 7, ppos.y + 4,
					ppos.x + node_width + 1, ppos.y + 4,
					7
				)
				line(
					pos.x - 7, pos.y + 4,
					ppos.x + node_width + 7, ppos.y + 4,
					7
				)
				line(
					pos.x - 1, pos.y + 4,
					pos.x - 7, pos.y + 4,
					7
				)
				line(pos.x - 2, pos.y + 3, pos.x - 2, pos.y + 5, 7)
				line(pos.x - 3, pos.y + 2, pos.x - 3, pos.y + 6, 7)
			end
			
			-- Node boxes
			local str = "??? "
			local fg = 63
			local bg = 30
			if node == sfx.root then str = "inst"; fg = 22; bg = 7
			elseif node.type == 2 then
				if node.op == 0 then str = "osc " .. n; bg = 17
				elseif node.op == 1 then str = "fm " .. n; bg = 27
				elseif node.op == 2 then str = "ring " .. n; bg = 22
				end
			elseif node.type == 8 then str = "filt " .. n; bg = 14
			elseif node.type == 9 then str = "echo " .. n; bg = 31
			elseif node.type == 10 then str = "shap " .. n; bg = 9
			end
			rectfill(pos.x, pos.y, pos.x + node_width, pos.y + 8, bg)
			ui.print_centered(str, pos.x + (node_width \ 2) + 1, pos.y + 2, fg)
		end
		clip()
		line()
		line(1, -1, 58)
		line(self.width - 2, -1, 58)
		line(self.width, 1, 58)
		line(self.width, self.height - 2, 57)
		line(self.width - 2, self.height, 57)
		line(1, self.height, 57)
		line(-1, self.height - 2, 57)
		line(-1, 1, 58)
		line(1, -1, 58)
		clip(self.sx, self.sy, self.width - 1, self.height - 1)
	end
	
	function el:hover(msg)
		self.cursor = 1
		if (#placement_buttons != 0) return
		for n = 0, 7 do
			local node = sfx.nodes[n]
			local pos = node.position
			if
				pos and pos.x and pos.x <= msg.mx and msg.mx <= pos.x + node_width
				and pos.y <= msg.my and msg.my <= pos.y + 10
			then
				self.cursor = "pointer"
			end
		end
		if msg.mx <= node_width + 4 then
			if (msg.my >= 4 + node_height and msg.my <= 4 + node_height + 10)
				or (msg.my >= 4 + 2 * node_height and msg.my <= 4 + 2 * node_height + 10)
				or (msg.my >= 4 + 3 * node_height and msg.my <= 4 + 3 * node_height + 10)
				or (msg.my >= 4 + 4 * node_height and msg.my <= 4 + 4 * node_height + 10)
				or (msg.my >= 4 + 5 * node_height and msg.my <= 4 + 5 * node_height + 10)
			then
				self.cursor = "pointer"
			end
		end
	end

	function el:click(msg)
		if #placement_buttons != 0 then
			ui_routing.clear_placement_buttons()
			return
		end
		for n = 0, 7 do
			local node = sfx.nodes[n]
			local pos = node.position
			if
				pos and pos.x and pos.x <= msg.mx and msg.mx <= pos.x + node_width
				and pos.y <= msg.my and msg.my <= pos.y + 10
			then
				app.node = n
				app.refresh_gui = true
				return true
			end
		end
		if msg.mx <= node_width + 4 then
			if msg.my >= 4 + node_height and msg.my <= 4 + node_height + 10 then
				app.node = nil
				app.wt = nil
				app.refresh_gui = true
				return true
			elseif msg.my >= 4 + 2 * node_height and msg.my <= 4 + 2 * node_height + 10 then
				app.node = nil
				app.wt = 0
				app.refresh_gui = true
				return true
			elseif msg.my >= 4 + 3 * node_height and msg.my <= 4 + 3 * node_height + 10 then
				app.node = nil
				app.wt = 1
				app.refresh_gui = true
				return true
			elseif msg.my >= 4 + 4 * node_height and msg.my <= 4 + 4 * node_height + 10 then
				app.node = nil
				app.wt = 2
				app.refresh_gui = true
				return true
			elseif msg.my >= 4 + 5 * node_height and msg.my <= 4 + 5 * node_height + 10 then
				app.node = nil
				app.wt = 3
				app.refresh_gui = true
				return true
			end
		end
	end
	
	return el
end


-- Node chooser ----------------------------------------------------------------


local node_choice = {
	[0] = {
		[0] = { label = "osc", color = 17, node_type = 0x2, node_op = 0x0 },
		{ label = "fm", color = 27, node_type = 0x2, node_op = 0x1 },
		{ label = "ring", color = 22, node_type = 0x2, node_op = 0x2 },
	},
	{
		[0] = { label = "filt", color = 14, node_type = 0x8, node_op = 0x0 },
		{ label = "echo", color = 31, node_type = 0x9, node_op = 0x0 },
		{ label = "shap", color = 9, node_type = 0x0a, node_op = 0x0 },
	},
}


function ui_routing.attach_node_chooser(parent, el)
	el.width = 118
	el.height = 50
	parent:attach(el)
	
	for i = 1, #placement_buttons do
		app.routing_widget:attach(placement_buttons[i])
	end

	function el:draw()
		--- rectfill(0, 0, self.width - 1, self.height - 1, 0)
		if #placement_buttons > 0 then
			print("choose position...", 4, 28, 22)
			return
		end
		if sfx.root.free_nodes == 0 then
			print("(8 nodes max)", 22, 28, 22)
			return
		end
		print("add module:", 4, 2, 22)
		local ox, oy = 4, 12
		for row = 0, #node_choice do
			for column = 0, #(node_choice[row]) do
				local x = ox + column * node_width
				local y = oy + row * (8 + 4)
				local col = node_choice[row][column].color
				rectfill(x, y, x + (node_width - 6), y + 8, col)
				ui.print_centered(
					node_choice[row][column].label,
					x + ((node_width - 6) \ 2) + 1,
					y + 2,
					63
				)
			end
		end
	end
	
	function el:hover(msg)
		self.cursor = 1
		if (#placement_buttons > 0) return
		if (sfx.root.free_nodes == 0) return
		local ox, oy = 4, 12
		for row = 0, #node_choice do
			for column = 0, #(node_choice[row]) do
				local x = ox + column * node_width
				local y = oy + row * (8 + 4)
				if
					x <= msg.mx and msg.mx <= x + (node_width - 6)
					and y <= msg.my and msg.my <= y + 8
				then
					self.cursor = "pointer"
				end
			end
		end
	end

	function el:click(msg)
		return true -- don't want to deselect the node!
	end
	
	function el:tap(msg)
		if #placement_buttons > 0 then
			ui_routing.clear_placement_buttons()
			return
		end
		if (sfx.root.free_nodes == 0) return
		local ox, oy = 4, 12
		for row = 0, #node_choice do
			for column = 0, #(node_choice[row]) do
				local x = ox + column * node_width
				local y = oy + row * (8 + 4)
				if
					x <= msg.mx and msg.mx <= x + (node_width - 6)
					and y <= msg.my and msg.my <= y + 8
				then
					start_new_node(
						node_choice[row][column].node_type,
						node_choice[row][column].node_op
					)
				end
			end
		end
	end
	

	return el
end


return ui_routing
:: src/ui_settings.lua
--[[pod_format="raw",created="2024-04-30 07:47:36",modified="2026-01-27 08:27:46",revision=4037]]
local settings = require "src/settings.lua"
local ui = require "src/ui.lua"


local ui_settings = {}


local function create_button(el)
	if not el.width then
		if el.label then
			el.width = 8 + (4 * #el.label)
		else
			el.width = 9
		end
	end
	if not el.height then
		el.height = 9
	end
	if not el.fg then
		el.fg = 5
	end
	if not el.bg then
		el.bg = 7
	end
	el.cursor = "pointer"
	function el:draw()
		rectfill(1, 0, self.width - 2, 0, self.bg)
		rectfill(0, 1, self.width - 1, self.height - 2, self.bg)
		rectfill(1, self.height - 1, self.width - 2, self.height - 1, self.bg)
		local label = self.get_label and self:get_label() or self.label
		if label then
			print(label, (self.width \ 2) - (2 * #label), 2, self.fg)
		end
	end
	function el:hover()
		return true
	end
	function el:click()
		return true
	end
	function el:doubleclick()
		return true
	end
	function el:tap()
		if self.action then
			self:action()
		end
	end
	return el
end


function ui_settings.open()
	local el = { x = 150, y = 12, width = 480 - 300, height = 270 - 11 - 24 }
	ui.open_modal(el)
	el:attach(ui.create_label { x = 20, y = 30, label = "Keys for playing notes", fg = 5})
	el:attach(ui.create_label { x = 20, y = 50, label = "- layout:", fg = 5})
	el:attach(ui.create_menu_button {
		x = 58, y = 50 - 2,
		bg = 7,
		get_label = function()
			return settings.user.pitched_layout
		end,
		fg = 59,
		highlight = 15,
		items = {
			{
				label = "piano-like",
				action = function()
					settings.change_keys(settings.piano_keys)
					settings.change_user { pitched_layout = "piano-like" }
				end
			},
			{
				label = "guitar-like",
				action = function()
					settings.change_keys(settings.isomorphic_keys)
					settings.change_user { pitched_layout = "guitar-like" }
				end
			},
			{
				label = "chromatic",
				action = function()
					settings.change_keys(settings.chromatic_keys)
					settings.change_user { pitched_layout = "chromatic" }
				end
			},
		}		
	})
	el:attach(ui.create_label { x = 20, y = 90, label = "mouse movements (knobs, sliders, ...)", fg = 5})
	el:attach(ui.create_label { x = 20, y = 110, label = "- direction:", fg = 5})
	el:attach(ui.create_menu_button {
		x = 70, y = 110 - 2,
		bg = 7,
		get_label = function()
			return settings.user.drag_horizontal and "horizontal" or "vertical"
		end,
		fg = 59,
		highlight = 15,
		items = {
			{
				label = "vertical",
				action = function()
					settings.change_user { drag_horizontal = false }
				end
			},
			{
				label = "horizontal",
				action = function()
					settings.change_user { drag_horizontal = true }
				end
			},
		}		
	})	
	el:attach(ui.create_label { x = 20, y = 130, label = "- sensitivity:", fg = 5})
	el:attach_field {
		x = 78, y = 130 - 1,
		width = 30, height = 7,
		get = function() return settings.user.drag_sensitivity end,
		set = function(self, val)
			local v = mid(0.0, tonum(val), 8.0)
			if (v == 0) v = 0.5
			settings.change_user { drag_sensitivity = v }
		end
	}
	el:attach(ui.create_label { x = 20, y = 150, label = "- precise sensitivity:", fg = 5})
	el:attach_field {
		x = 110, y = 150 - 1,
		width = 30, height = 7,
		get = function() return settings.user.drag_sensitivity_precise end,
		set = function(self, val)
			local v = mid(0.0, tonum(val), 8.0)
			if (v == 0) v = 0.125
			settings.change_user { drag_sensitivity_precise = v }
		end
	}
	
	el:attach(create_button {
		x = 140, y = el.height - 16,
		label = "close",
		action = function(self)
			ui.close_modal()
		end,
	})
	
	function el:draw()
		rect(0, 0, self.width - 1, self.height - 1, 61)
		rect(1, 1, self.width - 2, self.height - 2, 22)
		rectfill(2, 2, self.width - 3, self.height - 3, 6)
		rectfill(2, 2, self.width - 3, 2 + 10, 2)
		print("settings", (self.width \ 2) - (2 * #"settings"), 5, 7)
	end
	
	function el:click()
		return true
	end
end


return ui_settings
:: src/ui_synth.lua
--[[pod_format="raw",created="2024-04-10 15:43:44",modified="2026-01-27 08:27:46",revision=8769]]
local app = require "src/app.lua"
local settings = require "src/settings.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_envelopes = require "src/ui_envelopes.lua"
local ui_nodes = require "src/ui_nodes.lua"
local ui_routing = require "src/ui_routing.lua"
local ui_visual = require "src/ui_visual.lua"
local ui_wavetable = require "src/ui_wavetable.lua"


local ui_synth = {}

local instr_chooser = false

local last_pitch = 0xff -- last pitch played on the keyboard

local width_panel <const> = 24


function ui_synth.attach(parent, el)
--	el.width = 480 - (app.detail and app.detail_width or 0)
--	el.height = 270 - 11 -- TODO: remove - 16
	parent:attach(el)

	sfx.refresh_nodes(app.instrument)	

	local chooser_start = instr_chooser and instr_chooser.start or 0
	instr_chooser = ui_synth.attach_instr_chooser(el, { x = width_panel + 4 - 4, y = 4 })
	instr_chooser.start = chooser_start
	
	app.routing_widget = ui_routing.attach(el, { x = width_panel + 90 - 4, y = 4 })
	--TODO: ui_visual.attach_oscilloscope(el, 8, { node_id = 0, horiz_scale = 1, vert_scale = 2, fg1 = 19, fg2 = 19, x = 90, y = 4, width = 385, height = 97 })

	attach_view_selector(el, { x = 3, y = 4 })
	attach_octave_selector(el, { x = 3, y = 5 + 97 - 57 })
	attach_instrument_selector(el, { x = 3, y = 5 + 97 - 44 })
	attach_volume_selector(el, { x = 3, y = 5 + 97 - 25 })
	
	local dx = app.synth_width + app.synth_gap
	local dy = app.synth_height + app.synth_gap
	local ox = (480 - (4 * dx) + app.synth_gap) \ 2
	local oy = 270 - 11 - (2 * app.synth_height) - app.synth_gap - 2
			
	if app.node then
		ui_nodes.attach_node_panel(
			el,
			{
				x = ox + app.mod_width + app.synth_gap, y = oy , 
				node_id = app.node,
				large = true,
			}
		)
		for row = 0, 1 do
			ui_envelopes.attach_panel(
				el,
				{
					x = 4, y = oy + row * dy, 
					env_id = row, large = true,
				}
			)
			ui_envelopes.attach_panel(
				el,
				{
					x = 480 - 2 * app.mod_width - 2 * app.synth_gap + 1, y = oy + row * dy,
					env_id = 2 + row, large = true,
				}
			)
		end
	elseif not app.wt then
		local id = 0
		for row = 0, 1 do
			ui_envelopes.attach_panel(
				el,
				{
					x = 4, y = oy + row * dy, 
					env_id = row,
				}
			)
			for column = 0, 3 do
				ui_nodes.attach_node_panel(
					el,
					{
						x = ox + column * dx, y = oy + row * dy, 
						node_id = id
					}
				)
				id += 1
			end
			ui_envelopes.attach_panel(
				el,
				{
					x = 480 - app.mod_width - 4 - 1, y = oy + row * dy,
					env_id = 2 + row,
				}
			)
		end
	else -- A wavetable is selected
		ui_wavetable.attach(
			el,
			{
				x = 4, y = oy, 
			}
		)
	end

	function el:draw()
		local w <const> = self.width
		local h <const> = self.height
		cls(6)
		line(0, 0, w - 1, 0, 57)
		line(0, 0, 0, h - 1, 57)
		line(0, 106, w - 1, 106, 57)
		line(0, 105, w - 1, 105, 58)
		line(w - 1, 0, w - 1, h - 1, 58)
		line(0, h - 1, w - 1, h - 1, 58)
		-- divider
		line(3, 41, width_panel - 4, 41, 58)
		line(3, 42, width_panel - 4, 42, 57)
		if app.node then
			line(0, 183, 125, 183, 57)
			line(354, 183, 480, 183, 57)
			line(126, 106, 126, h - 1, 57)
			line(355, 106, 355, h - 1, 57)
			line(0, 182, 125, 182, 58)
			line(354, 182, 480, 182, 58)
			line(125, 106, 125, h - 1, 58)
			line(354, 106, 354, h - 1, 58)
		elseif not app.wt then
			line(0, 183, w - 1, 183, 57)
			line(64, 106, 64, h - 1, 57)
			line(152, 106, 152, h - 1, 57)
			line(240, 106, 240, h - 1, 57)
			line(328, 106, 328, h - 1, 57)
			line(416, 106, 416, h - 1, 57)
			line(0, 182, w - 1, 182, 58)
			line(63, 106, 63, h - 1, 58)
			line(151, 106, 151, h - 1, 58)
			line(239, 106, 239, h - 1, 58)
			line(327, 106, 327, h - 1, 58)
			line(415, 106, 415, h - 1, 58)
		end
	end	
	
	function el:update()
		-- Keys
		if (ui.has_modal_or_menu()) return
		if (ui.head():get_keyboard_focus_element()) return
		local pitch_key = nil
		for i = 1, #settings.keys.pitched do
			local offset = settings.keys.pitched[i].offset
			for j = 0, #settings.keys.pitched[i] do
				local k = settings.keys.pitched[i][j]
				if key(k, true) then
					pitch_key = j + offset
				end
			end
		end
		if pitch_key and not key("ctrl") then
			local pitch = pitch_key + app.base_note
			if key("shift") then
				pitch += 12
			end
			pitch = mid(0, pitch, 0xfe)
			if pitch ~= last_pitch then
				note(
					pitch, -- todo
					app.instrument, -- current_instrument
					app.base_volume, -- current_volume
					ord(" "), 0x00, -- fx, fx param
					8, -- channel 8 so it can play with pattern
					false -- don't force retrigger
				)
				last_pitch = pitch
			end
		else
			note(0xff, 0xff, 0xff, 0xff, 0xff, 8)
			last_pitch = 0xff
		end
		
		if key("ctrl") and keyp("c") then
			local data = userdata("u8", 0x200)
			set(data, 0, peek(0x40000 + (app.instrument * 0x200), 0x200))
			set_clipboard(
				pod(
					{ instrument = data },
					7,
					{ pod_type = "instrument" }
				)
			)
			notify("copied instrument")
		end
		
		if key("ctrl") and keyp("v") then
			local data = unpod(get_clipboard())
			if data and type(data.instrument == "userdata") then
				poke(
					0x40000 + (app.instrument * 0x200),
					get(data.instrument, 0, 0x200)
				)
				app.refresh_gui = true
				app.node = 0
				notify("pasted instrument")
			else
				nodify("unable to paste instrument: invalid data in clipboard")
			end
		end
	end

	--[[	
	function el:click(msg)
		if not ui_routing.clear_placement_buttons() then
			app.node = nil
		end
		app.refresh_gui = true
	end
	]]

	return el
end


-- Instrument chooser --------------------------------------------------------------


function ui_synth.attach_instr_chooser(parent, el)
	el.width = 80
	el.height = 81
	el.cursor = "pointer"
	el.start = 0
	parent:attach(el)
	
	local nb_rows <const> = 9
	local h_row <const> = 8

	function el:draw()
		rectfill(0, 0, self.width, self.height, 59)
		-- Rows
		for i = 0, nb_rows  do
			local instrument = self.start + i
			if instrument == app.instrument then
				rectfill(0, i * h_row, self.width, (i * h_row) + h_row, 4)
			end
			local name = sfx.instrument_name(instrument)
			if name == "" then name = "---" end
			print(string.format("%02x", instrument), 2, 2 + i * h_row, 7)
			print(":", 2 + 8, 2 + i * h_row, 58)
			print(name, 2 + 14, 2 + i * h_row, 57)
		end
		-- Border
		clip()
		line()
		line(1, -1, 58)
		line(self.width - 2, -1, 58)
		line(self.width, 1, 58)
		line(self.width, self.height - 2, 57)
		line(self.width - 2, self.height, 57)
		line(1, self.height, 57)
		line(-1, self.height - 2, 57)
		line(-1, 1, 58)
		line(1, -1, 58)
		clip(self.sx, self.sy, self.width, self.height)
	end
	
	function el:click(msg)
		app.instrument = self.start + (msg.my - 2) // h_row
		app.base_instrument = app.instrument -- TODO: temporary, remove
		ui_routing.clear_placement_buttons()
		if app.node then
			app.node = 0
		end
		app.refresh_gui = true
		return true
	end
	
	function el:mousewheel(msg)
		self.start -= msg.wheel_y
		self.start = mid(self.start, 0, sfx.num_instruments() - 1 - nb_rows)
	end

	return el
end


return ui_synth
:: src/ui_tracker.lua
--[[pod_format="raw",created="2026-01-26 12:39:34",modified="2026-01-27 08:27:46",revision=1931]]
local app = require "src/app.lua"
local settings = require "src/settings.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"
local ui_notegrid = require "src/ui_notegrid.lua"

local ui_tracker = {}

local instr_chooser = false

local last_pitch = 0xff -- last pitch played on the keyboard

local width_panel <const> = 24


-- Local Functions
local attach_pattern_selector
local attach_pattern_flags
local attach_track_mute_button
local attach_track_selector
local attach_track_config
local attach_inspector_button
local attach_play_button


function ui_tracker.attach(parent, el)
	parent:attach(el)
	
	el.headers = {}
	el.notegrids = {}
	
	for channel = 0, 7 do
		local y = 0
		if app.track_header then
			el.headers[channel] = ui_notegrid.attach_header(el, {
				x = width_panel + channel * app.width_column, y = 0,
				channel = channel,
			})
			y += el.headers[channel].height
		end
		el.notegrids[channel] = ui_notegrid.attach(el, {
			x = width_panel + channel * app.width_column, y = y,
			channel = channel,
		})
	end
	
	attach_view_selector(el, { x = 3, y = 4 })
	attach_octave_selector(el, { x = 3, y = 5 + 97 - 57 })
	attach_instrument_selector(el, { x = 3, y = 5 + 97 - 44 })
	attach_volume_selector(el, { x = 3, y = 5 + 97 - 25 })

	attach_pattern_selector(el, { x = 1, y = 5 + 97 + 10 })
	attach_pattern_flags(el, { x = 1, y = 5 + 97 + 26 })
	--attach_track_mute_button(el, { x = 1, y = 5 + 97 + 67 })
	--attach_track_selector(el, { x = 1, y = 5 + 97 + 78 })
	--attach_track_config(el, { x = 1, y = 5 + 97 + 99 })
	attach_inspector_button(el, { x = 1, y = el.height - 36 })
	attach_play_button(el, { x = 0, y = el.height - 18 })
	
	function el:draw()
		local w <const> = self.width
		local h <const> = self.height
		cls(32) -- TODO: remove?
		rrectfill(0, 0, width_panel, h, 0, 6)
		line(0, 0, width_panel - 1, 0, 57)
		line(0, 0, 0, h - 1, 57)
		line(width_panel - 1, 0, width_panel - 1, h - 1, 58)
		line(0, h - 1, width_panel - 1, h - 1, 58)
		-- dividers
		line(3, 41, width_panel - 4, 41, 58)
		line(3, 42, width_panel - 4, 42, 57)
		line(3, 105, width_panel - 4, 105, 58)
		line(3, 106, width_panel - 4, 106, 57)
		line(3, 166, width_panel - 4, 166, 58)
		line(3, 167, width_panel - 4, 167, 57)
		line(3, 220, width_panel - 4, 220, 58)
		line(3, 221, width_panel - 4, 221, 57)
	end	
	
	function el:update()
		if key("ctrl") then
			if keyp("h") then
				app.track_header = not app.track_header
				app.refresh_gui = true
			end
			if keyp("j") then
				app.height_row = max(7, app.height_row - 1)
			end
			if keyp("k") then
				app.height_row = min(12, app.height_row + 1)
			end
		end
	end
	
	--
	
	function el:scroll_channels(delta)
		for channel = 0, 7 do
			local notegrid = self.notegrids[channel]
			notegrid.start -= delta
			notegrid.start = max(0, self.notegrids[channel].start)
		end
	end

	return el
end


----------------------------------------------------------------------------------------------------
-- Pattern Selector
----------------------------------------------------------------------------------------------------


function attach_pattern_selector(parent, el)
	el.width = 20
	el.height = 16
	el.cursor = get_spr(50)
	parent:attach(el)
	
	el.drag_start = nil

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 57)
		local fg = self.dragged and 7 or 5
		print("patrn", 1, 1, 58)
		print(
			string.format("%02d", app.pattern),
			7, 9,
			fg
		)
	end	
	
	function el:click(msg)
		-- TODO: replace with pull-down menus
		self.dragged = true
		self.cursor = 0
	end
	
	function el:drag(msg)
		if self.dragged then
			local delta = ui.mouselock(0.125)
			app.pattern = mid(0, app.pattern - delta, 0xfe)
		end
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		self.dragged = nil
	end

	function el:doubleclick(msg)
		app.pattern = 00
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Pattern Flags
----------------------------------------------------------------------------------------------------


function attach_pattern_flags(parent, el)
	el.width = 20
	el.height = 4 + 3 * 11
	el.cursor = "pointer"
	parent:attach(el)
	
	el.drag_start = nil

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 57)
		local fg = self.dragged and 7 or 5
		pal(7, 58)
		spr(40, 6, 2)
		spr(41, 6, 2 + 11)
		spr(42, 6, 2 + 22)
		pal(7, 7)
	end	
	
	function el:click(msg)
		-- TODO: replace with pull-down menus
		self.dragged = true
	end
	
	function el:drag(msg)
		if self.dragged then
			local delta = ui.mouselock(0.125)
			app.pattern = mid(0, app.pattern - delta, 0xfe)
		end
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.dragged = nil
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Track Selector
----------------------------------------------------------------------------------------------------


function attach_track_selector(parent, el)
	el.width = 20
	el.height = 16
	el.cursor = get_spr(50)
	parent:attach(el)
	
	el.drag_start = nil

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 57)
		local fg = self.dragged and 7 or 5
		print("track", 1, 1, 58)
		print(
			string.format("%03d", app.track),
			5, 9,
			fg
		)
	end	
	
	function el:click(msg)
		-- TODO: replace with pull-down menus
		self.dragged = true
		self.cursor = 0
	end
	
	function el:drag(msg)
		if self.dragged then
			local delta = ui.mouselock(0.125)
			app.track = mid(0, app.track - delta, 0xfe)
		end
	end
	
	function el:release(msg)
		ui.mouseunlock()
		self.cursor = get_spr(50)
		self.dragged = nil
	end

	function el:doubleclick(msg)
		app.track = 00
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Track Mute
----------------------------------------------------------------------------------------------------


function attach_track_mute_button(parent, el)
	el.width = 20
	el.height = 10
	parent:attach(el)
	
	el.cursor = "pointer"

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 14)
		pal(7, 59)
		spr(47, 7, 2)
		pal(7, 7)
	end	
	
	function el:click(msg)
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Track Config
----------------------------------------------------------------------------------------------------


function attach_track_config(parent, el)
	el.width = 20
	el.height = 16
	parent:attach(el)
	
	el.cursor = "pointer"

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 14)
		print(" len ", 1, 1, 58)
		ui.print_centered("64", 11, 1 + 8, 5)
	end	
	
	function el:click(msg)
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Inspector Button
----------------------------------------------------------------------------------------------------


function attach_inspector_button(parent, el)
	el.width = 20
	el.height = 18
	parent:attach(el)
	
	el.cursor = "pointer"

	function el:draw()
--		rrectfill(0, 0, self.width, self.height, 0, 14)
		pal(7, 59)
		spr(45, 5, 3)
		pal(7, 7)
	end	
	
	function el:click(msg)
	end
	
	return el
end


----------------------------------------------------------------------------------------------------
-- Play Button
----------------------------------------------------------------------------------------------------


function attach_play_button(parent, el)
	el.width = 20
	el.height = 18
	el.cursor = "pointer"
	parent:attach(el)

	function el:draw()
		-- TODO: channel mask
		spr(sfx.are_channels_playing(0xff) and 5 or 4, 3, 1)
	end
	
	function el:click()
		app.play_or_pause()
	end
	
	return el
end


return ui_tracker
:: src/ui_visual.lua
--[[pod_format="raw",created="2024-04-16 18:22:58",modified="2026-01-27 08:27:46",revision=5285]]
local app = require "src/app.lua"
local sfx = require "src/sfx.lua"
local ui = require "src/ui.lua"


local ui_visual = {}


local overlay = nil


function ui_visual.close()
	if overlay then
		overlay:detach()
		overlay = nil
	end
end


-- Wavetables ----------------------------------------------------------------


function ui_visual.open_wavetable(target)
	if (overlay) ui_visual.close()
	
	overlay = ui_visual.attach_wavetable(ui.head(), target, {
		x = 90, y = 4,
		width = 366, height = 97,
	})
end


local function draw_wave(
		wt_addr, wt_width, wt_height,
		wave, phase,
		display_width, display_height,
		col1, col2
)
	local oy = display_height \ 2
	local pos_addr = wt_addr + (wave * wt_height >> 8) * wt_width * 2
	local last_h = nil
	for i = 0, (display_width - 1) do
		local sample = i / display_width
		sample += (phase / 256.0) % 1.0
		sample = flr(0.5 + sample * wt_width)
		local val = peek2(pos_addr + sample * 2)
		local h = flr(0.5 + ((val * display_height) / 72000))
		if last_h then
			line(i, oy - last_h, i, oy - h, col2)
		end
		pset(i, oy - h, col1)
 		last_h = h
	end
end


function ui_visual.attach_wavetable(parent, target, el)
	parent:attach(el)
	function el:draw()
		rectfill(0, 0, self.width - 1, self.height - 1, 59)
		local wt_index = sfx.node_wavetable_index(app.instrument, target.node_id)
		local wt_addr, wt_width, wt_height = sfx.wavetable_info(app.instrument, wt_index)
		local _, wave1, wave0, _ = sfx.node_param(app.instrument, target.node_id, 4)
		local _, phase, _, _ = sfx.node_param(app.instrument, target.node_id, 5)
		-- Show val0 if there is an envelope
		local flags, _, _, _ = sfx.node_param(app.instrument, target.node_id, target.param)
		if flags & (0x04 | 0x10) > 0  then
			draw_wave(wt_addr, wt_width, wt_height, wave0, phase,
				self.width, self.height, 60, 60)
		end
		-- Show val1
		draw_wave(wt_addr, wt_width, wt_height, wave1, phase,
			self.width, self.height, 17, 19)
		-- Border
		clip()
		line()
		line(1, -1, 58)
		line(self.width - 2, -1, 58)
		line(self.width, 1, 58)
		line(self.width, self.height - 2, 57)
		line(self.width - 2, self.height, 57)
		line(1, self.height, 57)
		line(-1, self.height - 2, 57)
		line(-1, 1, 58)
		line(1, -1, 58)
		clip(self.sx, self.sy, self.width, self.height)
	end
	return el
end


-- Oscilloscope ---------------------------------------------------------------


function ui_visual.attach_oscilloscope(parent, channel, el)
	parent:attach(el)
	el.frame_counter = 0
	function el:draw()
		local node_id = self.node_id or app.node or 0
		local horiz_scale = self.horiz_scale or 2
		local vert_scale = self.vert_scale or 1
		local bg, fg1, fg2, border = self.bg or 59, self.fg1 or 11, self.fg2 or 3, self.border or 22
		if self.compact then
			bg, fg1, fg2, border = 62, 27, 3, 61
		end
		rectfill(0, 0, self.width - 1, self.height - 1, bg)
		-- Oscilloscope
		local tick_addr = 0x200000 + node_id * 8192

		-- `tick_len` is never used by sfx.p64...
		-- but the second `stat` is necessary to get
		-- audio data into `tick_addr`
		local tick_len = stat(400 + channel, 8)
		self.frame_counter += 1
		if self.frame_counter % 6 == 0 then
			tick_len = stat(400 + channel, 20 + node_id, tick_addr)
		end
		
		local last_y = nil
		for x = 0, self.width - 1 do
			local sample = flr(x * horiz_scale) -- i.e. horizontal scaling of the waveform
			local val = peek2(tick_addr + sample * 2)
			local y = (self.height / 2) - (vert_scale * (val * self.height) / 72000)
			if last_y then
				line(x, last_y, x, y, fg2)
			end
			pset(x, y, fg1)
			last_y = y
		end

		-- Border
		clip()
		line()
		line(1, -1, 58)
		line(self.width - 2, -1, 58)
		line(self.width, 1, 58)
		line(self.width, self.height - 2, 57)
		line(self.width - 2, self.height, 57)
		line(1, self.height, 57)
		line(-1, self.height - 2, 57)
		line(-1, 1, 58)
		line(1, -1, 58)
		clip(self.sx, self.sy, self.width, self.height)
	end
	return el
end


-- Custom envelopes ----------------------------------------------------




function ui_visual.open_custom_envelope(env_id)
	if (overlay) ui_visual.close()
	
	local env_type = sfx.env_type(app.instrument, env_id)
	if (env_type != 2) return
	
	overlay = ui.head():attach {
		x = (480 \ 2) - (128 \ 2), y = 10,
		width = 128, height = 90,
		env_id = env_id,
	}
	
	function overlay:draw()
		ui_visual.draw_custom_envelope(overlay)
		rect(0, 0, self.width - 1, self.height - 1, 22)
	end
end


function ui_visual.draw_custom_envelope(self)
	local bar_width = self.width \ 16
	rectfill(1, 1, self.width - 2, self.height - 2, 59)
	local start = sfx.env_start(app.instrument, self.env_id)
	local loop0 = sfx.env_loop0(app.instrument, self.env_id)
	local loop1 = sfx.env_loop1(app.instrument, self.env_id)
	for i = 0, 15 do
		local val = sfx.env_param(app.instrument, self.env_id, i)
		local h = (val * (self.height - 2)) \ 255
		local col = (i % 2 == 0) and 29 or 18
		if loop0 <= i and i < loop1 then
			col = (i % 2 == 0) and 23 or 14
		end
		rectfill(
			1 + (bar_width * i), self.height - 1,
			bar_width + (bar_width * i), self.height - h - 1,
			col
		)
	end
	fillp(0b1111000011110000)
	poke(0x550b,0x3f)
	if start > 0 then
		local x = 1 + (bar_width * start)
		line(x, 1, x, self.height - 2, 28)
	end
	if loop0 > 0 then
		local x = 1 + (bar_width * loop0)
		line(x, 1, x, self.height - 2, 26)
	end
	if loop1 > 0 then
		local x = bar_width + (bar_width * (loop1 - 1))
		line(x, 1, x, self.height - 2, 10)
	end
	fillp()
	poke(0x550b,0x0)
	if self.selected then
		local val = sfx.env_param(app.instrument, self.env_id, self.selected)
		local str = tostr(val)
		print(str, self.width - 3 - (4 * #str), 3, 7)
	end
	rect(0, 0, self.width - 1, self.height - 1, 5)
end


return ui_visual
:: src/ui_wavetable.lua
--[[pod_format="raw",created="2026-01-25 09:41:43",modified="2026-01-27 08:27:46",revision=3511]]
local sfx = require "src/sfx.lua"
local Wavetable = require "src/wavetable.lua"
local ui = require "src/ui.lua"


local ui_wavetable = {}


local wt = nil
local wave = 0


function ui_wavetable.attach(parent, el)
	el.width = 480 - 2 * 4
	el.height = 270 - 11 - 100
	parent:attach(el)
	

	-- TODO	
	wt = Wavetable.new(256, 32)
	wt:set_wavetable(drakma_cosine2saw2reso)

	
	function el:update()
		if not wt then return end
		
		local _, _, _, _, wheel_y = mouse()
		if wheel_y > 0 and wave > 0 then
			wave -= 1
		elseif wheel_y < 0 and wave < wt.height - 1 then
			wave += 1
		end
	
		if key("alt") then
			if keyp("1") then
				wt:set_wavetable(cz_saw)
			end	
			if keyp("2") then
				wt:set_wavetable(cz_square)
			end	
			if keyp("3") then
				wt:set_wavetable(cz_pulse)
			end	
			if keyp("4") then
				wt:set_wavetable(cz_doublesine)
			end	
			if keyp("5") then
				wt:set_wavetable(cz_sawpulse)
			end	
			if keyp("6") then
				wt:set_wavetable(cz_reso1)
			end	
			if keyp("7") then
				wt:set_wavetable(cz_reso2)
			end	
			if keyp("8") then
				wt:set_wavetable(cz_reso3)
			end
			if keyp("9") then
				wt:set_wavetable(split(cz_saw, cz_reso1))
			end
			
			if keyp("q") then
				wt:set_wavetable(drakma_cosine2saw)
			end
			if keyp("w") then
				wt:set_wavetable(drakma_triangle2saw)
			end
			if keyp("e") then
				wt:set_wavetable(drakma_sine2saw)
			end
			if keyp("r") then
				wt:set_wavetable(drakma_square2saw)
			end
			if keyp("t") then
				wt:set_wavetable(drakma_cosine2saw2reso)
			end
			if keyp("a") then
				wt:set_wavetable(drakma_cosine2square)
			end
			if keyp("s") then
				wt:set_wavetable(drakma_triangle2square)
			end
			if keyp("d") then
				wt:set_wavetable(drakma_triangle2square2saw)
			end
			if keyp("f") then
				wt:set_wavetable(drakma_pulsewidth)
			end
			if keyp("g") then
				wt:set_wavetable(drakma_sawpulse)
			end
			if keyp("z") then
				wt:set_wavetable(drakma_saw2reso)
			end
			if keyp("x") then
				wt:set_wavetable(drakma_square2reso)
			end
			if keyp("c") then
				wt:set_wavetable(drakma_triangle2reso)
			end
			if keyp("v") then
				wt:set_wavetable(drakma_sawpulse2reso)
			end
			if keyp("b") then
				wt:set_wavetable(drakma_sawpulse2resoalt)
			end
		end
	end
	
	
	function el:draw()
		--print("(the wavetable editor is coming soon!)", 158, 70, 5)
		---[[
		print("num_instruments: "..sfx.num_instruments(), 4, 4, 0)
		print("instruments_address: "..string.format("%x",sfx.instruments_address()), 4, 14, 0)
		print("tracks_address: "..string.format("%x",sfx.tracks_address()), 4, 24, 0)
		print("patterns_address: "..string.format("%x",sfx.patterns_address()), 4, 34, 0)
		-- Temporary wavetable display		
		if not wt then return end
		local ox <const> = 270
		local oy <const> = el.height // 2
		rrectfill(ox, oy - 50, 200, 101, 0, 59)
		line(ox, oy, ox + 200 - 1, oy, 60)
		local last_y
		for i = 0, 199 do
			local sample = (i * wt.width) // 200
			local value = wt:get(wave, sample)
			local y = oy - math.floor(0.5 + 50 * value)
			if last_y then
				line(ox + i, last_y, ox + i, y, 27)
			end
			pset(ox + i, y, 26)
			last_y = y
		end
		print(string.format("%d", wave), ox + 4, oy - 60, 19)
		--]]
	end
end


return ui_wavetable
:: src/waves.lua
--[[pod_format="raw",created="2026-01-23 20:54:55",modified="2026-01-27 08:27:46",revision=5165]]
----------------------------------------------------------------------------------------------------
-- Transforms
----------------------------------------------------------------------------------------------------


function nes_slope(func, coeff)
	local coeff = coeff or 2
	return function(x, w)
		local value = 2 * func(x, w) - 1
		if value > 0.0 then
			value -= x * coeff
		else
			value -= (1 - x) * coeff
		end
		value /= 1 + coeff
		local y = 0.5 + value / 2
		return y
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


function bitcrunch(func, res)
	res = res and (res - 1) or 15
	return function(x, w)
		return math.floor(0.5 + res * func(x, w)) / res
	end
end


function phase(func, ph)
	return function(x, w)
		return func(x + ph, w)
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


function split(funcA, funcB)
	return function(x, w)
		if x < 0.5 then
			return funcA(2 * x, w)
		else
			return funcB(2 * x - 1, w)
		end
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


function mask(func1, func2)
	return function(x, w)
		return 1 - (1 - func1(x, w)) * (1 - func2(x, w))
	end
end


function multiply(func1, func2)
	return function(x, w)
		return func1(x, w) * func2(x, w)
	end
end


function multiply_bipolar(func1, func2)
	return function(x, w)
		local value1 = 2 * func1(x, w) - 1
		local value2 = 2 * func2(x, w) - 1
		return 0.5 + (value1 * value2) / 2
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


function inverse(func)
	return function(x, w)
		return 1 - func(x, w)
	end
end


function reverse(func)
	return function(x, w)
		return func(x, 1 - w)
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


function sequence(...)
	local funcs = {...}
	local count = #funcs
	return function(x, w)
		local idx = 1 + math.floor(0.5 + w * (count - 1))
		return funcs[idx](x, w * count % 1.000000000001) -- TODO
	end
end


----------------------------------------------------------------------------------------------------
-- Basic Waves
----------------------------------------------------------------------------------------------------


function w_cos(x, w)
	return 0.5 + cos(x) / 2
end


function w_sin(x, w)
	return 0.5 + sin(x) / 2
end


function w_saw(x, w)
	return x % 1.0
end


function w_triangle(x, w)
	x = x % 1.0
	if x < 0.5 then
		return 1 - (2 * x)
	else
		return (2 * x) - 1
	end
end


w_cotriangle = phase(w_triangle, 0.25)


function w_pulse50(x, w)
	x = x % 1.0
	if x < 0.5 then
		return 1
	else
		return 0
	end
end


w_square = w_pulse50


function w_pulse75(x, w)
	x = x % 1.0
	if x < 0.75 then
		return 1
	else
		return 0
	end
end


function w_pulse25(x, w)
	x = x % 1.0
	if x < 0.25 then
		return 1
	else
		return 0
	end
end


function w_pulse12(x, w)
	x = x % 1.0
	if x < 0.125 then
		return 1
	else
		return 0
	end
end


function w_pulse01(x, w)
	x = x % 1.0
	if x < 0.0078125 then
		return 1
	else
		return 0
	end
end


function w_trapeze(x, w)
	x = x % 1.0
	if x < 0.5 then
		return 0
	else
		return (2 * x) - 1
	end
end


w_triangle16 = bitcrunch(w_triangle, 16)


nes_triangle = nes_slope(phase(w_triangle16, 0.75), 1)


nes_pulse12 = nes_slope(w_pulse12, 1)
nes_pulse25 = nes_slope(w_pulse25, 1)
nes_pulse50 = nes_slope(w_pulse50, 1)
nes_pulse75 = nes_slope(w_pulse75, 1)


nes_waveforms = sequence(nes_triangle, nes_pulse75,
	nes_pulse50, nes_pulse25, nes_pulse12)


----------------------------------------------------------------------------------------------------
-- Phase Distortion
----------------------------------------------------------------------------------------------------


--[[
	y = a * x + b
	0 = a * 0 + b
	b = 0
	py = a * px
	a = py / px
	1 = c * 1 + d
	d = 1 - c
	py = c * px + d
	py = c * px + 1 - c
	py - 1 = c * (px - 1)
	c = (py - 1) / (px - 1)
]]
function bend(p0x, p0y, p1x, p1y)
	return function(x, w)
		local px = p0x + (p1x - p0x) * w
		local py = p0y + (p1y - p0y) * w
		
		local a <const> = py / px
		local c <const> = (py - 1) / (px - 1)
		local d <const> = 1 - c
		
		if x < px then
			return x * a
		else
			return x * c + d
		end
	end
end


function doublebend(funcA, funcB)
	return function(x, w)
		if x < 0.5 then
			return funcA(2 * x, w) / 2
		else
			return 0.5 + funcB(2 * x - 1, w) / 2
		end
	end
end


function distort(wfunc, bfunc)
	return function(x, w)
		return wfunc(bfunc(x, w), w)
	end
end


function reso(func)
	return function(x, w)
		local r = (15 * w) + 1
		return func((r * x) % 1, w)
	end
end


-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


cz_saw =
	distort(
		w_cos,
		bend(0.5, 0.5, 0.0, 0.5)
	)


cz_square =
	distort(
		w_cos, 
		doublebend(
			bend(0.0, 0.0, 1.0, 0.0),
			bend(0.0, 0.0, 1.0, 0.0)
		)
	)


cz_pulse =
	distort(
		w_cos, 
		bend(0.0, 0.0, 0.99, 0.0)
	)


cz_doublesine =
	distort(
		split(w_cos, w_cos),
		bend(0.5, 0.5, 0.01, 0.5)
	)


cz_sawpulse =
	distort(
		w_cos,
		doublebend(
			bend(0.0, 0.0, 0.0, 0.0),
			bend(1.0, 1.0, 0.0, 1.0)
		)
	)


cz_reso1 =
	mask(
		reso(w_cos),
		w_saw
	)


cz_reso2 =
	mask(
		reso(w_cos),
		w_triangle
	)


cz_reso3 =
	mask(
		reso(w_cos),
		w_trapeze
	)


cz_saw_reso1 = split(cz_saw, cz_reso1)	

	
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --


drakma_cosine2saw =
	distort(
		inverse(w_cos),
		bend(0.5, 0.5, 1.0, 0.5)
	)


drakma_triangle2saw =
	distort(
		inverse(w_triangle),
		bend(0.5, 0.5, 1.0, 0.5)
	)


drakma_sine2saw =
	distort(
		w_sin,
		doublebend(
			bend(0.5, 0.5, 0.0, 0.5),
			bend(0.5, 0.5, 1.0, 0.5)
		)
	)


drakma_square2saw =
	reverse(
		distort(
			w_saw,
			doublebend(
				bend(0.5, 0.5, 1.0, 0.0),
				bend(0.5, 0.5, 0.0, 0.99999)
			)
		)
	)


drakma_cosine2square =
	distort(
		phase(w_cos, 0.5), 
		doublebend(
			bend(0.5, 0.5, 1.0, 0.0),
			bend(0.5, 0.5, 1.0, 0.0)
		)
	)


drakma_triangle2square =
	distort(
		phase(w_triangle, 0.5),
		doublebend(
			bend(0.5, 0.5, 1.0, 0.0),
			bend(0.5, 0.5, 1.0, 0.0)
		)
	)


drakma_triangle2square2saw =
	sequence(drakma_triangle2square, drakma_square2saw)
	

drakma_pulsewidth =
	distort(
		w_square, 
		bend(0.5, 0.5, 1 - 0.001953, 0.5)
	)
	
	
drakma_sawpulse =
	split(
		distort(
			w_cos,	
			bend(0.5, 0.5, 0.0, 0.5)
		),
		distort(
			w_cos,
			doublebend(
				bend(0.5, 0.5, 0.0, 1.0),
				bend(0.5, 0.5, 1.0, 0.0)
			)
		)
	)

	
drakma_saw2reso =
	mask(
		reso(reverse(drakma_cosine2saw)),
		w_saw
	)

	
drakma_square2reso =
	mask(
		reso(reverse(drakma_cosine2square)),
		w_trapeze
	)

	
drakma_triangle2reso =
	mask(
		reso(w_triangle),
		w_triangle
	)


drakma_cosine2saw2reso = sequence(drakma_cosine2saw, drakma_saw2reso)

	
drakma_sawpulse2reso = mask(reso(w_cos), inverse(drakma_pulsewidth))

	
drakma_sawpulse2resoalt =
	mask(
		reso(reverse(cz_sawpulse)),
		distort(
			w_trapeze, 
			bend(0.5, 0.5, 1 - 0.001953, 0.5)
		)
	)

:: src/wavetable.lua
--[[pod_format="raw",created="2026-01-23 13:43:16",modified="2026-01-27 08:27:46",revision=5500]]
-- TODO: move into pfx

local Wavetable = structure {
	-- width: Int -- number of samples in a wave
	-- height: Int -- number of waves in the wavetable
	-- samples: Array[Int]
}


function Wavetable.new(width, height)
--	local samples = {}
--	for i = 0, width * height do
--		samples[i] = 0.0
--	end
	samples = userdata("i16", width, height)
	return Wavetable {
		width = width,
		height = height,
		samples = samples,
	}
end


function Wavetable:get(wave, sample)
	assert(0 <= wave and wave < self.height) -- TODO: should be < height?
--	assert(0 <= sample and sample < self.width) -- TODO: should be < width?
	local sample = sample % self.width
	local value = self.samples:get(sample, wave)
	return value / 0x7fff
end


function Wavetable:set(wave, sample, value)
	assert(0 <= wave and wave < self.height) -- TODO: should be < height?
	assert(0 <= sample and sample < self.width) -- TODO: should be < width?
	assert(-1.0 <= value and value <= 1.0)
	local sample = sample % self.width
	self.samples:set(sample, wave, value * 0x7fff)
end


function Wavetable:set_wave(wave, func)
	-- func: (x: Float) -> Float
	-- `x` is in [0,1] (instead of [0, pi])
	-- `result` is in [0, 1] (instead of [-1, +1])
	local start = wave * self.width
	local length <const> = self.width
	for i = 0, self.width - 1 do
		local value = 2 * func(i / length) - 1
		self:set(wave, i, value)
	end
end


function Wavetable:set_wavetable(func)
	-- func: (x: Float, w: Float) -> Float
	-- `x` is in [0,1] (instead of [0, pi])
	-- `w` is in [0,1] (0 = first wave of the wt, 1 = last wave)
	-- `result` is in [0, 1] (instead of [-1, +1])
	for wave = 0, self.height - 1 do
		local w = wave / (self.height - 1)
		local wavefunc = function(x) return func(x, w) end
		self:set_wave(wave, wavefunc)
	end
end


return Wavetable
:: todo.txt
--[[pod_format="raw",created="2024-04-10 20:46:30",modified="2026-01-27 08:27:46",revision=4003]]
- add 4/4 config

:: .info.pod
--[[pod,author="drakmaniso",created="2024-04-16 13:35:13",icon=userdata("u8",16,16,"00000001010101010101010101000000000001070707070707070707070100000001071818181818181818181807010001071818181818180718181818180701010718181818181807071818181807010107181818181818071807181818070101071818181818180718071818180701010718181818070707181818181807010107181818070707071818181818070101071818181807071818181818180701010718181818181818181818181807010106071818181818181818181807060101060607070707070707070707060601000106060606060606060606060601000000010606060606060606060601000000000001010101010101010101000000"),lowcol_icon=false,modified="2026-01-27 08:28:35",notes="An instrument and wavetable\neditor for \".sfx\" files",runtime=24,stored="2024-04-16 11:37:51",title="WaveMaker",version="0.0.4",workspaces={{location="main.lua",workspace_index=1},{location="gfx/0.gfx#46",workspace_index=2},{location="map/0.map",workspace_index=3},{location="sfx/0.sfx",workspace_index=4},{location="sfx/0.sfxi",workspace_index=7},{location="pal/0.pal",workspace_index=8}}]]
:: gfx/.info.pod
--[[pod,created="2024-03-24 00:48:06",modified="2026-01-27 08:28:35",stored="2024-03-24 00:48:06"]]
:: gfx/0.gfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI0LTAzLTI0IDAwOjQ4OjA2Iixtb2RpZmllZD0iMjAyNi0w
MS0yNyAwNDo1MDoxMiIscmV2aXNpb249OTgxNl1dbHo0AAsHAABTOQAA8yV7WzBdPXtibXA9cHh1
AEMgCAgEwBdABxAXIAcQFxAHIBcQB0AXwCxmbGFncz0wLHBhbl94CADXeT0wLHpvb209MTF9LEMA
9g8QEATwCC85wA4HHrAOFx6gDicekA4HDhcOkA4HHgcGAOIOBx5gPgcuYB43DoAORwQAfx4nHpBO
8AZwAAsdOG8A8AoKPzmQLhcOcC43DlAuVw5QDkceBw5QDic_BgBBBy4QDggAMg4QLggA-xMAHicO
MC4HDgAONw4gHicOAB4XHiAONw4QPjAeFx6gPvAKgQAdchM-OaAeFx7cAPAGgB4HHgcecA4HPgcO
YB4HPgeOBwYOAgASBwYAYY4HPgceYB8AEXArABKAEwECfAAfA3wAGf8NEQ8EAO8SAP4qB-4AF_4n
3jfOJ94X7gf_LADuAEgACx85SAACMzpHvgIAL-46QwAcAAcBH-AxABn-BwgIBDAHYBdQBwAHQAcA
ByAnMDdAF7BCABn-BQsGBAAnYAcgB1AHkAeQByAHYCdgQAALHjdAADAgBwB_AEEHAFdQCgCfQFcg
BxAHAAcQTAAeEjeLAAcEAB83QwAeBo4AAoYACQwAD08AHmBHUAeQJ3AdAS9HUDsAIEAHkDdgBgAP
OwAdExBJAQFRASM3EFkBH5CbAR4E2wEgEBdOAT9gN1DdAS4kEBdNAT8QN1CQACRFIAdQR_IBD5IA
KAPVARVHCgAOUAAPcwIULzdgcQIjDrMDDzEAn58THQT-GJvw-201AByP8Jv-GE-w-w43AB1v_v8Y
dfCINgAdX-_A-xiIOQF7DzEAHk8OCATwXwIaggcHBHJPOxJOAgAfckUIGgM8AHIOLxEOEg4tBAAP
QwAcYQwGBDAXIFwGMQAHEM8IAGcDBAgAEzAYABBA6wgPWQAMHjBZAP8KCHAHAAhgFwAIB2AXCAAH
cAgHAAdgCBAXUEsAGlMFBQQHIPwDBAgAD0EADBw2QQAgQEdWBB9gNwAdf2AHICcAR0A3AB0h8ASn
AA83ABr-AwkJBJA3cAdwB0BnIEdAJ2AHwEcCGf8DCQkEwAdgJ0BHIGdAB3AHcDeQPgAcN5BnEAIA
H5DDAhz-ATAPFkAeMC4gPjAuQB5QDhA-ABz-ARAPFlAeQC4wPiAuMB5ADjA-ABlxDAwE8AIncN0F
FUACAADpBc9AFwAnQCdwJ5AH8AVxAhqCBwcEcE86EE4CAB9wPAAMHzI8AAFyDi8SDhAOLQQAD0MA
HPEZFxcE8PkB8AUBBwHwBAEXAfADAScBAAHwAAE3AQcB4AEXEScB4BEHER8AEgcfACDwAwoATwUB
8AwaCxkKagAESwAQAgUAsAEBRwHwACEHIfACGQAfVVcAHRNuVwACUgBVEQcR8ANmAEUEIfAEDQAQ
AxwAAXMABMMAH25sABmQGRkE8P8qAfAHPQBwBgEHEQABECsBABAAACMB8APQEUcBJwGwAQcBRxEH
EcABVxFDAWA3QfAAMQBCARAFfwAzBAEnrwA-BwEwfgAMDyAGHS8xMDIALPwpHx8E8B4F8EMF8AEF
8AIPOkcO8AYOhw7wA8fwAefg9wFwBTAO9wEOMAVg9wMPP5AO9wMOkPcFDYAEAAAZAKANQAUw9wMd
EAVgMwD-Fg2w9wEdwOcd4McdwAUgDocOHQAFoAVADQ5HDi0gBYAFcG1QBfC8AgwfNqwAChBGrACh
hg7wA8bwAebg9qwAEfasABH2rACM9gMOkPYFDYAEACIO9qwAEvasABD2rACB9gEdwOYd4MasABWG
rAAfRqwAKvwnB-BDB-ABB-ACDzxPOw888AYOjzsO8APN8AHt4P0BcAcwDv0BDjAHYP0DDzqQDv0D
DpD9BQyABAAAGQCgDEAHMP0DHBAHYDMA-xUMsP0BHMDtHODNHMAHIA6NDhwAB6AHQAwOTQ4sIAeA
B3BsUAevAB5B4AfwDgMAHyS0AE0g8AGzACHwA7AAH8CuACAAlwOwFQfwAgegB-AZTzusAPMPbzsP
POCvO4AHIM4gB2APPM4NkO4POnD_AXD_AQxgBAD-HDAHEP4BDAAHUO4ccA3ODQyQzhygrhzADW4N
HKAHIAxOLAAHgAdQTDAH8D8lBhlwGRkEsAfwCJEAAB4GD5MAPV-wAEzwRJAAGf8BCQcE8AVPOiBu
EG4QbiBOABEEGtAJBwSgTzsgbhAOTw8OPwAfoD8AGsAcHAT-OggwDvYGDzkGABUNBQBQXvYKDQ4E
ALH9AJYN8AAOJi0OJggALA0QCQC7PiYNvjAOlg0Olg0HAB_9NwAMZPAADpb_AmoAGS2BAAQFAC-9
B00BGf8DBwcEVwBnMAcANwA3AAcwZwBXeQkND8QFHw8yAP------------------------------
------------------9dUD0xMH19
:: label.png
b64$iVBORw0KGgoAAAANSUhEUgAAAeAAAAEOCAIAAADe_FMwAAAmUElEQVR4Ae2dX2hcyZ3vj3r7
LlwIzHLXktZgu910Mi_BJgOBPGg6mc0Fj8N4BNIo9oJbNzFtgyU17euZ7rQgLXkk9VzU6c74SshW
wG60uepZ1hkzAtuBjGFhxj2_ZiEwuYLkIUzTlnZAsSRMBkweEhbfh3JqynX_dJ0-df5_PzTN79T5
VdU5v1P1qde_p1-8QQEAAOA-4i7P98kLZ31bi5e-uE6C9dUlwS7jExewhgAAkuh7_sUf2Gu1mxx0
kAU7v-zFdcFeRK82D4CXv7gubmc4GgA1ZAeRfcHGBslcvvi2EswX15re9u-5POurS_MTF8i-uA_J
tQyIi5TA1Ms4KKyeT2-B4wAAd_xMgvXVJVPaEjSyWdWwyXoWtoNZOws6mhc09xpkVpF3loHB09N2
tZeprGFtAIALB5Ll84M4ysDRvKDpBGR046NG865sa6vNS16P-MszsvFZBQBw0HTiu9IPD889hoOi
4AXNmqjny3tVHXrmEB2TS6pm7q6DHwCOBkCG3dhtJb7LaJq4iHqO7I7TWDURWZkQNHkHrmTib_vm
G7JeZl-Y4K7l4x12BiBwmN2zevkOas2UlHhBm9KQbBeTs0UtXHrmOOVfGV8agAhCBLK_ukTkQHaN
sSi4nSV1owkqi00TeR5Tz6z2mAF9T7-4g2sfz02fWj4SzK4P2acUACCyxFACAADwJ32zX3sDVQAA
AB8SQwkAAACCBgAAYII4jebfHjZOnX37FuoFAACu0Tf7tTdE7AxHAwCADFr-_SkJsn-zEncrrtnh
6YlX__58iMIBAIBsO1Mvs7GRoC04eu7XV0hw6ZtTJL70zSn2Fm1nb6kPEIOY-hucPyKxZnfSTmO2
kcsBAEhCTxFRsDMrOtoSM_j89MSr4jORgtKyUh3P-frKpW9OsXfVpScPRB_Le2KR2TW7sMNyU3AF
onZWF4vLAQDIszNxBbXHV3Mv0n_H5xr9PvnRmLvF5ej1lU3c_PbTE6-23fnQkVNR-EhkRUkUqXna
cF00Y8HpxE8CAIAL6Oli-u1hU_McWb7GXv7w8eCz8T94f270_5c_eJ_71GzUeLwP3ndH0DHj2-bt
TM5DU12yf-MSlSzrTbZd3YVmmlIt21HE4wAAN-lq7kWXZ5wb-b478lU7rfWfn3I6ijtl57lfXyH-
nI5Ju1lHuwapDi2KukCwMwDuQ0zyWfP3Ljv60gfvE0e7KR_qF7V8_ma-9oaiKPNvD7OtT0_8qmnn
2bdvYekAAOR5_ZkovzlFG7_ae5GY2smJ-qrgSx_8Pzf6ffafapqk0Vizr007a0q5t6D1gKABAMAm
gnZWFCUmbl7YGQAA7EO83NPOiqL0zX7tDdQLAAB8SAwlAAAAfxJP-vgNVAEAAPwo6FQqiSoAAIAP
iaEEAADgT_I0aq4sRvD9c-lpLIKH92_hCAB4ztGhYV1BK4ry8_HRUL72wv-7i2b7Z1u35Snv6NAw
_acGZFu4HKpILnbHzpWNNvYGAJ5TVe365wTN8vTEqyTou-NhOF7_O69-ncYf3-6ta-NyCrZ2kMLO
AISeykabc7SuoImaqaafnng10KZm7Uwu3XS0oJSpxInTo7Ai3-v3v5M3_Olv-RF7HgQaI0FzslY3
Un2zKufiyFaW2taarKNTqIxyR8awbeUEtjeIiqCfnnhVbVu2RS-2Dx-f-i2Nv-P616XOdXRo_OH9
W9SzXEwSSI6B3N3X9Nbdm84OmDg2JpT33s8dfpPTPxDJ2v5xv7PTHnlnD04BLgn66YlXfe5cU8iW
strRXKB2LpfD-gMAQEzvRt_dD8kvNK-68e3f0h8_vAjrq0vrq0skYP9JQGN1jiBbd29qtg9cLA1c
LBnHmsk251UUZeDsffLjYr0cAKQSj86rfuf1r-vnYTLpZHuz63M7j09c0Lw1PnGB3KWB5Vle-uK6
8sI-cMLdvVwnziUx264egSabdXTi2Jjmrd3rQ8Z9SQIEDdwW9Npf-ksoX-Jz5S9_eySf25k6muiY
xiL5nAd79nr6xR-67nyod5fIV1PNxmMqirLVy9F9H09ozHj2PnX07vUhtYihZuAaMb0bC-OVhflK
aN7z49u-NbgEasYnLhA1c7FxF64lcWyM_7GNJKfvhX-QG3D3ct2smumYn7xwVj07Oy8N_En-amcD
dq8PiaQBIEvQM7NVztchcDT9uTNjJp10rZfjrK8ura8uEeeSWMYsn7xwVt04cLFEvDxwsUTj3ct1
cqlOpv-i6NlZkIGz9wfO3oc_gGz67rUfkKi5svjK905xUuY0zUGtPTNb1Yv98JKf-_5Pmu2fbd3O
5afdfJJSrbazt8_2HOw-UC_XvarMw-u3Khtterl196az46s9uHX3Jtv43r--XUa5o7z3c4df7PQP
2sqJ09-6o3HW9o-7nZ32yDt7cAqwQ3Ukc3RomF7GBbtpyppt0YuBppq3rhQSU8uKouzs7WeLJW81
DQDwJ7qCXpivsF6Gc_2QLZaME4imW426t8_ZODbmzcSnf_DJtEfe2cPiBIEUNIzsmp3ZTM8d7T5t
5QQWCQDmBA1ctnM0HX36W3-EIgFAjxhK4CCZdJK9LNVqFgbhenFjAgCiQ1zvxsJ8hQQzs1WUSZD2
Zpe93NnbtzDIzt5_p9NNpZ55mRsTABAdYno3ZmarrJqpr4EgpVrNct_f3fwFCggAiOvd4IzMylqd
MzNb1YsjW9mdvX07fTudbiqVxAIFAILWhtXrwnxFbVu2RS8GoCfbhXPODnhk_ZpIWnUk4_y8lY22
SNrWK3ln5018tIJVFDlBL8xXqG3hXAAAcJmY3o2Z2Sr5oUYySEwtowhbd29qtg9cLA1cLBnHXLK6
XXze4rtN8tOMuTRuKJppYd7BtQL5qWPNHL2_IMTEUQLgraMTx8Y44e5erhPhkphtV49AGk0JWj1v
480ckSwJGm-m2Hau0cH3fXTm2Tn96Mzy4FqBXrIJmu1sXwBBA9Mc7D_ws7dvuW_4pcxd9t35UC_Z
mFdTzVyOwRR6j7G_ukRiO-4lZjc1r-K-PiKxnnxFGFwrQNOhJ6Z3Y2G_Qn6okTiZdJLG9XLZ8jjn
x05qjhkCEsfG6I_26CXvXq4bq5mmGcyi-qnnbbyZYz0r4mLakTW72Xkt6-XRmWWoOdKCnpmtzsxW
WV_jWD1pb3bZy4P9BywMQnqlUs_8zI0ZMjTtPHCxRJw7cLFE493LdXKpTlY3WpuXKlhT1iIGtzzv
4FqB-pOAxnr5xgkgHPTdaz8gUXNl8ZXvnWLvESmzmuag1p6ZrerFfnjJz3-3J832z7Zu5-LTUqfO
Fk27Y25ikhW0VB7ev1XZaHv_gbYL55wd8MjyNZG06kjG2XkFi7n1St7hc_6jFbgsHFRHMkeHhull
3CCVVe3CfEVtW7ZFL444rUbdlKPdtDMAwOfoCpqqGc51zdGRtfOR5WuezFvZaHsyb_KjFewLIEJM
78bMbJX8UCPLZNLPVNtq1A-2HzDIPNh-gNqZ9gr3oYXlgdoC64IG9u3c3uzSy3q5PDcxqdY0UfP5
sZPEzoqitDe7oXd0tliCRyTZOVssoQ6hIY4SuGBnQiqVrJfLnQ7fTtVMIY5WjxBlR1PvwOwiVQIh
F-TCfGVmtkr_USazGLiVc7GFEaJpk1ajTpwOB4HoEBPMW5ivoFjAW5vDziBqxAWlPDNbNUiYma3q
xSgxcNDRKAKAoL90K1XtwnxFbVu2RS8GoCdbwy85O2Di1qeoKggBMcE8OBcAAPwlaHgZuMbg0g3y
Yy9JQP-Zdq4vCgjCRxwlAP7h0YVTVLg05kT86MIp6BhEhBhKAPyDnnlFjDy4dAPiBiEjrndjYb5C
gpnZKsoE3OHRhVN67T3lK5IDQLCIGdybma1SO1NfAyCPwaUbRLLEtprCHVy6oelx2BmEj7jBPSJl
4mhqanUCuasXo8RAEE679JIE7H-PvgCEXNDErVS1C-MVtW3ZFr0YABBuqiMZElQ22iSubLRpO4n1
8tk0ri9pof_afaMraKpmOBfIJnHrUxQh0FC90pgIlNOrptz1_hrMxXUPcWFjejdmZqvkh8UHADCG
GlZc6I7MFW47GwkaAABcEK6ducweDIEjjrUFAHAQVpoiAq2OZKhzaX5lo60eh6SxsZsHg78EvTBf
mZmtYrUBAIxhXckaU8_egvn0UmTMsBITzFuYr2AhAgCAm8R7Snlmtkr-9aw9M1vVi1FiAABwXtCs
ahfmK2rbsi16MQAAAGvEDO5RO8O5AADgPnG9GzAyAECE7cI5O92PLF97brQf99sa7Z099rI6krEz
WmWj7W1tY1heAADgTyBoAIDDDFwsDVwsGcfmBjx7n-y4WJziu03y04y5NP9UMq53Y2G_QoKZ2SoW
HABA3M67l_tExCRm2y0Pu3t9yOaDNd7MEfmSoPFmjm3nGn1CTO-GzGyVVTP1NQAAmPI1kbXdcc7e
tylrH-q3J3HBPFbWamvPzFb1YixQACLL7uU6cbQDQ1mSMkvjzZyIo33lcVFBL8xX1LZlW-RiAEDU
GLhYYtVM4t3LdfbSQ4rvNvVETG75B1FBw7kAABFY-3Iutqzm3etDXMy2iEBczP4bt-uEGLwMAAD_
JI4SAADscGT5mpOjvbPn4GiVjXagaxvD8gIAAH8S17uxMF8hwcxsFWUCAAAfCZqomWp6Yb4CUwMA
1Gy9krfTPfHRynOjDb9ka7Rbnz43Wv4TW6OtvOxfQVM7E1kbJLAq52IsXwAAsEbM4B6rV1bWbAL5
GcQAgIgwuFYgP3WsmdNjtKUb5MdekoD_s_29B3xrYPCtARKw-2w7jX1C3OAeK2XYNgps3b3p7ICJ
Y2OoaqR4dGaZBoNrBXrJJmi2a4924RS1MI05iT_6cEpE0INvDTz66a72LD-dpVJmYz8Q07sxM1sl
P6w5AIAgg2sFJ0fTMa_IkTUdTeXLWlgv9gNxLClgzPrqEgnGJy6sry6NT1yg7TQGgPDozLKTo104
pddu1tGPfrrL_vfRT3f1Yl-VM4YlBXoCEQOzDK4V6D8JaGxikKUbRMTEyJpSHly6oefx59LeGhh8
a8Bv-u1J3732AxI1VxZf_d6X77kwXyHBzGw16Gvl89-9SbP9s63bufx0lHfRw-u3Khtterl196Y6
Z311iWp6fXWJypqN9UgcG4OqQs-WK3k73RMfrTw32vBLtka79elzo_U-sTXayssuF7M6kjk6NEwv
YwaprJqpr0EE6SliAIAM4gb3WCmzslYnzMxW9WKUOGSsry5RZbMxiCyJj1acHO3Wp06OtvJyOAVN
3EpVuzBfUduWbdGLQdAh-mX-2XYAgDxignlwLgAAuEwcXgaUxLExFAEA-xBDCQAAAIIGAABggrje
jYX5iqIoM7NVGtNLEBqODg1XFaWy0UYpAPCc6kjm6NAw29J3r-2ARM2VxQhWJJefxrJ4eP8WigCA
53B2VhQlDlUB9bIAAPiBGEoAAAD_pG-tn-8FVQAAAB8ST6WSqIL7dDpdVB5guQJjYigBAAD4kzh3
fbv_GxRFHq_XvqFu-Pb271EZ4EPuHXlR3QhFuKmIGErvJuoKw87At6gXJxThsiKeEzTLT9ZHyI-G
3C0uR68vMMXAxdLAxZJxrJkMgOUlpxn3BIpwgbjBvR_Nb9AKkpj_a_bo9aWfhEtA9dVbZfdynWwS
ErPt6nyaDIBlyCqi-6b6WlYESYAiehIzPiENTk4aC9aR_2YovYiv4V-gpqPNdrSsCDYBirAoaM0a
-Wh8o_fxaDwgSi_4ZyxsGAAsQOw8cLFktqMdRXBpUIRpQWseleTo61lBPWuj9CJbhQQ0JptHvX9I
i4V9BYB6yVlztB1F6IkbH4XSd6-9gF7crv8GFZHN66VvKIrS6XRTqaSiKN-e-j1qAnzLvSMvsssV
inBNEYSY3g0gu-TsBgDAt3aGIjxURBwfwIfbAICgGARIJYYSAAAABA0AAMAEcZGk5soiCXL56Z5p
xjnimYKTqskWS_rGVqOOjw2AJKAILwVNSkDL0TOtZ1kFCyo4ac9as9_Dm51dBzS2-OGBf3h4-xaK
YIqjQ8N2ukMRXgraWhVsHqTi38nyY9Bas7GdDw98YufKRht1MEXVnqOhCBnExI9Hp6bM5adlH49O
rQ8AO0eHykb74f1bdvY1FOE4cfcfWvBs9BafP57LpwhXDa-mBSEAinBe0ORRej6Q_KHn4KSWlwgZ
ubmySKdgYwACwXbh3H-74Fdf_fw--GArKMIbQQeObLEk8u1F4mCRy0_TNaReYaSFy9FceTTT-o7V
W9_OTAGInR_PHld84GgoIgyC5urSatQdn0LGmIGWtXgXZ71pcACwBwawY_evfP4fX1m_tl04B0eH
UhExb08tg3MMuAMrSlM2FzkhJI0MqJ3J5ZHla49Hjz85dBiVCRlxzdZMOsm1JI6Nbd292XO4nmlb
VwrP5U8tdzrdH458V3y09mYXn01Qi3Zk7az6myuLcLQkO1NHbxfOKap2SchThP20MClCW9Cabyj4
2sZpiallU12gY7NOzOWnqRm5mCQYuJLmoJLBsrP7jpanCElpoRK0JFqNerZYYlvmJiax5Rx3NBeo
ncvlsP_OP4bmLDgDHLez_44GYRM0cXSn0720epWqOZVK4jMAYN-OcDQE7QDEyPCyfXL56UjNCzsL
OheODg2xnhmZdDKTTrKBf9IAgJ31HP149PiTQ4ddeDwoQh7xnhntzS4X_CcNWNhLKGno7UwdvV04
p1jqawoowktBgzABO0fEzi47GkDQAMDOcHS0iKEE4SOTTrrWC-jZztTRj0ePPzl0GFUNoaAz6STZ
ujTwTxrQpL3Z5VpKtVq2WGJ-pVqtZy-PzwzY2akBpToaipBHXHy3G29gT9JAT0q12s7ePr3culJI
TC0rirKzt58tlg72H6iXy6hSuO1MHb1dOKdIGBmKkEcM_yHEZIsl1s5qiKYdnzeTTjqSAzs77ujH
o8efHDqMOgeFOEoQYjuLZ7YadQenbm92LbQAqXamjt4unFMkzwIgaOCMnSU5Wu9JJM0CO8PRoSTW
MyOTTmbSSTbwTxqg5WIvS7WahUG4XvbLXqrVqJ23rhSor609HuzsrKMfjx5-cuiwU8sPipBE3732
A5G8bLHUatT9mRZEOp1uKiVrVVEtqtm6UkhMLevdnZuYdOqpuGdQzyvvyz68f6uy0YadLcxbHckc
HRq2tlyhCBnEQvxu0aRUq1nu_7Obv7DcN5P_cgMbnBCaOWzfqOGVnRVFObJ87fHo8SeHDmPX_JY4
ShAydvb27fTtdLqplBVdtje7Zk_IUq1WL5fZvrCz_47eLpxTPH0GYFHQmfRzG5W9ZHeUJ2kgBCeE
nfMAdvaDo6EILwXNva3ey3uSBvxJtlgylX9p9WqrUYedfeJosx2hCNnE4JRIkZha9tsjdTqRO4N9
ZWfq6Mejx7FB-EYcJQAwIJ6NOFoZyWDxQNBAIgf7D_zs7VvuK_mpElPLLrtmu3BO8Z8H-XxyAB8S
65mRSScz6SQb_CcN0HLRuF4uWx7n-NhJzTFNPYD9V3DK0Y9Hjz85dBh2dmH5QRGS6LvXfiCSly2W
Wo26P9OCSKfTTaVkrapSrbazt2_218H_A_fHTtp-qmyxJJ48NzGpKIqzpXh4-1Zlo_03JwbCztWR
zNGhYWvLFYqQQSzE7xZZ6uWyhV7nx046MvvB-gOmMuUdVIqiHFm_9nj0_JNDh2FnEETiKEEoaTXq
2WJJPH9uYtIpV9bLZcGpnToSejp6u3BO8c6PsDOAoIF1RztoZ-GpHZ-Un46GnYEdYj0zMulkJp1k
A-_kAb3qUVEe7D9gkHmw-wAVpbN1NpiandS1mhxZvvZ49PiTQ4dhZxnrDYqQRN_99gORvGyx1GrU
-ZkWRDqdriQ9ZdLJ9maXm_tnN3_xs7fPWfL82EkS0ydR97X5AJ1O99LqVfYuUTM9EuxPp_bh-VuV
jbbnxgyinasjmaNDw9aWKxQhg7hTA2WLJTYId9V8i6byUqlkvVzudDRUyO269mbXvjTZ7qlUstWo
c1PTSWXY2Zgjy9e2C_cU_d4Mop1BaAVN7Rydk82fGCiPc7GFESwjOHVoHA07A38JWlGUrSsF9jIx
tdzpdH21MwFwwdGwM3CQWM_MTDqZSSfZQJPE1DL7szmaYBoAlh39ePT4k0OHYWf7OLupoQiWeM_M
9maXC9S0GvVsscS2zE1MWh5NPA0AO47eLpxTnPNpNO3s_KaGIswJWpBWo97pdC_tXqVqTqVCe6z5
nE7H4pK1_cm8mtcPjo6snYHHgs4WS2zQatSNt5kjm018UiDCpdWrJJibmGRj92f3W2UccXTE7Sy4
Wz1JCzoxwdIbtMj73m5OGmhKtRr912RuYpLKkY2dmronPlQz6_jHo8efHDoMO8vbrZ6khYC4Zmsm
naTx1pUCeysxtdzpdH848l29Edm_BhinGUza3uzCyBz1crlUq9XLZYOcS6tXucCATqebSvX_jvRg
MJ5aHMF5ZTh6u3BOMe-ZyNrZgiJcSwuTIrQFzb5hYmrZOIGl1aiLVKdnmqlJAVGksSjnJiapmucm
Jo0HFLSkyMFgCk-sbNnRkbWzNUV4khZ0Yj1Nqt7nsp-Jk0kDDVGkgSgvrV6ldlZf2p_6J05NJ9vR
j0ePPzl0GHZ2fLd6khYC4iIfoNN57lxKpZIufHX3Jw0x7PJ1fykHaPMcWb62XTin9DIv7Gxht3qS
Fn5Be-XmMHLgSheOT9bT0bCz5U-vSVr4BU1PKr2KdDrdVCpJ-9XJbKNebHZSANx3NOxsTREepgWa
mLMnpF5yKpVkG9lL7lbUTkjgW0c-Hj3_5NBh2NlZRXiSFlzijh_hInfJJSkuGwMXvoW85e7VvPIc
vV04p-zVyLAzCKqgWdX23IRqL1ve2EC24l1Wp1fz9nT049HjsDPwr6BNOVQzmRqZvWs8LMTtrZ1J
7JorvZpXxNGws1OK8CQt5IIW3CokTTOZbdSLrU0KgAuORhEcVITLaYEmhrUFQsbRoeHqSAZ1MEt1
JHN0aBh18BVxlABwpFLJTqdL4yDOe3RouIoPab5oKAIEDYLh6KDPC92AENC39s--gipESoLADs2V
xVx_mv6TRrZF3S4S5-LTdHzazs2r2e4OnU4Xn94T4tCEJ2DFhwNWtVy7pn-1NK3Zt_dc3KVUd0MU
nhBDCQCwjKZhBdtZcYv0NVa5VDsDr4hz17frv0FR5PF66RsoQpiknMtP00uuXU_pNI3E6kxTqtUb
RB5QhJuKiKH0boIKhxWiSCrK5soi6_ueomfz9frqDQg7h1gRcb28n6yP-Gh8g8YkIC3kkt5lc7hG
AEIpYk0pqwPNdq6XQeyVhcWhu57ogkqDbddUB9fODQiT9BY0Bytrtr5sgrqRa0HRAQgNVMcG7Zy1
NS2hVgSXE2WNxEwdlWZhSwk7AxAdd-c0hp4Q1B2jrBFRQVuuC_kIOwMQEX40vmFnv2v2jaxG4sbH
oGZRfrI_otmodwt2BiCUIqaKoLGBN-T8oNaIuLhDT9_99gN6cbv_Gyw72bxe_oaiKJ1ON5VK2hyq
ubLozjPn8tN_mFceqKQxdLlCEa4pghDTuwFklx4ALGBgXOE4PkBYyeWnSdBcWczlp9l-0sjlSJqX
i9l5HZxUdiW56ulV1amXEpyFllHGd4Sj-UAMJQgrZK9q7lhuSzu_q9kB2fE1lR3Qwmq2O1hJg1nY
Y4OtbVAOPABBA1FkWJK4Q974-qyYs2-KjmYQ08vw1RkoihIXP8m5XcftwObKovES4fqy-9w4Nnd4
tlhSN7YadXxs4_-i7Jj0C8oY31sps0uda5f0XdgZaUx3irzviI0WAEGrD221OlnhGo_juYzYzczN
Ze2tuFXCriRuCnaV2z8b-GxhvXdh312GzvTGl1fbnutQxjkkqZI9i_zV7KY2GvuQejFcbF3Qmge4
hZ3Arh7jmK42qV_O3WDqzebyWpf0guqYvq_k-Wz8ZeXN62YZuWI6-kbGdVPX0P-15M7skG00ecRs
FldT4gbj0BxuTHWCt_cqFg0A8o4curWx0YyJ2y86sWpzZVHE0YIDal56deD7Fq8eMhDFQSV9W2Gi
C9ISnQrIEjRXWe5ffKkZj6MeU96XY73PHeZYLgBI2mjQsRRBB5FssSR_ThjHAGiSSSfbm92IF8Hy
RmP-QbQE3WrU8V2BbGBnbDQIGgDgU5oriz58qlx_OnKCzqSTXEvi2NjW3ZtcY3uz6-5oAMgjk05a
WIfWegWR--Hf-zcJzjTH-fA8-3j070NWYSFBa642y0vQ2dFAINwRUGepn7lUq_3s7bMtB-sP1Mtl
1xZzdOwfOLLFknhyq1F3TNAAALWaCTt7_9liSa1p4FuaK4uKouTy0yQQiXP5aZuTruXWSXCmOS7e
K4avFWIy6aQjOUGZVx7ZYknTzpymUclA2DmXn6bCZc3LtbMxVTYNLGBKzRB0_Glvdi20BHdeeXZ2
PDOalfSPozWFqxezsEJ3gbjlI50ENheHs6MBcXe0GvVwz_u_nWm_pHcMeiV9AjEs9S8rXL2Yk7ub
jo5ZONKJRmlgB2dHA5qUajW6t7euFOhuL9VqoZzXDpl0knsFay9uMGZEKulbmiuLepIltzTjnuIW
YS23brZLHB8s3NCNrWZnbz9bLLUa9TDNa5P2Zpd7VAuD7OztdzrdVOqZl7kxI1JJ38Ia1mxshzPN
cQu9IOiwkUknqREM9ja7-_kOZ-sGZV55lGo1RVG2rhQURUlMLZvq_7Obv6iXy6hkpJBxUsZQ1pBB
9yfxi7iJ2L4BmlceO3v7RM2JqeWtKwViavG_nY7FlwpiJU8NniY-bEBniVs43tnA5oJwdjSg9ou4
TVKpZ98ioPNKJTG1rCgKdTS5DOsXBAEWNHWoIzJ1djRAyRZLpvIvrV5tNerBnddNTVNTS9V0uCuJ
TSf4sUwLGoSVTqebSiWjM68jpsYXDCLNlUVFUXL5aRKIx3YmPfavd0lw95_OifeK4WsBACJl51x_
mtiW-ecUzDXSS_prC5hSMwQdRRJTy5Ga1w4H_w940jd8lfShozU9yzYSj6tzNBvlYVrQmXQyk06y
gR2cHQ048kUCNK-UAtbLZcvjnB87ae3VQlNJ35LLT_tJlm3P5ad7StwF4mY7tDe7XGAHZ0cDtIyt
Rj1bLIl3nJuYtPMhvJpXXgEJB-sP7Oztmx3kYP8BRVFSqWeiNPVqQa-kWm6dBGea4-7cI8Sweo4W
8bvlqY-9612zXWKQWlghmrAglIDOK4N6uWyh1-mxk6ikb8nlp1nJ0pgE6n_bUqbc-adj5GeqVxwf
LKzUy_VsseSmULydVxKtRl3wdQhzE5NOuTJklQw9rUbd8TFj4qmZdJL_1JdmcXY0YHnFOCgUz_f1
fOM5-lLBreSpwdPkh21oh7h4anuza3BpFmdHAwY7vFSr7eztq28d7D9wfuykpL3t1bzOkkknyco0
eB31S9FeqCSwSQwlCCuZ9LNNWy_X5yYmubtzE5OsUEIwrzw7s69zsP_A2pLsSymK0t7sOvJqoamk
38gWS_qfPx81jq8VVli5pFLJVqPe6XzZQm3CZQZ3Xql2pk9eL5e51_Feir6a5ggRrKQ-aTXqnLJp
3FxZJEEuP03iXH6atpOYg95S9zWOez5nDJ8qOqRSSfYX_nmdkqPx6_i9lAxpBrGSQYRVp55eWTvn
8tOkC-uvHocNROysKErc7KNn0s_WBQlsrkJnRwMA_I213DoJzjTHg-LMxLmm8jWdy9rc7JgWBU0d
6ohMnR0NAADsk8tPi-uUpLEu5saxMKZ1QQMAQDTRtDBpNGteCDq6dDpdax1TqWQQ50Ul-V9JRVFO
DZ4mwY1H73n_MNliSe8WUa3ev16__tJgBHGbQ9AR4tLqVRLMTUxGYV5J70LfgsRsCyoZCFqNelAe
NWa2QyadzKSTbGAHZ0eLMqVaTSTN8Y3t1byRBZWMFHGzHdqbXS6wg7OjRdzOpVqtXi47MmCn002l
ep_XXs0rlZ7PcGn1KhUliR15I2ff3Q_V1GMtt06CM81xbF6HBQ18SL1cdtCSiqII7m2v5pVKz2eY
m5gUd7T4Gzn77r61c4jJFkviya1GHYKOlqNF0oxtEqB5PcTbdwlTJU8NnibBjUfvuTZpc2Uxl59m
LxVFIS00JoE6tjPvm7-8WxK8_9qfxXtB0BFibmIyUvO68y5uvl2YKukHiKyJgtnYQNOc303x7mt-
ppqWJehMOskG7c2unQI5OxogpFLPqhqReVFJIMPdmu2W7WwN04KmDnVEps6OBgAIImu5dRKcaY77
5JH0RNxcWXTT0aYFDQAAkjg1eJoENx69J2_W5soiVTArXD35knxjcYvw5i--Vrqgs8USG7QadTuV
cnY0QOh0utY6plLJIM6LSvq-kv6BNazZ2A7vvvZnC73MCZr6lG2xbFVnRwMyxOTyhvdqXlTSb6zl
1knwqzu-IsGNR_-5-JlluEtI0Jn0l99460qBvZWYWu50uj8c_a6iKO1NoWPf2dGAvL1NYtd2uFfz
opLAtwgJmnVlYmrZOMHl0QAAXvF--u1-Pov_K235laSWfzz69xB0D1qNerZYYlvmJiYtz_3saAAQ
cvlpFAF1dh-OZj3t57ygybidTpdtSaWSdhzt4GjAEVKpJP0obn4Or_ZFJaPjO0VRmiuL7NHSXFmk
hw2NScDG9k_jrV-ukSDxWr94L9OCdvyTw8j_NEuk5kUlbWKgNknKW8utk_BMc9zOY9PnYWPuOWmj
2u_mSLzWTzUtUdDOHs4hOOohBeg1ypXknMVpjm3nckiLZeWdaY5TTUs6ctTYPFfMEvPDAoKaAQg0
zZVFajRWbXqxh8oTJJef1nwwvbfwl6ABAEDTZewl164nd2_PE-pgbMw9Hs23c5xs-XLPbJc4lhcA
wKbv9MzF3lLHNpW3llu3dpxYju2QeK2fa8mkkyRob3ZJ3N7sknbS0t7sWhR0p9N18AM7OxoAwE08
Ud6Z5rjf6tBq1M12IUZmHc02KopiRdCp1LOBHMHZ0QAA4cCC7wIHkTJrZNpOGq0IGgAAgE2Igomj
Ne2sKEoMZQIAAPfJpJPUziRgZZ1JJ0_fb-Tdaz9ApQAAwFecPt-Y-r9X-j93ENXN134D1wAAABB0
RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=
:: label.qoi
b64$cW9pZgAAAeAAAAEOBAH_--Ho-f39-f39-f3T-sMATPk-wf6iiHnMP-39-f39-BLEP9f_wwBM
0D-AEss-wBLFPxLQP-6iiHnOP-39-f3UEsE-wBLBP8sSwT-IEsQ-xhLGP8kSPxI-3RLFP8YSxT-H
-sMATM8-EsA-Esk-Eto--qKIec4--f39-cQSwT-AEsE-xhLBP8ASwT-GEsI-EsE-yBI-whI-xhLG
P8oSP87_wwBMwD-Q-qKIeT8SP9b_wwBMzz8SP8ASxD-BEsA-EsE-EsA-Ej-AEtA--qKIec4--f39
-cQSwD-CEsA-xhLBP8ASwT-GEsI-EsE-yBI-whI-xhLGP8YSxz-J-sMATD-AEj-L-qKIecE-EsE-
xhLFP8f_wwBMzz-AEj8Swz8Swj-CEj8SwD8SwD8S0D-_ooh5xj8SxT-9-f39xBLAP8ISwD-GEsY-
xhLCP8wSP8ISP8YSxj-GEsA-wxLAP8X_wwBMP8ESP8ASP8v_ooh5PxI-2v7DAEzPPxLAPxLEP8AS
wT8Swj-AEsE-EtA--qKIecU-wRLEP-39-f3EEsA-whLAP8YSPxLCPxI-xhLFP8kSP8ASwT-WEsA-
wxLAP8X_wwBMP8ASP8ESP8v_ooh5xT-GEsU-x-7DAEzPPxLAPxLGPxLAPxLBPxLAPxLAPxLQP-6i
iHnGPxLFP-39-f3EEsA-whLAP8YSPxLCPxI-xhLFP8cSwT-AEsE-xhLGP8YSwD-DEsA-xf7DAEw-
wBI-0P6iiHnEP9b_wwBM0D-AEsE-EsA-wRLBPxLBPxLAPxI-wRLPP-6iiHnOP-39-f3EEsE-wBLB
P8YSxj-GEsU-xxLBP8sSwD-CEsA-xhLHP8b_wwBMwD-vEvs--qKIec4--f39-f393P7DAEz7P-6i
iHnOP-39-f399v7W19r9-f39-f396-6foKYgjIn9-f39-f396jwgO-39-f39-f3qPCA71jz9zjvG
PP39-f399DvCPCA71Tz_Hjc8-c48O8Q8Bv39-f399Dw7wTwgO8ogwjvEPAb90CA7wjwG-f39-f32
IDvAPCA7yCDBPMAgO8Q8BsA-wQY-wQbIP8AGwD-ABj-BBj-BBsM-wQY-Bj8GPwbCP8AGP8EG1SA7
wjwGwP7DAEzdBv39-f391SA7wDwgO8YgwTzCIDvEPAbAPwY-Bj8GPwbAPwbEPwbBPwY-Bj8Gwj8G
xD8GPwY-Bj8GPwbBPwbBPwbXIDvCPAbAEv4AAADbEgb9-f39-dUgO8A8IDvEIME8xCA7xDwGwD8G
PwY-Bj8Gxz-BBj8GPwY-wAbBPwbEP8EGPwY-Bj8GwT-BBj-ABtYgO8I8BsASNT-ZNRIGyf4ApaHZ
Bsv_ooh52QbL-gCyUdkG-f392yA7wDwgO8QgPMMgwDwgO8Q8BsA-Bj8GPwY-BsA-BsY-Bj8GPwY-
BsI-BsQ-BsE-Bj8GPwbDPwY-BtcgO8I8BsD_wwBMNT-ZNRIGyRXZBsv_ooh52QbLJtkG-f392yA7
wDwgO8QgPMEgwjwgO8Q8BsA-wQY-wQbHP8AGwD-ABsA-BsI-BsQ-BsI-wAY-wQY-wAbAP8EG1SA7
wjwGwP7DAEw1P8T_ooh5wT8SwD-BEsA-EsE-xDX_wwBMBsY-BsAVw-4WFhbAFcA-wBXAP8AVwz-A
FcMGyP7-8egGwP6iiHnA-hYWFsESP8ESP8ASwT-AEsM-wRLABsj_--HoBsAmxP4WFhbBJj-BJsM-
wSbEBv39-dsgO8A8IDvEIDwgwTvAIDwgO8Q8Bv3QIDvCPAbA-sMATDX_--Hoxf6iiHk-wBI-Ej8S
P8ISP8U1-sMATAbGP8AGFcL_FhYWFT8VPxXBPxXGPxXDBsj_--HowAb_ooh5wP4WFhYSPxLAPxLA
PxI-Ej8Sxz8SwAbI-v-x6MAGJsT_FhYWJsE-wSbFPybEBv39-dsgO8A8IDvEIDwgO8AgwTwgO8Q8
Bv3QIDvCPAbA-sMATDX_--Hoxf6iiHk-wBI-Ej8SwT-AEj-SFcL_FhYWFT8VP8EVPxXGPxXD-v-x
6MsSwP4WFhbAEsE-EsA-Ej8SPxLFP8ESwP7-8ejLJsT_FhYWwCbAPyY-JsQ-wCbEBv39-dsgO8A8
IDvEIDwgOyDAPMEgO8Q8Bv3QIDvCPAbA-sMATDX_--Hoxf6iiHk-wBI-Ej-BEj-AEj-FNf7DAEwG
xj-ABhXC-hYWFhU-FcE-FT8Vxj8VwwbI-v-x6MAG-qKIecD_FhYWEj8SwD8SwD8SPxI-Ej8Swz8S
wgbI-v-x6MAGJsT_FhYWJsE-Jj8mxT8mxAb9-f3bIDvAPCA7wiDBPCA7IDzCIDvEPAbA-v-x6MEG
P8AGyD8GPwY-wQY-wAbAP8EGwD-ABj-BBsM-wQbAP8AGPwY-Bj-BBj-BBj-ABsE-wAbFIDvCPAbA
-sMATDU-xP6iiHnBPxI-Ej8SwD-BEj-FNf7DAEwGxj8GwBXC-hYWFsAVwD-AFcE-wBXDP8EVwgbI
-v-x6AbA-qKIecD_FhYWEj8SP8ESPxI-Ej-BEsM-wRLABsj_--HoBsAmxP4WFhYmwT8mPybDP8Em
xAb9-f3bIDvAPCA7wSDAPMEgOyDAPMAgwDvEPAbA-v-x6AY-BsA-BsE-BsQ-Bj8GwD8GwD8GPwY-
BsE-BsI-BsQ-Bj8GPwY-Bj8GPwbAPwbBPwbAPwY-Bj8GxyA7wjwGwP7DAEw1P9k1EgbJFdkGy-6i
iHnZBssm2Qb9-f3bIDvAPCA7wSA8wiA7wCDCO8U8BsA-Bj8GwD8GyD8GPwbAPwbAPwY-Bj-ABsA-
wQbAPwbEP8AGwD8GPwY-Bj8GwD8GwT8GwD8GPwY-BscgO8I8BsD_wwBMNT-ZNRIGyRXZBsv_ooh5
2QbLJtkG-f392yA7wDwgO8EgwDzAIMA7yzwGwD8GPwbAPwbBPwbEP8EGwD8GwD8GPwY-BsM-BsA-
BsQ-Bj8GPwY-Bj8GPwbAPwbBPwbAPwY-Bj8GPwbFIDvCPAbA-sMATDXbEgb9-f39-dUgO8A8IDvC
IMI7zDwGwD-BBj-BBsc-wQY-wQY-wQY-wQY-wAbBPwbEPwY-Bj-ABsE-wAbAPwbAP8EGPwY-Bj-B
BsUgO8I8BsAS3Qb91jsG4TsG-f391iA7wDwgO9Q8Bv3QIDvCPAb9_DsG3zsG-f391yA7wDwgO9Q8
Bv3QIDvCPAb9_TvNBsE7zQb9-f3YIDvAPCA71DwG-dAgO8I8Bv39yjsGOwb9-f3nIDvAPCA71DwG
wD-BBj-BBsc-wQY-wQY-BsE-BsE-wQbAP8AGP8EGwz-BBsA-wAY-Bj8GP8EGP8EGP8AGwT-ABsEg
O8I8Bv39yzsG-f396CA7wDwgO9Q8BsA-Bj8GwT8GwD8GxT8GwD8GPwY-BsE-BsE-BsE-BsI-BsQ-
Bj8GPwY-Bj8GPwbAPwbBPwbAPwY-Bj8GwyA7wjwG-f39-f32IDvAPCA7wz-CO8s8BsA-Bj8GP8EG
yD8GwD-BBj8GwT8GwT-ABsA-wQbAPwbEP8AGwD8GPwY-Bj8GwD8GwT8GwD8GPwY-BsMgO8I8BsI-
2Qb93f7-d6jZBv39-dsgO8A8IDvCP8AGwD-AO8o8BsA-Bj8GPwbCPwbFPwbAPwY-Bj8GwT8GwT8G
wz8GwD8GxD8GPwY-Bj8GPwY-BsA-BsE-BsA-Bj8GPwY-BsEgO8I8BsI-2Qb93R3ZBv39-dsgO8A8
IDvCPwY-wAY-O8o8BsA-wQY-wQbIPwbAPwY-Bj-BBj-BBj-BBj-ABsE-BsQ-Bj8GP8AGwT-ABsA-
BsA-wQY-Bj8GP8EGwSA7wjwGwj-G-qKIecE-Ej-BEj-IBv3dHcD_FhYWwR0-wR0-HcE-wR3DPx0-
HcAG-f392yA7wDwgO8H_--HowAY-wAY-wDvJPAb90CA7wjwGwj-GEj8SPxI-wRI-yAb93R3A-hYW
Fh3CPx3APx3CPx3EPx0-HcAG-f392yA7wDwgO8H_--HoBj-CBj87yTz_q1I2-dAgO8I8BsI-xhLB
PxI-wRI-yAb93R3A-hYWFsAdwT8dwD8dwj8dxD-BHcAG-f392yA7wDwgO8D_--HowAY-wgY-xjvC
PAr90CA7wjwGwj-GEj8SPxI-wRI-yAb93R3A-hYWFh3CPx3APx3CPx3GPx3ABv39-dsgO8A8IDvA
-v-x6AbAPwY-Bj8GPwY-Bj8GPzvCPArAP8EKP8EKxz-BCj8KwT8KxT-ACsE-wAo-wArAP8EKwD-A
CtkgO8I8BsI-xhI-Ej8SwT8SwT-GBv3dHcD_FhYWHcE-wR0-wR3APx3GPx3ABv39-dsgO8A8IDvA
-v-x6MYGP8IGP8A7wjwKwD8KPwrBPwrAPwrEPwo-Cj8KwT8KxT8KPwo-Cj8KPwo-Cj8KwT8K2yA7
wjwGwj-ZBv3dHdkG-f392yA7wDwgO8c-Bj-CBj87wzwKwD8KPwrAP8AKxz-BCj8KwT8KxT8KPwo-
Cj8KPwo-Cj-ACsA-wQrZIDvCPAbCP9kG-d0d2Qb9-f3bIDvAPCA7xz-ABj-ABj-AO8M8CsA-Cj8K
wT8KwD8KxD8KPwo-CsE-CsU-Cj8KPwo-Cj8KPwo-CsM-CtkgO8I8Bv39-f399iA7wDwgO8g-Bj-A
Bj87xDwKwD-BCj-BCsc-Cj8KP8EKP8EKwz8KPwo-wArAP8EKP8EKP8AK2iA7wjwG5TsG-fM7Bv39
-dYgO8A8IDvIP8AGwD-AO8Q8Cv3QIDvCPAbmOwb98TsG-f391yA7wDwgO8k-wjvFPAr90CA7wjwG
5zvNBsE7-d8G-f392CA7wDwgO9Q8Bv3QIDvCPAb2OwY7Bv39-f35IDvAPCA71DwGwD-BBj8GPwb9
xyA7wjwG9zsG-f39-fogO8A8IDvUPAbAPwY-Bj8GPwbAPwb9xCA7wjwG-f39-f32IDvAPCA71DwG
wD8GPwY-wQbHP8EGP8EGP8EG8SA7wjwGwjzZBsv_-4Vt2f4eNzz9-f397SA7wDwgO9Q8BsA-Bj8G
wT8GwD8G-cQgO8I8BsI82QbL-v_Fbdn_Hjc8-f39-e0gO8A8IDvUPAbAP8EGwT8G-ccgO8I8BsI8
xP5fV088LjwuwTzDLsE8xAbL-v_FbcD_FhYWwQbAP8AGPwY-BsA-wAbDP8EGwP4eNzz9-f397SA7
wDwgO9Q8Bv3QIDvCPAbCPMQuPC48wC48xC48LjzEBsv_-4VtwD8GwT8GwT8GPwY-Bj8Gwz8Gwv4e
Nzz9-f397SA7wDwgO9Q8Bv3QIDvCPAbCPMQuPC48wC48xC48LjzEBsv_-4VtwD-ABsA-BsE-wQY-
Bj8Gwz-BBsD_Hjc8-f39-e0gO8A8IDvUPAb90CA7wjwGwjzELsE8wC48xC48LjzEBsv_-4VtwD8G
wT8GwT8GPwY-Bj8GxT8GwP4eNzz9-f397SA7wDwgO9Q8BsD_--HowQY-wQb9xyA7wjwGwjzELsE8
wC48xC7BPMQGy-7-hW3A-hYWFsEGwD-ABj8GPwY-wAbEP8EGwP4eNzz9-f397SA7wDwgO9Q8BsD_
--HoBj8GPwbCPwb9xCA7wjwGwjzZBsv_-4Vt2f4eNzz9-f397SA7wDwgO9Q8BsA-Bj8GP8EGxz-B
Bj-BBj-BBvEgO8I8BsI82QbL-v_Fbdn_Hjc8-f39-e0gO8A8IDvBPME7PMA7wTzAOzzBO8I8BsA-
Bj8GwT8GwD8G-cQgO8I8Bv39-f399iA7wDwgO8I8O8A8Ozw7PDvCPDvDPAbAP8EGP8EG-ccgO8I8
BuU7BuE7Bv39-f3oIDvAPCA7wjw7wDw7PDs8wTvAPDvDPAb90CA7wjwG5jsG3zsG-f39-ekgO8A8
IDvCPDvAPDs8O8E8O8A8O8M8Bv3QIDvCPAbnO80GwTvNBv39-f3qIDvAPCA7wTzBOzw7PDs8wDvB
PDvDPAb90CA7wjwG9jsGOwb9-f39_SA7wDwgO9Q8BsA-wQY-Bv3JIDvCPAb3Owb9-f39_iA7wDwg
O9Q8BsA-Bj8GPwbCPwb9xCA7wjwG-f39-f32IDvAPCA71DwGwD8GPwY-wQbHP8EGP8EGP8EG8SA7
wjwGwjzZBsv_-6MA2Qb9-f397SA7wDwgO8UuwTsuwTvGPAbAPwY-Bj8GPwbAPwb9xCA7wjwGwjzZ
Bssh2Qb9-f397SA7wDwgO8UuOy47wS47xjwGwD-BBj-BBv3HIDvCPAbCPMQuPC48LsE8wy7APMUG
yyHB-hYWFsAhPyE-IT-BIT-BIcM-IcIG-f39-e0gO8A8IDvFLjsuO8AuwDvGPAb90CA7wjwGwjzE
LjwuPMAuPMUuPMUGyyHAPyHBPyE-IT8hPyE-IT8hwz8hwgb9-f397SA7wDwgO8UuOy47wS47xjwG
-dAgO8I8BsI8xC48LjzALjzFLjzFBsshwD-BIT-BIT-BIT-BIcM-wSHABv39-f3tIDvAPCA7xS7B
Oy7BO8Y8Bv3QIDvCPAbCPMQuwTzALjzFLjzFBsshwj8hPyE-IT8hPyE-IcU-IT8hwAb9-f397SA7
wDwgO9Q8BsD_--HowQY-wQb9xyA7wjwGwjzELsE8wC48xC7BPMQGyyHA-hYWFsAhwD8hPyE-IT8h
PyHFP8EhwAb9-f3YEsEGEsAGwBLABsQSwQbAEsAGEsAGwBIGEgYSBsESwQbqIDvAPCA71DwGwP7-
8egGPwbBPwbAPwb9xCA7wjwGwjzZBssh2Qb9-f3YEgYSBhIGEgYSBhIGwxLBBhIGEgYSBhIGEgYS
BhIGwRIGwhIG5yA7wDwgO9Q8BsA-Bj8GwT8Gxz-BBj-BBj-BBvEgO8I8BsI82QbLIdkG-f392BLB
BhIGEgYSBhIGwxIGEgYSBhIGEgYSBhIGEgYSBsESwAbrIDvAPCA71DwGwD8GPwbBPwbAPwb9xCA7
wjwG-f39-eESBhIGEgYSBhIGEgbDEgYSBhIGEgYSBhIGEgYSBhIGwRIGwhIG5yA7wDwgO9Q8BsA-
wQbBPwb9xyA7wjwG-f39-eESBhIGEsEGEsEGwxIGEgYSwAbAEsEGwBLABhLBBhLBBuogO8A8IDvU
PAb90CA7wjwG-f39-f32IDvAPCA71DwG-dAgO8I8Bv39-f399iA7wDwgO9Q8Bv3QIDvCPAb9-f39
-fYgO8A8IDvUPAbAP8EGP8EG-ccgO8I8Bv39-f399iA7wDwgO9Q8BsA-Bj8GPwY-BsA-Bv3EIDvC
PAb9-f39-fYgO8A8IDvUPAbAPwY-Bj-BBsc-wQY-wQY-wQbxIDvCPAbCPNkG-f39-cIV0wbDJtMG
wxLTBsggO8A8IDvGPMM7xzwGwD8GPwY-Bj8GwD8G-cQgO8I8BsI82Qb9-f39whXTBsMm0wbDEtMG
yCA7wDwgO8Y8wzvHPAbAP8EGP8EG-ccgO8I8BsI8xC48LjwuwTzDLsE8xAb9-f39whXE-hYWFsAV
wD-AFcA-wBXDBsMmxT-BJj-BJsUGwxLBP8ESP8ESP8ASwT-AEsEGyCA7wDwgO8Y8wzvHPAb90CA7
wjwGwjzELjwuPMAuPMYuPMQG-f39-cIVwz8VPxU-FcE-FcUGwybFPybBP8EmxQbDEsE-Ej8SwD8S
wD8SPxI-EsMGyCA7wDwgO8Y8wzvHPAb90CA7wjwGwjzELjwuPMAuPMQuwTzEBv39-f3CFcM-FT8V
P8EVPxXFBsMmxT-AJsA-Jj8mxQbDEsE-wBLBPxLAPxI-Ej8SwwbIIDvAPCA7xhXDO8c8Bv3QIDvC
PAbCPMQuwTzALjzELjzGBv39-f3CFcM-FT8VwT8VPxXFBsMmxT8mwT8mPybFBsMSwT8SPxLAPxLA
PxI-Ej8SPxLBBsggO8A8IDvGFcM7xzwGwP7-8ejBBj-BBv3HIDvCPAbCPMQuwTzALjzELsE8xAb9
-f39whXD-hYWFsAVwD-AFcE-wBXDBsMmxT8mwT8mPybFBsMSwT8SPxI-wRI-Ej8SP8ESwQbIIDvA
PCA7xhXDO8c8BsD_--HoBj8GPwY-BsA-Bv3EIDvCPAbCPNkG-f39-cIV0wbDJtMGwxLTBsggO8A8
IDvGFcM7xzwGwD8GPwY-wQbHP8EGP8EGP8EG8SA7wjwGwjzZBv39-f3CFdMGwybTBsMS0wbIIDvA
PCA7xhXDO8c8BsA-Bj8GwT8GwD8G-cQgO8I8Bv39-f399iA7wDwgO8YVwzvHPAbAP8EGwT8G-ccg
O8I8Bv39-f399iA7wDwgO8YVwzvHPAb90CA7wjwG-f39-f32IDvAPCA7xhXDO8ggBv3OIDvDPAb9
-f394R3TBsP_-4Vt0-4eNzzDIdMGyCA7wDwgO8YVwzvJIP3OO8Q8Bv39-f3hHdMGw-7-hW3T-h43
PMMh0wbIIDvAPCA7xhXDO-3fPAb9-f394R3B-hYWFsEdP8EdPx3BP8EdwQbD-v_FbcE-wQbAP8AG
PwY-BsA-wAbB-h43PMMhwj-AIT8hPyE-wSE-wSHBBsggO8A8IDvGFcM7-d88Bv39-f3hHcE-HcI-
HcA-HcI-HcIGw-7-hW3BPwbBPwbBPwY-Bj8GPwbB-h43PMMhwT8hwT8hPyE-IT8hPyE-IcEGyCA7
wDwgO8YVwzv93zwGwjzZBv39-f3CHcE-wB3BPx3APx3CPx3CBsP_-4VtwT-ABsA-BsE-wQY-Bj8G
wf4eNzzDIcE-wSE-wSE-wSE-wSHBBsggO8A8IDvGFcM7-d88BsI82Qb9-f39wh3BPx3CPx3APx3C
Px3CBsP_-4VtwT8GwT8GwT8GPwY-Bj8Gwf4eNzzDIcM-IT8hPyE-IT8hPyHDBsggO8A8IDv97DwG
wjzELjwuPC7BPMMuwTzEBv39-f3CHcE-HcE-wR0-wR3APx3CBsP_-4VtwT-BBsA-wAY-Bj8GP8AG
wv4eNzzDIcE-wCHAPyE-IT8hPyE-IcMGyCA7wDwgO-3sPAbCPMQuPC48wC48xi48xAb9-f39wh3T
BsP_-4Vt0-4eNzzDIdMGyCA7wDwgO-3sPAbCPMQuPC48wC48xS7APMQG-f39-cId0wbD-v_FbdP_
Hjc8wyHTBsggO8A8IDvFLsE7-eI8BsI8xC7BPMAuPMYuPMQG-f39-f3XIDvAPCA7xC47wS47Ljsu
O-3dPAbCPMQuwTzALjzELsE8xAb9-f39-dcgO8A8IDvELjvDLjsuO-3dPAbCPNkG-f39-f3XIDvA
PCA7xC47wy7BO-3dPAbCPNkG-f39-f3XIDvAPCA7xC47wS47wS47-d08Bv39-f399iA7wDwgO8Uu
wTvCLjv93TwG-f39-f32IDvAPCA7-ew8Bv39-f399iA7wDwgO-3tIAb9-f39-fQgO8E8IDv97iD9
-f39-fQ7wjwgO-39-f39-f3qPCA7-f39-f39-eo8IDv9-f39-f396jz9-f39-f397SD9-Twg-f39
6Dwg-fw8IDv9-DwgO-39-ec8IDv9_zwgO8L_dU6X-fX_wsPHwTwgO8D_--Ho-f394jvBPCA7wP51
Tpf99f7Cw8fCPCA7wf51Tpf99-7Cw8fAPCA7P-39-eQ7wDwgO-51Tpf99-7Cw8fBPCA7wf51TpfC
P8E7P8A7wT-AOz-BO8M-wTv93P7Cw8fAPCA7P8MSwD8SPxI-EsA-wBLBPxI-Ej8SwT-AEsA-EsE-
EsE-EsE-EsE--f3zO8A8IDv_dU6Xwj-BOz-AO8E-wDs-wTvDP8E7-dz_wsPHwTwgO8H_dU6Xwj87
Pzs-Oz87PzvBPzs-O8M-Oz87wj-DO-3T-sLDx8A8IDs-whI-wRI-Ej8SPxI-wBI-wBI-Ej8SP8ES
P8ISP8ISPxI-wRI-Ej-9-fM7wDwgO-51TpfCPzs-Oz87Pzs-O8E-Oz87xT87wj-DO-3T-sLDx8E8
IDvB-nVOl8I-wTs-Oz87P8E7P8A7xD87PzvDP8E7-dT_wsPHwDwgOz-CEsE-EsE-Ej8SP8ASP8AS
wT8SwD-AEsE-wBI-wRI-wBLAP8ASwD-9-fQ7wDwgO-51TpfCP8E7Pzs-Oz-BOz-AO8Q-wTvDP8E7
-dT_wsPHwTwgO8H_dU6Xwj87Pzs-Oz87wT87Pzs-O8M-Oz87xD87-dX_wsPHwDwgOz-EEj-BEj8S
PxI-wBI-wBI-Ej8SP8MSP8ASP8ASP8ESP8ESPxI--f3zO8A8IDv_dU6Xwj87Pzs-Oz87wT87Pzs-
O8M-O8Y-O-3V-sLDx8E8IDvB-nVOl8I-Oz87P8E7P8A7wD87PzvDP8E7-dz_wsPHwDwgOz-CEsA-
wBLBPxI-Ej-AEj-AEj8SPxLBPxLAP8ASwT8SwT8SwT8SPxI--f3zO8A8IDv_dU6Xwj87Pzs-wTs-
wDvAPzs-O8M-wTv93P7Cw8fBPCA7wf51Tpf99-7Cw8fAPCA7P-39-eQ7wDwgO-51Tpf99-7Cw8fB
PCA7wv51Tpf99f7Cw8fBPCA7wD-9-f3iO8E8IDvA-nVOl-31-sLDx8I8IDv9-DwgOz-9-f3kO8A8
IDv9_zwgO-38PCA7-f395zwgO-37PCA7-fw8IDvUPP39_DvVPCA7-fs8IDvJLsE7yC7AO8ouwDvI
LsE7zgbFO_48IDvTPAb9-fg8O9Q8IDvHLsE7yC7AO8ouwDvILsE7zgbFO_88IDvJLjsuO8guOy47
yC47yi47LjvOBjvDBjvBLjvCLsA7wC7AOy7BO9w8IDvSPAb9-fogO9M8IDvHLjsuO8guOy47yC47
yi47LjvOBjvDBjvBLjvCLsA7wC7AOy7BO908IDvJLsE7yC47LjvILsE7yC7AO88GO8MGO8EuO8Eu
Oy47LjsuOy47LjvcPCA70jwG-f36IDvTPCA7xy7BO8guOy47yC7BO8guwDvPBjvDBjvBLjvBLjsu
Oy47LjsuOy473TwgO8kuOy47yC47LjvKLjvILjsuO84GO8MGO8EuO8EuOy47LjsuOy7BO9w8IDvS
PAb9-fogO9M8IDvHLjsuO8guOy47yi47yC47LjvOBjvDBjvBLjvBLjsuOy47LjsuwTvdPCA7yS47
LjvILsE7yC7AO8kuOy47zgY7wwY7wS47wS47LjsuOy47LjvePCA70jwG-f36IDvTPCA7xy47LjvI
LsE7yC7AO8kuOy47zgY7wwY7wS47wS47LjsuOy47LjvfPCA7-cUGO8MGO8EuwTsuwDvALsA7wC47
3jwgO9I8Bv39_iA70zwgO-3DBjvDBjvBLsE7LsA7wC7AO8AuO988IDv9xQbFO_48IDvSPAb9-fog
O9M8IDv9wwbFO_88IDviBsM7-dM8IDvSPAb9-fogO9M8IDv9_zwgO_EGxTv90jwgO9I8Bv39_iA7
0zwgO-37PCA7xD-EBj-KBj-HBv7-zKrDBjw-xgY-xDv9wjwgO9I8Bv39_iA70zwgO8I-xAY-ygY-
ygY-ygY-xDv9wzwgO8oGO8oGO8cGxTw7xgY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9
yTwgO8oGO8oGO8gGwzzAO8YGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvK
BjvJPAY8wTvHBjv9yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7
-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9yTwgO8g-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-
wAY-wDv9xjwgO9I8Bv39_iA70zwgO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xzwgO8oG
O8oGO8oGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9
yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvSPAb9-fog
O9M8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7
ygY7ygY7-ck8IDvIP8AGP8A7xj-ABj-AO8Y-wAY-wDvGP8AGP8A7-cY8IDvSPAb9-fogO9M8IDvG
P8AGP8A7xj-ABj-AO8Y-wAY-wDvGP8AGP8A7-cc8IDvKBjvKBjvKBjvKBjv9yDwgO9I8Bv39_iA7
0zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvK
BjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvK
BjvKBjvKBjvKBjv9yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7yD-ABj-AO8Y-wAY-
wDvGP8AGP8A7xj-ABj-AO-3GPCA70jwG-f36IDvTPCA7xj-ABj-AO8Y-wAY-wDvGP8AGP8A7xj-A
Bj-AO-3HPCA7ygY7ygY7ygY7ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9yTwgO8oG
O8oGO8oGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9
yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7xj-CBj-CO8I-wgY-wjvCP8IGP8I7wj-C
Bj-CO-3EPCA70jwG-f36IDvTPCA7xD-CBj-CO8I-wgY-wjvCP8IGP8I7wj-CBj-CO-3FPCA7ygY7
ygY7ygY7ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3I
PCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO9I8Bv39_iA7
0zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvK
BjvKBjv9yTwgO8g-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xjwgO9I8Bv39_iA70zwgO8Y-
wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xzwgO8oGO8oGO8oGO8oGO-3IPCA70jz_AOQ2-f36
IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO9I8Bv39_iA70zwgO8gGO8oG
O8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9yTwg
O8oGO8oGO8oGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvIP8AGP8A7xj-A
Bj-AO8Y-wAY-wDvGP8AGP8A7-cY8IDvSPAb9-fogO9M8IDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDvG
P8AGP8A7-cc8IDvKBjvKBjvKBjvKBjv9yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7
ygY7yAbDO8gGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvHBsU7xwY7
ygY7-cg8IDvSPAb9-fogO9M8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8cGFMMGPDvGBjvKBjv9yDwg
O9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7yD-ABj-AO8UGxTw7xD-ABj-AO8Y-wAY-wDv9
xjwgO9I8Bv39_iA70zwgO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xzwgO8oGO8gGwzzA
O8YGO8oGO-3IPCA70jwG-f36IDvTPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvJPAY8wTvHBjvKBjv9
yDwgO9I8Bv39_iA70zwgO8gGO8oGO8oGO8oGO-3JPCA7yAbDO8gGO8oGO8gGwzv9xjwgO9I8Bv39
_iA70zwgO8YGwzvGBsM7xgbDO8YGwzv9xzwgO8cGxTvHBjvKBjvHBsU7-cU8IDvSPAb9-fogO9M8
IDvFBsU7xAbFO8QGxTvEBsU7-cY8IDvEP8EGFMMGPD-GBj-KBj-HBhTDBjw-wDv9wjwgO9I8Bv39
_iA70zwgO8I-wQYUwwY8P8MGFMMGPD-DBhTDBjw-wwYUwwY8P8A7-cM8IDvHBsU8O90GxTw7-cQ8
IDvSPAb9-fogO9M8IDvFBsU8O8MGxTw7wwbFPDvDBsU8O-3FPCA7yAbDPMA73gbDPMA7-cQ8IDvS
PAb9-fogO9M8IDvGBsM8wDvEBsM8wDvEBsM8wDvEBsM8wDv9xTwgO8k8wzvgPMM7-cU8IDvSPAb9
-fogO9M8IDvHPMM7xjzDO8Y8wzvGPMM7-cY8IDv9-DwgO9I8Bv39_iA70zwgO-37PCA7yTzBO8Y8
Ozw7PME7wjzBOzzBOzzBO8Q8wTv9xzwgO9I8Bv39_iA70zwgO8c8wTvIPME7yDzBO8g8wTv9yDwg
O8k8Ozw7xjw7PDs8Ozw7xDw7PDvBPDvGPDs8O-3HPCA70jwG-f36IDvTPCA7xzw7PDvIPDs8O8g8
Ozw7yDw7PDv9yDwgO8k8Ozw7xjzBOzw7PDvCPME7PME7PME7xDw7PDv9xzwgO9I8Bv39_iA70zwg
O8c8Ozw7yDw7PDvIPDs8O8g8Ozw7-cg8IDvJPDs8O8g8Ozw7PDvCPDvDPDvBPDvEPDs8O-3HPCA7
0jwG-f36IDvTPCA7xzw7PDvIPDs8O8g8Ozw7yDw7PDv9yDwgO8k8wTvIPDs8wTvCPME7PME7PME7
xDzBO-3HPCA70jwG-f36IDvTPCA7xzzBO8g8wTvIPME7yDzBO-3IPCA7-fw8IDvSPAb9-fogO9M8
IDv9_zwgO-38PCA70jwG-f36IDvTPCA7-fs8IDv9-DwgO9I8Bv39_iA70zwgO-37PCA7-fw8IDvS
PAb9-fogO9M8IDv9_zz9-cEgO9I8Bv39_iA70zz9-cAg-f08IDvSPAb9-fogO9M8IP39wDv9-Dwg
O9I8Bv39_iA70zwgO-37PCA7wv51Tpf99f7Cw8fBPCA70jwG-f36IDvTPCA7wP51Tpf99f7Cw8fC
PCA7wf51Tpf99-7Cw8fAPCA70jwG-f36IDvTPCA7-nVOl-33-sLDx8E8IDvB-nVOl8I-wTs-wDvB
P8A7P8E7wz-AO-3d-sLDx8A8IDvTIAb9-fggO9Q8IDv_dU6Xwj-BOz-AO8E-wDs-wTvDP8E7-dz_
wsPHwTwgO8H_dU6Xwj87Pzs-Oz87PzvBPzs-O8Q-O8M-wzv90-7Cw8fAPCA71CD9-fg71TwgO-51
TpfCPzs-Oz87Pzs-O8E-Oz87xT87wj-DO-3T-sLDx8E8IDvB-nVOl8I-wTs-Oz87P8E7P8A7xT87
xD-BO-3U-sLDx8A8IDv9-f3nPCA7-nVOl8I-wTs-Oz87P8E7P8A7xT-AO8M-wTv91P7Cw8fBPCA7
wf51TpfCPzs-Oz87PzvBPzs-Oz87xD87xT87-dX_wsPHwDwgO-39-ec8IDv_dU6Xwj87Pzs-Oz87
wT87Pzs-O8U-O8Q-O-3V-sLDx8E8IDvB-nVOl8I-Oz87P8E7P8A7wD87PzvDP8E7-dz_wsPHwDwg
O-39-ec8IDv_dU6Xwj87Pzs-wTs-wDvAPzs-O8M-wTv93P7Cw8fBPCA7wf51Tpf99-7Cw8fAPCA7
3S7hO8Mu4TvJLv3QO9w8IDv_dU6X-ff_wsPHwTwgO8L_dU6X-fX_wsPHwTwgO90u4TvDLuE7yS79
0DvcPCA7wP51Tpf99f7Cw8fCPCA7-fw8IDvdLsQ7LjsuwDvALjsuwTsuOy47wS47wS7EO8MuyjvB
LjvBLjvALss7yS7dO8AuwDvBLjvBLjvBLuA73DwgO-37PCA7-fw8IDvdLsQ7LjsuOy47LjsuwTsu
Oy47wS47LsY7wy7KOy47LjsuOy47LjsuyjvJLt07LjsuOy47LjvBLjsu4jvcPCA7-fs8IDv9-Dwg
O90uxDsuOy47LjsuOy7BOy47LjsuOy47wC7FO8MuyjvBLjvBLjsuOy7KO8ku3TsuOy47wS47Ljsu
O8Au4TvcPCA7-fs8IDvJLsE7yC7AO8ouwDvILsE7zgbFO_48IDvdLsQ7wS47LjsuOy7BOy47Ljsu
Oy47LsY7wy7KOy7BOy47LjsuOy7KO8ku3TsuOy47LjsuOy47Ljsu4jvcPCA7xy7BO8guwDvKLsA7
yC7BO84GxTvvPCA7yS47LjvILjsuO8guO8ouOy47zgY7wwY7wS47wi7AO8AuwDsuwTvcPCA73S7F
Oy7AO8AuwDvBLsA7wC47LjsuO8EuxDvDLso7LsE7LjsuOy47Lso7yS7dOy47LjsuOy47LjsuO8Eu
4DvcPCA7xy47LjvILjsuO8guO8ouOy47zgY7wwY7wS47wi7AO8AuwDsuwTvdPCA7yS7BO8guOy47
yC7BO8guwDvPBjvDBjvBLjvBLjsuOy47LjsuOy473DwgO90u4TvDLuE7yS790DvcPCA7xy7BO8gu
Oy47yC7BO8guwDvPBjvDBjvBLjvBLjsuOy47LjsuOy473TwgO8kuOy47yC47LjvKLjvILjsuO84G
O8MGO8EuO8EuOy47LjsuOy7BO9w8IDvdLuE7wy7hO8ku-dA73DwgO8cuOy47yC47LjvKLjvILjsu
O84GO8MGO8EuO8EuOy47LjsuOy7BO908IDvJLjsuO8guwTvILsA7yS47LjvOBjvDBjvBLjvBLjsu
Oy47LjsuO948IDv9-f3nPCA7xy47LjvILsE7yC7AO8kuOy47zgY7wwY7wS47wS47LjsuOy47Ljvf
PCA7-cUGO8MGO8EuwTsuwDvALsA7wC473jwgO-39-ec8IDv9wwY7wwY7wS7BOy7AO8AuwDvALjvf
PCA7-cUGxTvuPCA77j87-f30PCA7-cMGxTvvPCA7-fw8IDv9_Tz9yDvgPCA7-fs8IDv9-DwgO-35
PP3IO_A8IDv9_zwgO8Q-xAY-ygY-ygY-ygY-xDv9wjwgO_U-O88-O-08wgbBPAY8wQY8xQbAPMEG
wDwGwDzABsE8wAbAPN874DwgO8I-xAY-ygY-ygY-ygY-xDv9wzwgO8oGO8oGO8oGO8oGO-3IPCA7
6-43TFCLScO1xzviPzvePML_Hjc8PAY8BjzBBjzFBjwGPAY8BjwGPAY8BjzBBjzhO_A8IDvIBjvK
BjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA76f43TFCLScIUBsK1xzvgPzvePML_Hjc8wTwG
PMEGPMUGPAY8BjwGPAY8BjwGwDzABsE83zvgPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvK
Bjv9yDwgO_gGwv51TpfAFAbE-sLDx9k-O8M-O8M-O9g8wgY8BjwGPMEGPMUGPAY8BjwGPAY8BjwG
PMMGPN874DwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvnBsH_dU6XwhQGxf7C
w8f9wTzCBjwGPAbBPAbBPMMGPAY8BsA8wAbBPAbBPAbAPOA74DwgO8gGO8oGO8oGO8oGO-3JPCA7
yD-ABj-AO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO-3GPCA75gbB-nVOl8MUBsb_wsPH2wbDO9w8-cg7
4DwgO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xzwgO8oGO8oGO8oGO8oGO-3IPCA74D87
wv43TFCLScD_dU6XxBQGxrXH-sLDx8I-O9MGi0nBFAbBtcc72jz9yDvgPCA7yP4eNzw7ygY7ygY7
ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO_UGwP51TpfFFAbHPP7Cw8fWBsMUBsM7-f3HPCA7yAY7
ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO_T_N0xQi0nA-nVOl8UUBse1x-7Cw8fRPzvB
-h43PMQUBsQ7wT87-f3CPCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO_QGwP51
TpfGFAbIPP7Cw8fT-jdMUItJxBQGxLXHO-39xTwgO8j_Hjc8O8oGO8oGO8oGO-3JPCA7yD-ABj-A
O8Y-wAY-wDvGP8AGP8A7xj-ABj-AO-3GPCA75AbA-nVOl8YUBsg8-sLDx9MGxRQGxTw7-f3EPCA7
xj-ABj-AO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO-3HPCA7ygY7ygY7ygY7ygY7-cg8IDvkBsD_dU6X
xhQGyDz_wsPH0gbGFAbGO-39xDwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvk
BsD_dU6Xxf69mt8GyTz_wsPH0gbGFAbGPDv9-cM8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oGO8oG
O8oGO-3IPCA75AbA-nVOl8QHBso8-sLDx9IGxhQGxjw7-f3DPCA7yAY7ygY7ygY7ygY7-ck8IDvK
BjvKBjvKBjvKBjv9yDwgO_T_N0xQi0nA-nVOl8IHBsq1xzz_wsPH0v4eNzzPPDv9-cM8IDvIBjvK
BjvKBjvKBjv9yTwgO8g-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9xjwgO_A-O8IGwP51TpfB
BwbLPMD_wsPHwD87zD87wAbPPDs-O-39wTwgO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDv9
xzwgO8oGO8oGO8oGO8oGO-3IPCA75f43TFCLScD_dU6XBwbLtcc8-sLDx9T_Hjc8zTzAO-39wzwg
O8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDvmBsAHBsw8wDvU-jdMUItJy7XHPDvW
NcU73zXFO-k8IDvI-h43PDvKBjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA75wbNPMA71gbL
PMA71jU7wzU7wS47LjsuwTsuwDvALsE7zTU7wzU7wS7BOy7BOy7BOy7BOy7BO8AuwDvfPCA7yAY7
ygY7ygY7ygY7-ck8IDvGP8IGP8I7wj-CBj-CO8I-wgY-wjvCP8IGP8I7-cQ8IDvoBss8wDvYBsk8
wDvXNTvDNTvBLjsuO8AuO8AuOy47LjvPNTvDNTvBLjsuOy47wi47wC47LjvALjvALjvhPCA7xD-C
Bj-CO8I-wgY-wjvCP8IGP8I7wj-CBj-CO-3FPCA7ygY7ygY7ygY7ygY7-cg8IDvlPzvB-jdMUItJ
x7XHPMA7PzvYBotJxbXHPMA72DU7wzU7wS47LjvALjvALjsuOy7AO841O8M1O8EuwDvALsA7wS47
wC7AO8EuO8AuO_E8IDvI-h43PDvKBjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA75D87wzz_
N0xQi0nDtcc8wTvBPzvUPzvBPP4eNzzDPME7PzvXNTvDNTvBLsE7wC47wC47LjsuO881O8M1O8Eu
Oy47LjvCLjvALjsuO8AuO8AuOy473zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8
IDvjPzvGPMU7xD872TzDO9s1O8M1O8EuwTsuwTsuwTsuwTvNNTvDNTvBLjsuOy7BO8AuO8AuOy47
LsE7LsE73zwgO8gGO8oGO8oGO8oGO-3JPCA7ygY7ygY7ygY7ygY7-cg8IDv9_TXFO981xTv5PCA7
yAY7ygY7ygY7ygY7-ck8IDvIP8AGP8A7xj-ABj-AO8Y-wAY-wDvGP8AGP8A7-cY8IDv9-f3nPCA7
xj-ABj-AO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO-3HPCA7ygY7ygY7ygY7ygY7-cg8IDv9-f3nPCA7
yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO-39-ec8IDvIBjvKBjvKBjvKBjv9yTwg
O8oGO8oGO8oGO8oGO-3IPCA75TzRO9M80TvsPNE7wzzRO_Y8IDvIBjvKBjvKBjvKBjv9yTwgO8oG
O8oGO8oGO8oGO-3IPCA75TzEBsE8BsE8xDvTPMYGwTzGO9UuwTsuOy47LsA7wC7BO8Y8zAbBPMA7
wzzRO8E8wTvgPCA7yAY7ygY7ygY7ygY7-ck8IDvIP8AGP8A7xj-ABj-AO8Y-wAY-wDvGP8AGP8A7
-cY8IDvg-jdMUDsGO8A8xv4eNzw8wQY8xDvP-jdMUDvBPMb_Hjc8PAY8xjvWLjvALjsuOy47Ljsu
O8X_N0xQO8A8zP4eNzw8BjzAO8M80TvAPMM73zwgO8Y-wAY-wDvGP8AGP8A7xj-ABj-AO8Y-wAY-
wDv9xzwgO8oGO8oGO8oGO8oGO-3IPCA74f43TFA7wTzF-h43PMA8BsE8xDvBPDvK-jdMUME7wDzG
-h43PDwGPMY7wTw70i47wC47LjsuOy47LsA7w-43TFDBOzzM-h43PDwGPMA7wDw7wDzRO8A8wzvf
PCA7yAY7ygY7ygY7ygY7-ck8IDvKBjvKBjvKBjvKBjv9yDwgO_D_N0xQOwY7wDzG-h43PDwGPMY7
z-43TFA7wTzG-h43PDwGPMY71i47wC47LjsuOy47LjvF-jdMUDvAPMz_Hjc8PAY8wDvDPNE7wDzD
O988IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oGO8oGO8oGO-3IPCA75TzEBsE8BsE8xDvTPMYGwTzG
O9YuO8EuwDsuOy47LsE7xjzMBsE8wDvDPNE7wTzBO_A8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oG
O8oGO8oGO-3IPCA75TzRO9M80TvsPNE7wzzRO_Y8IDvIBjvKBjvKBjvKBjv9yTwgO8g-wAY-wDvG
P8AGP8A7xj-ABj-AO8Y-wAY-wDv9xjwgO-39-ec8IDvGP8AGP8A7xj-ABj-AO8Y-wAY-wDvGP8AG
P8A7-cc8IDvKBjvKBjvKBjvKBjv9yDwgO-39-ec8IDvIBjvKBjvKBjvKBjv9yTwgO8oGO8oGO8oG
O8oGO-3IPCA7-f395zwgO8gGO8oGO8oGO8oGO-3JPCA7yAbDO8YGwzvGBsM7xgbDO-3GPCA75TzR
O8D_dU6Xw-7Cw8fMPNE77DzRO8M80TvmPCA7xgbDO8YGwzvGBsM7xgbDO-3HPCA7xwbFO8QGxTvE
BsU7xAbFO-3FPCA75TzG-nVOl8E8xv7Cw8f_dU6XwD-BO8D_wsPHyzzRO8E8wTvPLsE7LsE7LsA7
wC7AO8c8zAbBPMA7wzzRO8E8wTvgPCA7xQbFO8QGxTvEBsU7xAbFO-3GPCA7xD-BBhTDBjw-wwYU
wwY8P8MGFMMGPD-DBhTDBjw-wDv9wjwgO_U8xv51Tpc8OzzG-sLDx-51TpfAPzs-O8D_wsPHyzzR
O8A8wzvOLjsuOy47wS47LjsuOy47w-43TFA7wDzM-h43PDwGPMA7wzzRO8A8wzvfPCA7wj-BBhTD
Bjw-wwYUwwY8P8MGFMMGPD-DBhTDBjw-wDv9wzwgO8cGxTw7wwbFPDvDBsU8O8MGxTw7-cQ8IDvl
PMb_dU6XPDs8xv7Cw8f_dU6XwD87PzvA-sLDx8s80TvAPMM7zi7AO8AuwDvALjsuOy47LjvC-jdM
UME7PMz_Hjc8PAY8wDvAPDvAPNE7wDzDO988IDvFBsU8O8MGxTw7wwbFPDvDBsU8O-3FPCA7yAbD
PMA7xAbDPMA7xAbDPMA7xAbDPMA7-cQ8IDvlPMb_dU6XPDs8xv7Cw8f_dU6XwD87PzvA-sLDx8s8
0TvAPMM7zi47LjsuO8EuOy47LjsuO8P_N0xQO8A8zP4eNzw8BjzAO8M80TvAPMM73zwgO8YGwzzA
O8QGwzzAO8QGwzzAO8QGwzzAO-3FPCA7yTzDO8Y8wzvGPMM7xjzDO-3FPCA75TzG-nVOl8E8xv7C
w8f_dU6XwD-BO8D_wsPHyzzRO8E8wTvPLsE7LsE7LjsuOy7BO8Y8zAbBPMA7wzzRO8E8wTvgPCA7
xzzDO8Y8wzvGPMM7xjzDO-3GPCA7-fw8IDvlPNE7wP51TpfD-sLDx8w80TvsPNE7wzzRO_Y8IDv9
_zwgO8k8wTvIPME7yDzBO8g8wTv9xzwgO-39-ec8IDvHPME7yDzBO8g8wTvIPME7-cg8IDvJPDs8
O8g8Ozw7yDw7PDvIPDs8O-3HPCA7-f395zwgO8c8Ozw7yDw7PDvIPDs8O8g8Ozw7-cg8IDvJPDs8
O8g8Ozw7yDw7PDvIPDs8O-3HPCA7-f395zwgO8c8Ozw7yDw7PDvIPDs8O8g8Ozw7_iDBOyDBOyA7
IDs8IDvJPDs8O8g8Ozw7yDw7PDvIPDs8O-3HPCA7-f395zwgO8c8Ozw7yDw7PDvIPDs8O8g8Ozw7
-CA7IDsgO8EgOzwgO8k8wTvIPME7yDzBO8g8wTv9xzwgO-39-ec8IDvHPME7yDzBO8g8wTvIPME7
_yDAOyDBO8AgO8A8IDv9-DwgO-39-ec8IDv98SA7wSA7IDvBPCA7-fw8IDv9-f3nPCA7-e8gwTvB
IDsgOyA7PCA7-fw8IDv9-f3nPCA7-fs8-f3BIDz9-f3oIDz9-AAAAAAAAAAB
:: map/.info.pod
--[[pod,created="2024-03-24 00:48:06",modified="2026-01-27 08:28:35",stored="2024-03-24 00:48:06"]]
:: map/0.map
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI0LTAzLTI0IDAwOjQ4OjA2Iixtb2RpZmllZD0iMjAyNS0w
My0xNyAxNzozODozMSIscmV2aXNpb249OTM2OF1dbHo0AGcAAABWEAAA8Ah7e2JtcD11c2VyZGF0
YSgiaTE2IiwzMgMALyIwAQD--------------------78QgiKSxoaWRkZW49ZmFsc2UscGFuX3g9
MAgAwnk9MCx0aWxlX2g9OAkAwHc9OCx6b29tPTF9fQ==
:: pal/.info.pod
--[[pod,created="2024-04-10 04:52:51",modified="2026-01-27 08:28:35",stored="2024-04-10 04:52:51"]]
:: pal/0.pal
b64$LS1bW3BvZCxiZ19jb2xvcj0wLGJsYWNrZXN0X2NvbG9yPTAsY3JlYXRlZD0iMjAyNC0wNC0x
MCAwNDo1Mjo1MSIsaGlkZGVuPXtbMF09ZmFsc2UsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRy
dWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVl
LHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0
cnVlLHRydWUsdHJ1ZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxm
YWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxz
ZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSxmYWxzZSx0cnVlLHRy
dWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlfSxoaWRkZW5fdG9nZ2xlcz17WzBdPXRydWUsdHJ1
ZSxmYWxzZSxmYWxzZX0saHVlX29mZnNldD0wLGljb249dXNlcmRhdGEoInU4IiwxNiwxNiwiMDAw
MTAxMDEwMTAxMDEwMTAxMDEwMTAwMDAwMDAwMDAwMDAxMDcwNzA3MDcwNzA3MDcwNzA2MDEwMDAw
MDAwMDAwMDEwNzA3MDcwNzA3MDcwNzA3MDYwNjAxMDAwMDAwMDAwMTA3MDcwNzA3MDcwNzA3MDcw
NjA2MDYwMTAwMDAwMDAxMDcwNzA3MDcwNzA3MDcwNzA2MDYwNjA2MDEwMDAwMDEwNzA3MDcwNzA3
MDcwNzA3MDcwNzA3MDcwMTAwMDAwMTA3MDcwNzA3MDcwNzA3MDcwNzA3MDcwNzAxMDAwMDAxMDcw
NzA2MDYwMTAxMGQwZDAxMDEwNzA3MDEwMDAwMDEwNzA3MDYwNjAxMDEwZDBkMDEwMTA3MDcwMTAw
MDAwMTA3MDcwMTAxMDcwNzA2MDYwZDBkMDcwNzAxMDAwMDAxMDcwNzAxMDEwNzA3MDYwNjBkMGQw
NzA3MDEwMDAwMDEwNzA3MGQwZDAxMDEwZDBkMDYwNjA3MDcwMTAwMDAwMTA3MDcwZDBkMDEwMTBk
MGQwNjA2MDcwNzAxMDAwMDAxMDcwNzA3MDcwNzA3MDcwNzA3MDcwNzA3MDEwMDAwMDEwNzA3MDcw
NzA3MDcwNzA3MDcwNzA3MDcwMTAwMDAwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMDEwMTAxMDAiKSxs
b2NrZWQ9e1swXT10cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0
cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1
ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlLHRydWUs
ZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFs
c2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2Us
ZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFsc2UsZmFs
c2UsZmFsc2UsZmFsc2UsZmFsc2V9LG1vZGlmaWVkPSIyMDI2LTAxLTI3IDA4OjI2OjQ2Iixva3Bh
bF92ZXJzaW9uPSIwLjAuNCIscGlja2Vyc19tb2RlPSJsaW5lYXJfaHVlIixyZXZpc2lvbj0xNDc4
LHRlc3RfY3ViZV9jb2xvcnM9e1swXT17MTUsMzEsNH0sezMxLDQsMjB9LHs0LDIwLDIxfSx7MTAs
OSwyNX0sezksMjUsMjR9LHs4LDI0LDJ9LHsyNiwxMSwyN30sezExLDI3LDN9LHsyNywzLDE5fSx7
MjgsMTcsMTl9LHsyOCwxMiwxNn0sezEyLDE2LDF9LHs2LDI5LDEzfSx7MjksMTMsMTh9LHsxMywx
OCwxfSx7NywyMywxNH0sezIzLDE0LDEzfSx7MTQsMzAsMTh9LHs3LDYsMjJ9LHs2LDIyLDV9LHsy
Miw1LDIxfSx7MSwxLDF9LHsxLDEsMX0sezEsMSwxfX0sdGVzdF9tb2RlPSJjdWJlcyIsdGVzdF9y
YW1wX2NvbG9ycz11c2VyZGF0YSgidTgiLDEwLDI3LCIwMDE4MDgxOTA5MGExYTBiMWIwMDA2MDAw
MDAwMDAwMDAwMDAwMzAwMTYwMDAwMDAwMDAwMDAwMDEzMDAwNTAwMDAwMDAwMDAwMDAwMDEwMDBk
MDAwMDAwMDAwMDAwMDAxMDAwMWQwMDAwMDAwMDAwMDAwMDExMDAxNzAwMDAwMDAwMDAwMDAwMGMw
MDBlMDAwMDAwMDAwMDAwMDAxYzAwMWUxMjAyMTUxNDA0MWYwZjA3MDAwMDAwMDAwMDAwMDAwMDAw
MDAwMDAwMTQwNDFmMGYwODE4MDIwMDAwMTUwNTE2MDYwNzE3MGUxZTAwMDAwMTEwMTEwYzFjMWQw
ZDEyMDAwMDEzMDMxYjBiMWEwYTA5MTkwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
MDAiKSx3aGl0ZXN0X2NvbG9yPTddXWx6NAC8AQAAFQIAAPUFdXNlcmRhdGEoImkzMiIsNjQsIjAB
AMAxZDJiNTMwMDdlMjUIAPAXMDA4NzUxMDBhYjUyMzYwMDVmNTc0ZjAwYzJjM2M3MDBmZmYxZTgI
AEAwMDRkCAARYTYAYGZmZWMyNwoAIGU0OABAMjlhZCQAYDgzNzY5YyAAMTc3YTgAwGNjYWEwMDFj
NWVhYzAA8B1hNWExMDA3NTRlOTcwMDEyNTM1OTAwNzQyZjI5MDA0OTJkMzgwMGEyODg3OUAA8ANh
Y2M1MDBjMzAwNGMwMGViNmJGAGA5MGVjNDIKACBiMsAAoDY0ZGZmNjAwYmSJAACWAEAwZGFiQACw
ODU2ZDAwMDMwYTCAAPERNzEzMTYwMDE5MzAzNDAwMWY0NDUwMDA0YTNlN2EwMGP_AJUwMDkzMjA1
ZjABAPAGYjU2YjgzMDBmMWExYmEwMGFmYWM4CAFANGVmYjgBUGM5NTYyOACwZTg5YTAwNTE5Mzle
Af8HZWRjZDkwMDk0NzNiNDAwY2FhOWVhMAEAJtBkNmQ3ZGEwMDlmYTBhyACgZTM3M2MwMDM3NCcB
ITAzAQAxMDAyAQCgMDAxNjE2MTYiKQ==
:: sfx/.info.pod
--[[pod,created="2024-03-24 00:48:06",modified="2026-01-27 08:28:35",stored="2024-03-24 00:48:06"]]
:: sfx/0.sfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI1LTAzLTE3IDExOjI5OjU2Iixtb2RpZmllZD0iMjAyNi0w
MS0yNyAwNzowMTozOCIscmV2aXNpb249MTM5XV1sejQAVwEAAEsYAAD-MHB4dQADKAAABAAED0AQ
Ag4AAaABIAKgDgAPEAAN8MoBAgNADw_QBAUGB0AMkAgJCgtADJAPDA8NDw4MQAzw-wEA6-A9qgEQ
Bg8gEAEgASAB8AACEAIOEAEgDyEgATAPgZAPEQIgDlACDyEQAfCoDygP--DGD-gKD-8PgA-3Dw0B
cA9mD2kPcg9zD3QOD2kPbgkA-wIPcg91D20PZQ9uD3QAARAGDlsAAj9A8MNPAAGvbw90D2gPZQ9y
sDoAHaZhD24PZA4PYR9uRQAfQEUAGy-wCTAA------8xH-8BAKzXyA9AAA8QQA8rL-8PKAQAABAA
FyYEAGsr--8PAC0CAEv9Dw4tAgCz-Q-wNw8M8A4D8AlaAMQo-S8A-S8PYP0v8HBtAFAtDyj9K0EA
ECszAGIr8DcD8CgcAE-9sPBwCgD-------------------9mUP2w8P85
:: sfx/0.sfxi
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI2LTAxLTI1IDA4OjMwOjE3Iixtb2RpZmllZD0iMjAyNi0w
MS0yNyAwODoyODozNSIscmV2aXNpb249NjBdXWx6NAAmAgAAORkAAP8zcHh1AAMoAAAEAAQPQBAC
DgABoAEgAqAOAA8QAA3wygECAwABIA8-kAQFBgdADw_QCAkKC0AMkA8MDw0PDgxADPD-AQDr9BOq
ARAGDzkQASABIAHwAAIQAg8gEAEP3BAPISABD8sgD8igFAASUBQA8CEjIA_o8KMPKA--8MQCAA-4
Cg--D4AP9w8NAXAPcw9vD2YPdA8gD3APdQ9sD3MPZWBgABcgYABADhABIEkAVzAPQJABEAAi4BIM
AGYNIAHgAwIMABcEDAAXBQwAFgYMACHwCI8AGsaNAPsQdw9pD2QPZQ9zD3QOD3IPbw91D3QPaQ9u
D2cgARAGDpMAEQ2SABegVQAfAAwAKA_RAAJfdA9hH2yRAAIfEJEABsCQDQIgDlABIAHgDxIKAP8C
AiAB4AII8A8J8A8K4A9A8CdpAAGCYR9sDg9uD2--AB9wXQAGLvDDPgAv8AkvAP-----lH-8BAKzx
UsgPQAAPEEAPJA8lDygPJw8pDysPKg8rDywPLQ8uDy8--w8wDzEPMg8zDzQPNQ82DzcPOA85DzoP
O---FLA3sPcUD4AOD0CON773FA8tDysPPA8_D2YPYQ9iD2MPZA9mD21PBjBwD3K9BvMCD3YPd-Af
DxIPMA9ABw-t8Cl9AIAoBwsnCwcPJAUAcyn3IQAHACcEAGP3IQ4HDicEAEL3IfBwMgAv97AKAP--
-----------------3JQ97Dw-zk=
:: src/.info.pod
--[[pod,created="2024-04-07 08:14:00",modified="2026-01-27 08:28:35",stored="2024-04-07 08:14:00"]]
:: src/wavetables/.info.pod
--[[pod,created="2026-01-25 09:38:05",modified="2026-01-27 08:28:35"]]
:: [eoc]
